<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Columbia Pictures Aquaverse - 2025 Content Calendar</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    :root {
      --primary: #1a2a6c; --secondary: #b21f1f; --accent: #fdbb2d;
      --light: #f5f7fa; --dark: #333; --gray: #6c757d;
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background:var(--light); color:var(--dark); line-height:1.6; padding:20px; user-select:none; }
    .container { max-width:1400px; margin:0 auto; }

    header {
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      margin-bottom:30px; padding:20px;
      background:linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
      color:white; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    .brand { display:flex; flex-direction:column; }
    h1 { font-size:2rem; margin-bottom:6px; }
    .subtitle { font-size:1rem; opacity:.9; }

    .header-actions { display:flex; gap:10px; }
    .link-btn {
      display:inline-flex; align-items:center; gap:8px; text-decoration:none;
      background:rgba(255,255,255,.15); color:white; padding:10px 14px; border-radius:8px; font-weight:700; transition:.2s ease;
    }
    .link-btn:hover { background:rgba(255,255,255,.25); transform:translateY(-1px); }

    .controls {
      display:flex; justify-content:space-between; align-items:center;
      margin:20px 0; padding:15px; background:white; border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1); flex-wrap:wrap; gap:15px;
    }
    .month-navigation { display:flex; align-items:center; gap:15px; }
    .nav-btn {
      background:var(--primary); color:white; border:none; padding:10px 15px; border-radius:50px;
      cursor:pointer; display:flex; align-items:center; gap:8px; font-weight:600; transition:all .3s ease;
      box-shadow:0 2px 5px rgba(0,0,0,0.2);
    }
    .nav-btn:hover { background:#2a3a8c; transform:translateY(-2px); }
    .month-year { font-size:1.5rem; font-weight:700; color:var(--primary); min-width:180px; text-align:center; }

    .view-controls { display:flex; gap:10px; align-items:center; }
    .view-btn {
      padding:8px 15px; border:2px solid var(--primary); background:white; color:var(--primary);
      border-radius:5px; cursor:pointer; font-weight:600; transition:all .3s ease;
    }
    .view-btn.active { background:var(--primary); color:white; }

    .market-selector { display:flex; gap:5px; flex-wrap:wrap; }
    .market-btn {
      padding:5px 10px; border:1px solid var(--primary); background:white; color:var(--primary);
      border-radius:20px; cursor:pointer; font-size:.8rem; transition:all .3s ease;
    }
    .market-btn.active { background:var(--primary); color:white; }

    .edit-controls { display:flex; gap:10px; }
    .edit-btn {
      padding:8px 15px; border:2px solid var(--accent); background:white; color:var(--accent);
      border-radius:5px; cursor:pointer; font-weight:600; transition:all .2s ease;
    }
    .edit-btn.active { background:var(--accent); color:white; }

    .dashboard { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:30px; }
    .folder-status, .content-summary { background:white; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    .folder-status h2, .content-summary h2 { color:var(--primary); margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #f0f0f0; }
    .folder-item { display:flex; justify-content:space-between; margin-bottom:10px; padding:8px 0; }
    .folder-name { font-weight:600; }
    .folder-count { background:#e9ecef; padding:2px 10px; border-radius:20px; font-weight:600; }

    .content-stats { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
    .stat-item { text-align:center; padding:15px; border-radius:8px; background:#f8f9fa; }
    .stat-number { font-size:1.8rem; font-weight:700; color:var(--primary); }
    .stat-label { font-size:.9rem; color:var(--gray); }

    .calendar-container {
      background:white; border-radius:10px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:30px;
      overflow-x:auto;
    }
    .calendar-inner { min-width: 900px; }

    .calendar-header {
      display:grid; grid-template-columns:repeat(7, 1fr);
      background:var(--primary); color:white; text-align:center; font-weight:600;
    }
    .calendar-header div { padding:15px 5px; }
    .calendar-week { display:grid; grid-template-columns:repeat(7, 1fr); border-bottom:1px solid #e9ecef; }

    .calendar-day {
      min-height:140px; padding:10px; border-right:1px solid #e9ecef; position:relative;
      transition:all .2s ease; cursor:pointer; word-break:break-word;
    }
    .calendar-day:hover { background:#f8f9fa; }
    .calendar-day.editable:hover { background:#fff9e6; }
    .calendar-day:last-child { border-right:none; }

    .date-number { font-weight:700; margin-bottom:5px; color:#495057; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .edit-indicator { color:var(--accent); font-size:.8rem; }

    .content-type { font-size:.85rem; padding:4px 8px; border-radius:4px; margin-bottom:5px; color:white; font-weight:600; display:inline-block; }
    .shortform { background:#28a745; }
    .ai-shortform { background:#007bff; }
    .ai-carousel { background:#17a2b8; }
    .real-carousel { background:#fd7e14; }
    .longform { background:#6f42c1; }
    .no-post { background:#6c757d; }

    .market-tags { display:flex; flex-wrap:wrap; gap:4px; margin-top:5px; }
    .market-tag { font-size:.65rem; padding:2px 6px; border-radius:3px; background:#e9ecef; }
    .content-theme { font-size:.8rem; color:#495057; margin-top:6px; font-style:italic; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; }

    .activity-block {
      background: #fdfdfd;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 8px;
      margin-top: 8px;
      cursor: pointer;
      transition: all .2s ease;
    }
    .editable .activity-block:hover {
      background: #fff;
      border-color: var(--primary);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* ===== Post preview media (fake placeholders) ===== */
    .preview-block { margin-bottom: 24px; }
    .media-preview { margin-top: 10px; margin-bottom: 14px; }
    .media-frame {
      width: 100%;
      border-radius: 10px;
      overflow: hidden;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .media-frame.media-vertical { aspect-ratio: 9 / 16; }
    .media-frame.media-square  { aspect-ratio: 1 / 1; }
    .media-frame.media-landscape { aspect-ratio: 16 / 9; }
    .media-frame img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .media-label {
      margin-top: 8px;
      font-size: 0.85rem;
      color: var(--gray);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .media-label i { font-size: 0.9rem; }

    .preview-meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      font-size: 0.85rem;
    }
    .preview-meta-pill {
      background: #f1f3f5;
      border-radius: 999px;
      padding: 4px 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .preview-meta-pill i { font-size: 0.9rem; }

    .preview-title-activity {
      color: var(--primary);
      margin-bottom: 6px;
      font-size: 1.05rem;
      font-weight: 700;
    }
    .preview-theme {
      font-size: 0.95rem;
      color: var(--dark);
      font-style: italic;
      white-space: pre-wrap;
      margin-top: 4px;
    }

    .mobile-list .edit-indicator { float: right; }
    .editable .calendar-day:hover .edit-indicator { opacity: 1; }

    .platform-selector { display: flex; gap: 20px; margin-top: 10px; }
    .platform-selector input[type="checkbox"] { margin-right: 5px; }
    .platform-selector label { font-weight: normal; display: flex; align-items: center; gap: 6px; cursor: pointer; }
    .platform-selector .fa-brands { font-size: 1.2rem; }
    .fa-facebook { color: #1877F2; }
    .fa-instagram { color: #E4405F; }

    .legend { display:flex; justify-content:center; flex-wrap:wrap; gap:15px; margin-top:20px; }
    .legend-item { display:flex; align-items:center; gap:5px; }
    .legend-color { width:20px; height:20px; border-radius:4px; }

    .empty-day { background:#f8f9fa; padding:6px; border-radius:6px; display:inline-block; }

    .other-month { background:#f0f2f5; color:#adb5bd; }
    .swipe-info { text-align:center; margin-top:15px; color:var(--gray); font-size:.9rem; }

    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; padding:16px; }
    .modal-content { background:white; padding:22px; border-radius:10px; width:92%; max-width:640px; box-shadow:0 5px 15px rgba(0,0,0,0.3); max-height:90vh; overflow-y:auto; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; padding-bottom:10px; border-bottom:1px solid #e9ecef; }
    .modal-title { font-size:1.3rem; color:var(--primary); }
    .close-modal { background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--gray); }

    .form-group { margin-bottom:12px; }
    .form-group label { display:block; margin-bottom:6px; font-weight:600; color:var(--dark); }
    .form-control { width:100%; padding:10px; border:1px solid #ced4da; border-radius:6px; font-size:1rem; }
    textarea.form-control { min-height:100px; resize:vertical; }
    .form-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:16px; }
    .btn { padding:10px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition:all .2s ease; }
    .btn-primary { background:var(--primary); color:white; }
    .btn-secondary { background:var(--gray); color:white; }
    .btn-danger { background:var(--secondary); color:white; }

    .market-checkboxes { display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-top:10px; }
    .market-checkbox { display:flex; align-items:center; gap:5px; }

    .save-notification {
      position:fixed; bottom:20px; right:20px; background:var(--primary); color:white;
      padding:10px 20px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2);
      display:none; z-index:1001;
    }

    /* ====== Tablet tweaks ====== */
    @media (max-width:768px) {
      header { flex-direction:column; align-items:flex-start; }
      .dashboard { grid-template-columns:1fr; }
      .calendar-inner { min-width: 720px; }
      .calendar-header div { padding:10px 4px; font-size:.85rem; }
      .calendar-day { min-height:110px; padding:6px; }
      .content-type { font-size:.75rem; padding:3px 6px; }
      .content-theme { -webkit-line-clamp: 3; font-size:.75rem; }
      .month-year { font-size:1.25rem; }
      .controls { flex-direction:column; align-items:flex-start; }
      .market-checkboxes { grid-template-columns:repeat(2, 1fr); }
      .modal-content { width: 100%; padding:18px; }
    }

    .calendar-fade { animation:fadeIn .5s ease-in-out; }
    @keyframes fadeIn { from { opacity:.5; } to { opacity:1; } }

    .global-view .market-tags { display:none; }
    .individual-view .market-tags { display:flex; }

    /* ====== MOBILE: real single-column list ====== */
    @media (max-width:600px){
      .calendar-header { display: none !important; }
      .calendar-inner { min-width: 0; }
      .calendar-week { display: none !important; }

      #calendar .mobile-list { display:flex; flex-direction:column; }

      #calendar .mobile-list .calendar-day {
        display:block;
        min-height:unset;
        padding:12px;
        margin:10px 12px;
        border:1px solid #e9ecef;
        border-radius:10px;
        box-shadow:0 1px 3px rgba(0,0,0,0.04);
      }

      .calendar-day.other-month{ display:none !important; }

      .month-navigation {
        gap: 4px;
        width: 100%;
        justify-content: space-between;
      }

      .month-year {
        min-width: unset;
        font-size: 0.9rem;
        flex: 1;
        text-align: center;
      }

      .nav-btn {
        flex-shrink: 0;
        padding: 6px 8px;
        font-size: 0.8rem;
        border-radius: 5px;
      }

      .controls {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <h1>Columbia Pictures Aquaverse</h1>
      <p class="subtitle">2025 Global Content Calendar</p>
    </div>
    <div class="header-actions">
      <a class="link-btn" id="beachclub-link" href="#quuba" title="Open the Beach Club page">
        <i class="fa-solid fa-umbrella-beach"></i> Beach Club Page
      </a>
    </div>
  </header>
<!-- ADD THIS RIGHT AFTER YOUR HEADER, BEFORE CONTROLS -->
<div class="main-navigation" style="margin-bottom:20px;">
  <button class="nav-tab active" onclick="switchView('calendar')">
    <i class="fas fa-calendar-alt"></i> Calendar
  </button>
  <button class="nav-tab" onclick="switchView('analytics')">
    <i class="fas fa-chart-line"></i> Analytics
  </button>
</div>

<!-- WRAP YOUR EXISTING CALENDAR CONTENT -->
<div id="calendar-view" style="display:block;">
 <div class="controls">
    <div class="month-navigation">
      <button class="nav-btn" id="prev-month"><i class="fas fa-chevron-left"></i> Previous</button>
      <div class="month-year" id="current-month">November 2025</div>
      <button class="nav-btn" id="next-month">Next <i class="fas fa-chevron-right"></i></button>
    </div>

    <div class="view-controls">
      <button class="view-btn active" id="global-view">Global View</button>
      <button class="view-btn" id="individual-view">Individual View</button>
      <div class="market-selector" id="market-selector" style="display:none;"></div>
    </div>

    <div class="edit-controls">
      <button class="edit-btn" id="edit-mode">Edit Mode</button>
      <button class="edit-btn" id="logout-btn" style="display:none;">Sign out</button>
    </div>
  </div>

  <div class="dashboard">
    <div class="folder-status">
      <h2 style="padding-top: 5px;">Video Inventory</h2>

      <!-- A) Existing AI shortform inventory (from Supabase Storage) -->
      <div class="folder-item">
        <span class="folder-name">Available AI Shortform Videos</span>
        <span class="folder-count" id="available-video-count" style="background:var(--primary); color:white;">...</span>
      </div>

      <!-- B) NEW: Scheduled regular shortform totals -->
      <div class="folder-item">
        <span class="folder-name">Scheduled Shortform (all markets)</span>
        <span class="folder-count" id="scheduled-shortform-total">0 posts</span>
      </div>

      <!-- C) NEW: Per-country scheduled shortform counts -->
      <div class="folder-item">
        <span class="folder-name">US Shortform</span>
        <span class="folder-count" id="shortform-us-count">0</span>
      </div>
      <div class="folder-item">
        <span class="folder-name">Korea Shortform</span>
        <span class="folder-count" id="shortform-korea-count">0</span>
      </div>
      <div class="folder-item">
        <span class="folder-name">India Shortform</span>
        <span class="folder-count" id="shortform-india-count">0</span>
      </div>
      <div class="folder-item">
        <span class="folder-name">France Shortform</span>
        <span class="folder-count" id="shortform-france-count">0</span>
      </div>
      <div class="folder-item">
        <span class="folder-name">Japan Shortform</span>
        <span class="folder-count" id="shortform-japan-count">0</span>
      </div>
      <div class="folder-item">
        <span class="folder-name">UK Shortform</span>
        <span class="folder-count" id="shortform-uk-count">0</span>
      </div>
      <div class="folder-item">
        <span class="folder-name">Germany Shortform</span>
        <span class="folder-count" id="shortform-germany-count">0</span>
      </div>
      <div class="folder-item">
        <span class="folder-name">Thailand Shortform</span>
        <span class="folder-count" id="shortform-thailand-count">0</span>
      </div>

      <h2>Canto Folder Status</h2>
      <div class="folder-item">
        <span class="folder-name">Carousels_Ready</span>
        <span class="folder-count" id="ready-count">112 items</span>
      </div>
      <div class="folder-item">
        <span class="folder-name">Carousels_Posted</span>
        <span class="folder-count" id="posted-count">0 items</span>
      </div>
      <p style="margin-top:15px; font-size:.9rem; color:var(--gray);">
        All markets follow the same posting schedule with localized content.
      </p>
    </div>

    <div class="content-summary">
      <h2>Monthly Content Summary</h2>
      <div class="content-stats">
        <div class="stat-item"><div class="stat-number" id="total-posts">0</div><div class="stat-label">Total Posts</div></div>
        <div class="stat-item"><div class="stat-number" id="shortform-count">0</div><div class="stat-label">Shortform</div></div>
        <div class="stat-item"><div class="stat-number" id="ai-shortform-count">0</div><div class="stat-label">AI Shortform</div></div>
        <div class="stat-item"><div class="stat-number" id="ai-count">0</div><div class="stat-label">AI Carousels</div></div>
        <div class="stat-item"><div class="stat-number" id="real-count">0</div><div class="stat-label">Real Carousels</div></div>
        <div class="stat-item"><div class="stat-number" id="longform-count">0</div><div class="stat-label">Longform</div></div>
      </div>
    </div>
  </div>

  <div class="calendar-container" id="calendar-container">
    <div class="calendar-inner" id="calendar"></div>
  </div>

  <div class="swipe-info">
    <i class="fas fa-arrows-left-right"></i> Swipe left/right or use buttons to navigate months
  </div>

  <div class="legend">
    <div class="legend-item"><div class="legend-color shortform"></div><span>Shortform</span></div>
    <div class="legend-item"><div class="legend-color ai-shortform"></div><span>AI Shortform</span></div>
    <div class="legend-item"><div class="legend-color ai-carousel"></div><span>AI Carousel</span></div>
    <div class="legend-item"><div class="legend-color real-carousel"></div><span>Real Carousel</span></div>
    <div class="legend-item"><div class="legend-color longform"></div><span>Longform (1Ã—/month)</span></div>
    <div class="legend-item"><div class="legend-color no-post"></div><span>No Post (Analytics Day)</span></div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal" id="edit-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modal-title">Edit Content</h2>
      <button class="close-modal" id="close-modal">&times;</button>
    </div>
    <form id="content-form">
      <input type="hidden" id="edit-date"/>
      <input type="hidden" id="edit-market"/>
      <input type="hidden" id="edit-activity-id" />

      <div class="form-group">
        <label for="content-type">Content Type</label>
        <select class="form-control" id="content-type" required>
          <option value="">Select Content Type</option>
          <option value="shortform">Shortform</option>
          <option value="ai-shortform">AI Shortform</option>
          <option value="ai-carousel">AI Carousel</option>
          <option value="real-carousel">Real Carousel</option>
          <option value="longform">Longform</option>
          <option value="no-post">No Post</option>
        </select>
      </div>

      <div class="form-group">
        <label for="content-theme">Content Theme/Concept</label>
        <input type="text" class="form-control" id="content-theme" placeholder="Enter theme or concept"/>
      </div>

      <div class="form-group" id="manual-video-section" style="display:none; margin-top:15px; background:#f8f9fa; padding:15px; border-radius:8px; border:1px dashed #ccc;">
        <label style="color:var(--primary);"><i class="fas fa-video"></i> Selected Video</label>
        
        <div id="preview-container" style="margin-bottom:10px; display:none;">
          <video id="video-player-preview" controls style="width:100%; max-height:300px; background:black; border-radius:6px;"></video>
        </div>

        <div style="display:flex; gap:10px;">
          <input type="text" class="form-control" id="selected-filename" readonly placeholder="No video selected" style="background:white;">
          <button type="button" class="btn btn-primary" id="open-picker-btn">
            Choose
          </button>
          <button type="button" class="btn btn-danger" id="clear-video-btn" title="Clear selection">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>

      <div class="ai-prompt-section" id="ai-prompt-section" style="display:none;">
        <div class="form-group">
          <label for="ai-prompt">AI Generation Prompt</label>
          <textarea class="form-control" id="ai-prompt" placeholder="Describe what you want the AI to generate..."></textarea>
        </div>
      </div>

      <div class="form-group">
        <label>Platform</label>
        <div class="platform-selector">
          <input type="checkbox" id="platform-fb" value="facebook">
          <label for="platform-fb"><i class="fa-brands fa-facebook"></i> Facebook</label>
          <input type="checkbox" id="platform-ig" value="instagram">
          <label for="platform-ig"><i class="fa-brands fa-instagram"></i> Instagram</label>
        </div>
      </div>

      <div class="form-group">
        <label>Markets</label>
        <div class="market-checkboxes" id="market-checkboxes"></div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" id="cancel-edit">Cancel</button>
        <button type="button" class="btn btn-danger" id="delete-content">Delete</button>
        <button type="submit" class="btn btn-primary">Save Content</button>
      </div>
    </form>
  </div>
</div>

<!-- View Modal (post preview) -->
<div class="modal" id="view-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="view-title">Content Details</h2>
      <button class="close-modal" id="close-view">&times;</button>
    </div>
    <div id="view-body"></div>
    <div class="form-actions" style="justify-content: flex-end;">
      <button type="button" class="btn btn-primary" id="view-ok">Close</button>
    </div>
  </div>
</div>

<!-- Auth Modal -->
<div class="modal" id="auth-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="auth-title">Editor Login</h2>
      <button class="close-modal" id="close-auth">&times;</button>
    </div>
    <form id="auth-form">
      <div class="form-group">
        <label for="auth-email">Email</label>
        <input type="email" id="auth-email" class="form-control" placeholder="name@aquaverse.com" autocomplete="username" required />
      </div>
      <div class="form-group">
        <label for="auth-password">Password</label>
        <input type="password" id="auth-password" class="form-control" placeholder="Enter password" autocomplete="current-password" required />
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" id="cancel-auth">Cancel</button>
        <button type="submit" class="btn btn-primary">Log in</button>
      </div>
    </form>
  </div>
</div>

<!--Video Picker Modal-->
<div class="modal" id="video-picker-modal">
  <div class="modal-content" style="max-width: 800px; height: 80vh; display:flex; flex-direction:column;">
    <div class="modal-header">
      <h2 class="modal-title">Select Video from Library</h2>
      <button class="close-modal" id="close-picker">&times;</button>
    </div>
    
    <div style="padding-bottom: 10px;">
      <input type="text" id="video-search" class="form-control" placeholder="Search filename...">
    </div>

    <div id="video-list-container" style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:6px; padding:10px;">
      <div style="text-align:center; padding:20px; color:#999;">Loading videos...</div>
    </div>

    <div class="form-actions" style="margin-top:10px;">
       <button type="button" class="btn btn-secondary" id="cancel-picker">Cancel</button>
    </div>
  </div>
</div>

<div class="save-notification" id="save-notification">Changes saved successfully!</div>
</div>

<!-- ADD ANALYTICS VIEW (HIDDEN BY DEFAULT) -->
<div id="analytics-view" style="display:none;">
  <style>
    /* Add missing CSS variables for analytics */
    #analytics-view {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --info: #4895ef;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    #analytics-view .analytics-header {
      background-color: white;
      border-radius: var(--border-radius);
      padding: 20px 25px;
      margin-bottom: 25px;
      box-shadow: var(--box-shadow);
    }

    #analytics-view .analytics-header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--light-gray);
    }

    #analytics-view .analytics-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }

    #analytics-view .analytics-logo i {
      font-size: 28px;
    }

    #analytics-view .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #analytics-view .btn {
      padding: 10px 20px;
      border-radius: var(--border-radius);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      transition: var(--transition);
    }

    #analytics-view .btn-primary {
      background-color: var(--primary);
      color: white;
    }

    #analytics-view .btn-primary:hover {
      background-color: var(--secondary);
    }

    #analytics-view .btn-secondary {
      background-color: white;
      color: var(--dark);
      border: 1px solid var(--light-gray);
    }

    #analytics-view .btn-secondary:hover {
      background-color: var(--light-gray);
    }

    #analytics-view .filters-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    #analytics-view .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    #analytics-view .filter-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray);
      text-transform: uppercase;
    }

    #analytics-view .filter-select {
      padding: 10px 12px;
      border-radius: var(--border-radius);
      border: 1px solid var(--light-gray);
      background-color: white;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
    }

    #analytics-view .filter-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    #analytics-view .filter-select:hover {
      border-color: var(--primary);
    }

    #analytics-view .active-filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--light-gray);
    }

    #analytics-view .filter-tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background-color: var(--primary);
      color: white;
      border-radius: 20px;
      font-size: 12px;
    }

    #analytics-view .filter-tag i {
      cursor: pointer;
      font-size: 10px;
    }

    #analytics-view .filter-tag i:hover {
      opacity: 0.8;
    }

    #analytics-view .summary-stats {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 20px;
      margin-bottom: 5px;
    }

    #analytics-view .stat-card {
      background-color: white;
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    #analytics-view .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background-color: var(--primary);
    }

    #analytics-view .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    #analytics-view .stat-card.impressions::before { background-color: #4361ee; }
    #analytics-view .stat-card.reach::before { background-color: #4cc9f0; }
    #analytics-view .stat-card.engagement::before { background-color: #f72585; }
    #analytics-view .stat-card.rate::before { background-color: #f8961e; }
    #analytics-view .stat-card.clicks::before { background-color: #4895ef; }
    #analytics-view .stat-card.followers::before { background-color: #7209b7; }

    #analytics-view .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    #analytics-view .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
    }

    #analytics-view .stat-card.impressions .stat-icon { background-color: #4361ee; }
    #analytics-view .stat-card.reach .stat-icon { background-color: #4cc9f0; }
    #analytics-view .stat-card.engagement .stat-icon { background-color: #f72585; }
    #analytics-view .stat-card.rate .stat-icon { background-color: #f8961e; }
    #analytics-view .stat-card.clicks .stat-icon { background-color: #4895ef; }
    #analytics-view .stat-card.followers .stat-icon { background-color: #7209b7; }

    #analytics-view .stat-title {
      font-size: 13px;
      color: var(--gray);
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 8px;
    }

    #analytics-view .stat-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--dark);
    }

    #analytics-view .stat-change {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    #analytics-view .stat-change.positive {
      color: #28a745;
    }

    #analytics-view .stat-change.negative {
      color: var(--danger);
    }

    #analytics-view .comparison-text {
      font-size: 11px;
      color: var(--gray);
      margin-top: 5px;
    }

    #analytics-view .content-section {
      background-color: white;
      border-radius: var(--border-radius);
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: var(--box-shadow);
    }

    #analytics-view .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    #analytics-view .section-title {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #analytics-view .section-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #analytics-view .platform-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    #analytics-view .platform-tab {
      padding: 10px 20px;
      background-color: white;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid var(--light-gray);
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }

    #analytics-view .platform-tab.active {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    #analytics-view .platform-tab:hover:not(.active) {
      background-color: var(--light);
      border-color: var(--primary);
    }

    #analytics-view .region-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    #analytics-view .region-card {
      border: 1px solid var(--light-gray);
      border-radius: var(--border-radius);
      padding: 20px;
      transition: var(--transition);
    }

    #analytics-view .region-card:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    #analytics-view .region-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    #analytics-view .region-name {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #analytics-view .region-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    #analytics-view .region-metric {
      display: flex;
      flex-direction: column;
    }

    #analytics-view .region-metric-label {
      font-size: 11px;
      color: var(--gray);
      text-transform: uppercase;
    }

    #analytics-view .region-metric-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--dark);
    }

    #analytics-view .pages-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    #analytics-view .pages-table th,
    #analytics-view .pages-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid var(--light-gray);
    }

    #analytics-view .pages-table th {
      background-color: var(--light);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      color: var(--gray);
    }

    #analytics-view .pages-table tr:hover {
      background-color: var(--light);
    }

    #analytics-view .page-name {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
    }

    #analytics-view .page-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      font-weight: 700;
    }

    #analytics-view .platform-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    #analytics-view .platform-badge.instagram {
      background-color: #fce4ec;
      color: #E1306C;
    }

    #analytics-view .platform-badge.facebook {
      background-color: #e3f2fd;
      color: #4267B2;
    }

    #analytics-view .platform-badge.twitter {
      background-color: #e1f5fe;
      color: #1DA1F2;
    }

    #analytics-view .platform-badge.linkedin {
      background-color: #e0f2f1;
      color: #0077B5;
    }

    #analytics-view .platform-badge.tiktok {
      background-color: #fce4ec;
      color: #000000;
    }

    #analytics-view .platform-badge.youtube {
      background-color: #ffebee;
      color: #FF0000;
    }

    #analytics-view .region-badge {
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 11px;
      background-color: var(--light-gray);
      color: var(--dark);
      font-weight: 600;
    }

    #analytics-view .performance-indicator {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-weight: 600;
    }

    #analytics-view .performance-indicator.high {
      color: #28a745;
    }

    #analytics-view .performance-indicator.medium {
      color: var(--warning);
    }

    #analytics-view .performance-indicator.low {
      color: var(--gray);
    }

    #analytics-view .posts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }

    #analytics-view .post-card {
      border: 1px solid var(--light-gray);
      border-radius: var(--border-radius);
      overflow: hidden;
      transition: var(--transition);
      background-color: white;
    }

    #analytics-view .post-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    #analytics-view .post-image {
      height: 200px;
      background-size: cover;
      background-position: center;
      position: relative;
    }

    #analytics-view .post-platform-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      backdrop-filter: blur(10px);
    }

    #analytics-view .post-platform-overlay.instagram {
      background-color: rgba(225, 48, 108, 0.9);
      color: white;
    }

    #analytics-view .post-platform-overlay.facebook {
      background-color: rgba(66, 103, 178, 0.9);
      color: white;
    }

    #analytics-view .post-region-overlay {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      background-color: rgba(255, 255, 255, 0.95);
      color: var(--dark);
    }

    #analytics-view .post-content {
      padding: 18px;
    }

    #analytics-view .post-title {
      font-weight: 600;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      font-size: 15px;
      line-height: 1.4;
    }

    #analytics-view .post-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    #analytics-view .post-date {
      font-size: 12px;
      color: var(--gray);
    }

    #analytics-view .post-page {
      font-size: 12px;
      font-weight: 600;
      color: var(--primary);
    }

    #analytics-view .post-metrics {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--light-gray);
    }

    #analytics-view .metric {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #analytics-view .metric-label {
      font-size: 10px;
      color: var(--gray);
      text-transform: uppercase;
    }

    #analytics-view .metric-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    #analytics-view .metric-value i {
      color: var(--primary);
      font-size: 12px;
    }

    #analytics-view .engagement-rate-bar {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--light-gray);
    }

    #analytics-view .engagement-rate-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 12px;
    }

    #analytics-view .engagement-rate-value {
      font-weight: 700;
      color: var(--primary);
    }

    #analytics-view .progress-bar {
      height: 6px;
      background-color: var(--light-gray);
      border-radius: 10px;
      overflow: hidden;
    }

    #analytics-view .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--success));
      border-radius: 10px;
      transition: width 0.3s ease;
    }

    #analytics-view .chart-container {
      margin-top: 20px;
      padding: 20px;
      background-color: var(--light);
      border-radius: var(--border-radius);
    }

    #analytics-view .comparison-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    #analytics-view .comparison-card {
      background-color: white;
      border: 2px solid var(--light-gray);
      border-radius: var(--border-radius);
      padding: 20px;
      transition: var(--transition);
    }

    #analytics-view .comparison-card:hover {
      border-color: var(--primary);
    }

    #analytics-view .comparison-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    #analytics-view .comparison-title {
      font-size: 16px;
      font-weight: 600;
    }

    #analytics-view .comparison-metrics {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #analytics-view .comparison-metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #analytics-view .comparison-metric-name {
      font-size: 13px;
      color: var(--gray);
    }

    #analytics-view .comparison-metric-value {
      font-size: 16px;
      font-weight: 700;
    }

    #analytics-view .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray);
    }

    #analytics-view .empty-state i {
      font-size: 48px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    #analytics-view .empty-state p {
      font-size: 16px;
    }

    /* Additional styles from second code */
    #analytics-view .posts-scroll-container {
      max-height: 800px; 
      overflow-y: auto;  
      padding-right: 10px; 
    }

    #analytics-view .posts-scroll-container::-webkit-scrollbar {
      width: 8px;
    }
    #analytics-view .posts-scroll-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    #analytics-view .posts-scroll-container::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 4px;
    }
    #analytics-view .posts-scroll-container::-webkit-scrollbar-thumb:hover {
      background: #aaa;
    }

    #analytics-view .platform-tab {
      cursor: pointer;
      user-select: none;
    }

    @media (max-width: 1200px) {
      #analytics-view .summary-stats {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      #analytics-view .header-top {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      #analytics-view .filters-section {
        grid-template-columns: 1fr;
      }

      #analytics-view .summary-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      #analytics-view .region-breakdown {
        grid-template-columns: 1fr;
      }

      #analytics-view .platform-tabs {
        justify-content: flex-start;
        overflow-x: auto;
      }

      #analytics-view .posts-grid {
        grid-template-columns: 1fr;
      }

      #analytics-view .pages-table {
        font-size: 12px;
      }

      #analytics-view .pages-table th,
      #analytics-view .pages-table td {
        padding: 10px;
      }
    }

    @media (max-width: 480px) {
      #analytics-view .summary-stats {
        grid-template-columns: 1fr;
      }

      #analytics-view .section-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

   
    #analytics-view .stat-card {
      padding: 12px 15px;
    }

    #analytics-view .stat-icon {
      width: 32px;
      height: 32px;
      font-size: 14px;
      border-radius: 6px;
    }

    #analytics-view .stat-title {
      font-size: 11px;
      margin-bottom: 2px; 
      margin-top: 5px;
    }

    #analytics-view .stat-value {
      font-size: 22px; 
      margin-bottom: 2px;
    }

    #analytics-view .stat-change,
    #analytics-view .comparison-text {
      font-size: 10px;
    }

    #analytics-view .stat-header {
        margin-bottom: 5px; 
    }

/* ==========================================================================
       7. MEDIA QUERIES (RESPONSIVE LAYERS)
       ========================================================================== */

    /* --- LAPTOPS / SMALL DESKTOPS (Max 1200px) --- */
    @media (max-width: 1200px) {
    
        #analytics-view .summary-stats {
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
    }

    /* --- TABLETS (Max 1024px - iPad Pro/Air) --- */
    @media (max-width: 1024px) {
        #analytics-view .analytics-header,
        #analytics-view .content-section,
        #analytics-view .stat-card, 
        #analytics-view .region-card, 
        #analytics-view .comparison-card, 
        #analytics-view .post-card {
            padding: 15px !important;
        }

        #analytics-view .pages-table { display: block; overflow-x: auto; width: 100%; white-space: nowrap; }
        
      
        #analytics-view .posts-grid { grid-template-columns: repeat(2, 1fr); }
        #analytics-view .comparison-grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* --- MOBILE & SMALL TABLETS (Max 768px) --- */
    @media (max-width: 768px) {
        #analytics-view .analytics-header-top { flex-direction: column; align-items: flex-start; gap: 15px; }
        #analytics-view .filters-section { grid-template-columns: 1fr; } 

     
        #analytics-view .summary-stats { grid-template-columns: repeat(2, 1fr); }
        
        #analytics-view .region-breakdown { grid-template-columns: 1fr; }
        #analytics-view .platform-tabs { justify-content: flex-start; overflow-x: auto; padding-bottom: 5px; }
        

        #analytics-view .posts-grid { grid-template-columns: 1fr; }
        #analytics-view .comparison-grid { grid-template-columns: 1fr; }

        #analytics-view .section-header { flex-direction: column; align-items: flex-start; }
        #analytics-view .post-image { height: 180px; }
    }

    /* --- SMALL MOBILE (Max 580px - iPhone/Android) --- */
    @media (max-width: 580px) {
      
        #analytics-view .stat-value { font-size: 18px; }
        #analytics-view .stat-icon { width: 28px; height: 28px; font-size: 12px; }

        #analytics-view .pages-table tbody tr td:first-child,
        #analytics-view .pages-table thead tr th:first-child {
            position: sticky;
            left: 0;
            background: #ffffff;
            z-index: 10;
            min-width: 160px !important; 
            max-width: 160px;
            border-right: 2px solid #f0f0f0; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }

        #analytics-view .page-avatar {
            width: 32px !important; height: 32px !important; font-size: 12px !important;
            flex-shrink: 0; margin-right: 8px;
        }
        #analytics-view .page-name { display: flex; align-items: center; gap: 0; }
        #analytics-view .page-name > div { overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        #analytics-view .page-name > div > div:first-child {
            font-size: 11px !important; font-weight: 700; line-height: 1.3;
            white-space: normal; margin-bottom: 2px;
        }
        #analytics-view .page-name > div > div:last-child {
            font-size: 9px !important; color: #888;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }

        #analytics-view .pages-table th, #analytics-view .pages-table td {
            padding: 10px 8px !important; font-size: 11px !important;
            vertical-align: middle; white-space: nowrap; 
        }
        #analytics-view .platform-badge { padding: 3px 6px !important; font-size: 10px; }
    }

    
    @media (max-width: 400px) {

        #analytics-view .summary-stats { grid-template-columns: 1fr; }
        #analytics-view .btn { padding: 8px 12px; font-size: 12px; }
        #analytics-view .section-title { font-size: 16px; }
    }
  </style>

  <div id="analytics-view" class="container">
    <!-- Fixed analytics header -->
    <div class="analytics-header">
      <div class="analytics-header-top">
        <div class="analytics-logo">
          <i class="fas fa-chart-line"></i>
          <span>Social Media Analytics</span>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary">
            <i class="fas fa-download"></i> Export Report
          </button>
          <button class="btn btn-primary">
            <i class="fas fa-sync-alt"></i> Refresh Data
          </button>
        </div>
      </div>

      <div class="filters-section">
        <div class="filter-group">
          <label class="filter-label">Time Range</label>
          <select id="analytics-time-range" class="filter-select">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="365">Last year</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Region</label>
          <select id="analytics-region-filter" class="filter-select">
            <option value="all">All Regions</option>
            <option value="north-america">North America</option>
            <option value="europe">Europe</option>
            <option value="asia-pacific">Asia Pacific</option>
            <option value="latin-america">Latin America</option>
            <option value="middle-east">Middle East & Africa</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Platform</label>
          <select id="analytics-platform-filter" class="filter-select">
            <option value="all">All Platforms</option>
            <option value="instagram">Instagram</option>
            <option value="facebook">Facebook</option>
            <option value="twitter">Twitter</option>
            <option value="linkedin">LinkedIn</option>
            <option value="tiktok">TikTok</option>
            <option value="youtube">YouTube</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">Page/Account</label>
          <select id="analytics-page-filter" class="filter-select">
            <option value="all">All Pages</option>
            <!-- Will be populated dynamically -->
          </select>
        </div>


        
      </div>
      <div class="active-filters" id="active-filters">
        <!-- Active filters will appear here -->
      </div>
    </div>

    <div class="summary-stats" id="summary-stats">
      <div class="stat-card impressions">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-eye"></i>
          </div>
        </div>
        <div class="stat-title">Total Impressions</div>
        <div class="stat-value" id="total-impressions">0</div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up"></i>
          <span>0%</span>
        </div>
        <div class="comparison-text">vs previous period</div>
      </div>

      <div class="stat-card reach">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-users"></i>
          </div>
        </div>
        <div class="stat-title">Total Followers</div>
        <div class="stat-value" id="total-followers">0</div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up"></i>
          <span>0%</span>
        </div>
        <div class="comparison-text">Across all platforms</div>
      </div>

      <div class="stat-card engagement">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-heart"></i>
          </div>
        </div>
        <div class="stat-title">Total Engagements</div>
        <div class="stat-value" id="total-engagement">0</div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up"></i>
          <span>0%</span>
        </div>
        <div class="comparison-text">vs previous period</div>
      </div>

      <div class="stat-card rate">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-percentage"></i>
          </div>
        </div>
        <div class="stat-title">Avg. Engagement Rate</div>
        <div class="stat-value" id="avg-engagement-rate">0%</div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up"></i>
          <span>0%</span>
        </div>
        <div class="comparison-text">Average per account</div>
      </div>

      <div class="stat-card clicks">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-mouse-pointer"></i>
          </div>
        </div>
        <div class="stat-title">Total Clicks</div>
        <div class="stat-value">0</div>
        <div class="stat-change positive">
          <i class="fas fa-arrow-up"></i>
          <span>0%</span>
        </div>
        <div class="comparison-text">vs previous period</div>
      </div>

      <div class="stat-card followers">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-user-plus"></i>
          </div>
        </div>
        <div class="stat-title">New Followers</div>
        <div class="stat-value">0</div>
        <div class="stat-change negative">
          <i class="fas fa-arrow-down"></i>
          <span>0%</span>
        </div>
        <div class="comparison-text">vs previous period</div>
      </div>
    </div>

    <div id="data-period-label" style="text-align: right; font-size: 11px; color: #8898aa; margin-top: 5px; margin-bottom: 20px; font-style: italic;">
      <i class="fas fa-spinner fa-spin"></i> Loading data period...
    </div>

    <div class="content-section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-globe-americas"></i>
          Performance by Region
        </h2>
      </div>

      <div class="region-breakdown" id="region-container">
        <!-- Will be populated dynamically -->
      </div>
    </div>

    <div class="content-section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-layer-group"></i>
          All Pages & Accounts
        </h2>
        <div class="section-controls">
          <select class="filter-select" id="account-filter">
            <option value="all">Show: All</option>
            <option value="top10">Show: Top 10</option>
            <option value="bottom10">Show: Bottom 10</option>
          </select>
        </div>
      </div>

      <table class="pages-table">
        <thead>
          <tr>
            <th>Page/Account</th>
            <th>Platform</th>
            <th>Region</th>
            <th>Followers</th>
            <th>Impressions</th>
            <th>Engagement</th>
            <th>Eng. Rate</th>
            <th>Performance</th>
          </tr>
        </thead>
        <tbody id="accounts-table-body">
          <!-- Will be populated dynamically -->
        </tbody>
      </table>
    </div>

    <div class="content-section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-fire"></i>
          Top Performing Posts
        </h2>
        <div class="section-controls">
          <button class="btn btn-secondary">
            <i class="fas fa-filter"></i> More Filters
          </button>
        </div>
      </div>

      <div class="platform-tabs">
        <div class="platform-tab active" data-platform="all">
          <i class="fas fa-globe"></i>
          <span>All Platforms</span>
        </div>
        <div class="platform-tab" data-platform="instagram">
          <i class="fab fa-instagram"></i>
          <span>Instagram</span>
        </div>
        <div class="platform-tab" data-platform="facebook">
          <i class="fab fa-facebook"></i>
          <span>Facebook</span>
        </div>
        <div class="platform-tab" data-platform="tiktok">
          <i class="fab fa-tiktok"></i>
          <span>TikTok</span>
        </div>
      </div>

      <div class="posts-scroll-container">
        <div class="posts-grid" id="posts-grid">
          <!-- Will be populated dynamically -->
        </div>
      </div>
    </div>

    <div class="content-section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-chart-bar"></i>
          Platform Comparison
        </h2>
      </div>

      <div class="comparison-grid" id="platform-comparison-grid">
        <!-- Will be populated dynamically -->
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // ==========================================
    // 1. SUPABASE CONFIGURATION
    // ==========================================
    const SUPABASE_URL = 'https://merpsvkfmjbugrgnwwlq.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_HTUvRzrVGDFbqLxrUCCMZQ_tY_oW4zJ';
    
    let supabase;
    try {
        if (window.supabase) supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch(e) { console.error('Supabase Init Error:', e); }

    let rawData = { accounts: [], posts: [], snapshots: [] };
    let currentFilteredPosts = []; 

    // ==========================================
    // 2. INITIALIZATION
    // ==========================================
    async function initDashboard() {
        if (!supabase) return alert('Supabase Client Error');
        await fetchAllData();
        populatePageFilter(); 
        updateDashboard(); 
        
        // Add event listeners for filters
        document.getElementById('analytics-time-range').addEventListener('change', updateDashboard);
        document.getElementById('analytics-region-filter').addEventListener('change', updateDashboard);
        document.getElementById('analytics-platform-filter').addEventListener('change', updateDashboard);
        document.getElementById('analytics-page-filter').addEventListener('change', updateDashboard);
        document.getElementById('account-filter').addEventListener('change', filterAccountTable);
        
        // Add event listeners for platform tabs
        document.querySelectorAll('#analytics-view .platform-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('#analytics-view .platform-tab').forEach(t => {
                    t.classList.remove('active');
                });
                this.classList.add('active');
                
                const platform = this.getAttribute('data-platform');
                filterPostsByTab(platform, this);
            });
        });
    }

    // ==========================================
    // 3. DATA FETCHING
    // ==========================================
    async function fetchAllData() {
        try {
            const { data: acc } = await supabase.from('social_accounts').select('*').not('external_id', 'is', null);
            rawData.accounts = acc || [];

            const { data: posts } = await supabase.from('posts').select(`*, social_accounts(region, platform, name)`).order('posted_at', { ascending: false }).limit(500);
            rawData.posts = posts || [];

            const { data: snaps } = await supabase.from('daily_snapshots').select('*').order('recorded_at', { ascending: true });
            rawData.snapshots = snaps || [];

            renderDataPeriod(rawData.snapshots);
        } catch (err) { console.error('Fetch Error:', err); }
    }

    // ==========================================
    // 4. MASTER FILTER LOGIC
    // ==========================================
    function updateDashboard() {
        const filter = {
            time: parseInt(document.getElementById('analytics-time-range').value) || 30,
            region: document.getElementById('analytics-region-filter').value,
            platform: document.getElementById('analytics-platform-filter').value,
            pageId: document.getElementById('analytics-page-filter').value,
            contentType: 'all',      
            sort: 'engagement'       
        };

        let filteredAccounts = rawData.accounts.filter(acc => {
            if (filter.region !== 'all' && acc.region !== filter.region) return false;
            if (filter.platform !== 'all' && acc.platform !== filter.platform) return false;
            if (filter.pageId !== 'all' && String(acc.id) !== String(filter.pageId)) return false;
            return true;
        });

        const allowedAccountIds = new Set(filteredAccounts.map(acc => acc.id));
        let filteredPosts = rawData.posts.filter(post => {
            if (!allowedAccountIds.has(post.account_id)) return false;
            
            const type = (post.media_type || 'IMAGE').toUpperCase();
            if (filter.contentType === 'video' && !['VIDEO', 'REELS'].includes(type)) return false;
            if (filter.contentType === 'image' && !['IMAGE', 'PHOTO', 'CAROUSEL_ALBUM'].includes(type)) return false;
            if (filter.contentType === 'carousel' && !['CAROUSEL_ALBUM'].includes(type)) return false;
            if (filter.contentType === 'story' && !['STORY'].includes(type)) return false;
            if (filter.contentType === 'reel' && !['REELS', 'VIDEO'].includes(type)) return false;
            
            return true;
        });

        // Sort posts based on selected sort option
        if (filter.sort === 'engagement') {
            filteredPosts.sort((a, b) => (b.likes + b.comments + b.shares) - (a.likes + a.comments + a.shares));
        } else if (filter.sort === 'impressions') {
            filteredPosts.sort((a, b) => (b.impressions || 0) - (a.impressions || 0));
        } else if (filter.sort === 'reach') {
            filteredPosts.sort((a, b) => (b.reach || 0) - (a.reach || 0));
        } else if (filter.sort === 'date') {
            filteredPosts.sort((a, b) => new Date(b.posted_at) - new Date(a.posted_at));
        }

        const pastDate = new Date();
        pastDate.setDate(pastDate.getDate() - filter.time);
        const pastDateStr = pastDate.toISOString().split('T')[0];
        let historyMap = {};
        rawData.snapshots.forEach(snap => {
            if (allowedAccountIds.has(snap.account_id)) {
                const snapDate = snap.recorded_at.split('T')[0];
                if (snapDate <= pastDateStr) historyMap[snap.account_id] = snap; 
            }
        });

        currentFilteredPosts = filteredPosts;

        renderSummaryCards(filteredAccounts, historyMap, filter.time);
        filterAccountTable(); 
        
        const activeTab = document.querySelector('#analytics-view .platform-tab.active');
        const activePlatform = activeTab ? activeTab.getAttribute('data-platform') : 'all';
        filterPostsByTab(activePlatform, null); 

        renderRegionStats(filteredAccounts);
        renderPlatformComparison(filteredAccounts, filteredPosts); 
    }

    // ==========================================
    // 5. TOP POSTS & TABS LOGIC
    // ==========================================
    function filterPostsByTab(platform, element) {
        if(element) {
            document.querySelectorAll('#analytics-view .platform-tab').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }

        const source = currentFilteredPosts || [];
        let postsToShow = [];

        if (platform === 'all') {
            const fb = source.filter(p => p.platform === 'facebook').sort((a,b) => b.likes - a.likes).slice(0, 10);
            const ig = source.filter(p => p.platform === 'instagram').sort((a,b) => b.likes - a.likes).slice(0, 10);
            const tt = source.filter(p => p.platform === 'tiktok').sort((a,b) => b.likes - a.likes).slice(0, 10);
            
            postsToShow = [...fb, ...ig, ...tt];
            postsToShow.sort((a,b) => b.likes - a.likes);
        } else {
            postsToShow = source
                .filter(p => p.platform === platform)
                .sort((a,b) => b.likes - a.likes)
                .slice(0, 10);
        }

        renderPostGrid(postsToShow);
    }

    function renderPostGrid(posts) {
        const grid = document.getElementById('posts-grid');
        if(!grid) return;
        grid.innerHTML = '';
        
        if (posts.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999"><i class="fas fa-search" style="font-size:24px;margin-bottom:10px"></i><br>No posts found matching criteria</div>';
            return;
        }

        posts.forEach(post => {
            const acc = post.social_accounts || {};
            const date = new Date(post.posted_at).toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
   
            let bgImage = 'linear-gradient(45deg, #f3f4f6, #e5e7eb)';
            let playIcon = '';
            
            if (post.image_url && post.image_url.startsWith('http')) {
                bgImage = `url('${post.image_url}')`;
            } 
            
            const type = (post.media_type || '').toUpperCase();
            if (['VIDEO', 'REELS'].includes(type) || post.platform === 'tiktok') {
                playIcon = '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:40px;color:white;opacity:0.8;text-shadow:0 2px 4px rgba(0,0,0,0.5);"><i class="fas fa-play-circle"></i></div>';
            }

            const platformColor = getPlatformColor(acc.platform);
            const card = `
                <div class="post-card" data-platform="${acc.platform}" data-region="${acc.region || 'global'}">
                    <div class="post-image" style="background-image: ${bgImage};">
                        <span class="post-platform-overlay" style="background-color: ${platformColor.overlay || platformColor.text}; color: white">
                            <i class="${getPlatformIcon(acc.platform)}"></i> ${capitalize(acc.platform)}
                        </span>
                        <span class="post-region-overlay">
                            <i class="fas fa-map-marker-alt"></i> ${formatRegion(acc.region || 'global')}
                        </span>
                        ${playIcon}
                    </div>
                    <div class="post-content">
                        <h4 class="post-title" title="${post.caption || 'No caption'}">${post.caption ? post.caption.substring(0, 60)+(post.caption.length>60?'...':'') : 'No Caption'}</h4>
                        <div class="post-info">
                            <span class="post-date">${date}</span>
                            <span class="post-page">${acc.name || 'Unknown'}</span>
                        </div>
                        <div class="post-metrics">
                            <div class="metric">
                                <span class="metric-label">Likes</span>
                                <span class="metric-value"><i class="fas fa-heart"></i> ${formatNumber(post.likes || 0)}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Comments</span>
                                <span class="metric-value"><i class="fas fa-comment"></i> ${formatNumber(post.comments || 0)}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Shares</span>
                                <span class="metric-value"><i class="fas fa-share"></i> ${formatNumber(post.shares || 0)}</span>
                            </div>
                        </div>
                        <div class="engagement-rate-bar">
                            <a href="${post.post_url || '#'}" target="_blank" style="text-decoration:none;font-size:12px;color:var(--primary);font-weight:600;">
                                View Post <i class="fas fa-external-link-alt"></i>
                            </a>
                        </div>
                    </div>
                </div>
            `;
            grid.innerHTML += card;
        });
    }

    // ==========================================
    // 6. ACCOUNT TABLE FILTER
    // ==========================================
    function filterAccountTable() {
        const filterType = document.getElementById('account-filter').value;
        let dataToShow = typeof currentFilteredAccounts !== 'undefined' ? [...currentFilteredAccounts] : []; 
        if(dataToShow.length === 0 && rawData.accounts.length > 0) dataToShow = [...rawData.accounts];

        if (filterType === 'top10') {
            dataToShow.sort((a, b) => (b.followers_count||0) - (a.followers_count||0));
            dataToShow = dataToShow.slice(0, 10);
        } else if (filterType === 'bottom10') {
            dataToShow.sort((a, b) => (a.followers_count||0) - (b.followers_count||0));
            dataToShow = dataToShow.slice(0, 10);
        } else {
            dataToShow.sort((a, b) => (b.followers_count||0) - (a.followers_count||0));
        }
        renderAccountTable(dataToShow, window.currentHistoryMap);
    }

    // ==========================================
    // 7. RENDER OTHER SECTIONS
    // ==========================================
    function renderSummaryCards(accounts, historyMap, days) {
        let curr = { fol: 0, imp: 0, eng: 0, click: 0, new: 0 };
        let prev = { fol: 0, imp: 0, eng: 0, click: 0 };

        accounts.forEach(acc => {
            const fol = acc.followers_count||0;
            curr.fol += fol;
            curr.imp += (acc.impressions||0);
            curr.eng += (acc.engagement||0);
            curr.click += (acc.clicks||0);

            const old = historyMap[acc.id] || {};
            const oldFol = old.followers_count || fol;
            prev.fol += oldFol;
            prev.imp += (old.impressions || acc.impressions);
            prev.eng += (old.engagement || acc.engagement);
            prev.click += (old.clicks || acc.clicks);
            curr.new += (fol - oldFol);
        });

        const calcGrowth = (c, p) => p > 0 ? ((c - p) / p) * 100 : 0;

        updateCardUI('total-impressions', curr.imp, calcGrowth(curr.imp, prev.imp));
        updateCardUI('total-followers', curr.fol, calcGrowth(curr.fol, prev.fol));
        updateCardUI('total-engagement', curr.eng, calcGrowth(curr.eng, prev.eng));
        updateCardBySelector('#analytics-view .stat-card.clicks .stat-value', curr.click, calcGrowth(curr.click, prev.click));
        updateCardBySelector('#analytics-view .stat-card.followers .stat-value', curr.new, 0);

        const currRate = curr.fol > 0 ? ((curr.eng/curr.fol)*100) : 0;
        const prevRate = prev.fol > 0 ? ((prev.eng/prev.fol)*100) : 0;
        document.getElementById('avg-engagement-rate').innerText = currRate.toFixed(2) + '%';
        updatePercentUI(document.querySelector('#analytics-view .stat-card.rate'), calcGrowth(currRate, prevRate));
        
        // Update comparison text
        document.querySelectorAll('#analytics-view .comparison-text').forEach(el => {
            if (el.closest('.stat-card.followers')) {
                el.innerText = `Across all platforms`;
            } else if (el.closest('.stat-card.rate')) {
                el.innerText = `Average per account`;
            } else {
                el.innerText = `vs ${days} days ago`;
            }
        });

        window.currentFilteredAccounts = accounts;
        window.currentHistoryMap = historyMap;
    }

    function getCountryInitials(name, handle) {
      
      const n = name ? name.toUpperCase().trim() : '';
      const h = handle ? handle.toUpperCase().trim() : '';
      const text = n + ' ' + h; 

      if (n.includes('DEFAULT')) return 'TH';

      if (/\bUAE\b/.test(text) || text.includes('DUBAI') || text.includes('EMIRATES') || text.includes('.AE')) {
          return 'AE';
      }

      if (text.includes('THAI') || text.includes('.TH')) {
          return 'TH';
      }

      const nameParts = n.split(' ');
      const lastWord = nameParts[nameParts.length - 1];
      
      if (lastWord && lastWord.length === 2 && /^[A-Z]+$/.test(lastWord)) {
          return lastWord;
      }

      if (h.includes('.')) {
          const parts = h.split('.');
          const ext = parts[parts.length - 1]; 
          
          if (ext.length === 2 && /^[A-Z]+$/.test(ext)) {
              return ext;
          }
    }

    if (text.includes('JAPAN')) return 'JP';
    if (text.includes('KOREA')) return 'KR';
    if (text.includes('INDIA')) return 'IN';
    if (text.includes('USA') || text.includes('AMERICA')) return 'US';

    return n.charAt(0) || '-';
}

    function renderAccountTable(accounts, historyMap) {
        const tbody = document.getElementById('accounts-table-body');
        if(!tbody) return;
        tbody.innerHTML = '';
        accounts.sort((a,b) => (b.followers_count||0) - (a.followers_count||0));

        accounts.forEach(acc => {
            const old = historyMap && historyMap[acc.id] ? historyMap[acc.id] : {};
            const growth = (acc.followers_count||0) - (old.followers_count || acc.followers_count||0);
            const engRate = (acc.followers_count||0) > 0 ? ((acc.engagement/acc.followers_count)*100).toFixed(2) : '0.00';
            
            let growthHtml = '';
            if(growth > 0) growthHtml = `<span style="color:#28a745; font-size:11px"><i class="fas fa-arrow-up"></i> ${formatNumber(growth)}</span>`;
            else if(growth < 0) growthHtml = `<span style="color:#dc3545; font-size:11px"><i class="fas fa-arrow-down"></i> ${formatNumber(Math.abs(growth))}</span>`;

            let statusHtml = '<span class="performance-indicator low"><i class="fas fa-minus"></i> No Data</span>';
            if ((acc.followers_count || 0) > 0) {
                statusHtml = '<span class="performance-indicator high"><i class="fas fa-check"></i> Active</span>';
            }

            const platformColor = getPlatformColor(acc.platform);
            const row = `<tr>
                <td>
                    <div class="page-name">
                        <div class="page-avatar" style="background:${platformColor.bg}; color:${platformColor.text}; font-size: 13px;">
                            ${getCountryInitials(acc.name, acc.handle)}
                        </div>
                        
                        <div>
                            <div style="font-weight: 600;">${acc.name || 'Unknown'}</div>
                            <div style="font-size: 12px; color: var(--gray);">${acc.handle||''} ${growthHtml}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="platform-badge ${acc.platform}" style="background:${platformColor.bg}; color:${platformColor.text}">
                        <i class="${getPlatformIcon(acc.platform)}"></i> ${capitalize(acc.platform)}
                    </span>
                </td>
                <td><span class="region-badge">${formatRegion(acc.region)}</span></td>
                <td>${formatNumber(acc.followers_count)}</td>
                <td>${formatNumber(acc.impressions)}</td>
                <td>${formatNumber(acc.engagement)}</td>
                <td>${engRate}%</td>
                <td>${statusHtml}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    function renderRegionStats(accounts) {
        const container = document.getElementById('region-container');
        if(!container) return;
        container.innerHTML = '';
        const regions = {};
        accounts.forEach(acc => {
            const r = acc.region || 'global';
            if (!regions[r]) regions[r] = { name: r, imp: 0, eng: 0, fol: 0, count: 0 };
            regions[r].imp += (acc.impressions||0);
            regions[r].eng += (acc.engagement||0);
            regions[r].fol += (acc.followers_count||0);
            regions[r].count++;
        });
        
        Object.values(regions).forEach(stat => {
            const rate = stat.fol > 0 ? (stat.eng / stat.fol) * 100 : 0;
            let level = rate > 1.5 ? (rate > 3.0 ? 'high' : 'medium') : 'low';
            let iconClass = 'fas fa-globe';
            if (stat.name.includes('asia')) iconClass = 'fas fa-globe-asia';
            else if (stat.name.includes('europe')) iconClass = 'fas fa-globe-europe';
            else if (stat.name.includes('america')) iconClass = 'fas fa-globe-americas';
            
            container.innerHTML += `
                <div class="region-card">
                    <div class="region-header">
                        <div class="region-name"><i class="${iconClass}" style="color:var(--primary)"></i> ${formatRegion(stat.name)}</div>
                        <div class="performance-indicator ${level}"><i class="fas fa-circle"></i> ${capitalize(level)}</div>
                    </div>
                    <div class="region-metrics">
                        <div class="region-metric"><span class="region-metric-label">Impressions</span><span class="region-metric-value">${formatNumber(stat.imp)}</span></div>
                        <div class="region-metric"><span class="region-metric-label">Engagement</span><span class="region-metric-value">${formatNumber(stat.eng)}</span></div>
                        <div class="region-metric"><span class="region-metric-label">Active Pages</span><span class="region-metric-value">${stat.count}</span></div>
                        <div class="region-metric"><span class="region-metric-label">Eng. Rate</span><span class="region-metric-value">${rate.toFixed(2)}%</span></div>
                    </div>
                </div>
            `;
        });
        if (Object.keys(regions).length === 0) container.innerHTML = '<div style="padding:20px; color:#999;">No data for this region.</div>';
    }

    function renderPlatformComparison(accounts, posts) {
        const container = document.getElementById('platform-comparison-grid');
        if(!container) return;
        container.innerHTML = '';

        const selectedPlatform = document.getElementById('analytics-platform-filter').value;

        let targetPlatforms = ['facebook', 'instagram', 'tiktok', ];
        
        if (selectedPlatform !== 'all') {
            targetPlatforms = [selectedPlatform];
        }

        const stats = {};
        targetPlatforms.forEach(p => { stats[p] = { count: 0, totalEng: 0, followers: 0, bestTimeMap: {} }; });

        accounts.forEach(acc => {
            const p = acc.platform.toLowerCase();
            if (stats[p]) stats[p].followers += (acc.followers_count || 0);
        });

        posts.forEach(post => {
            const p = post.platform.toLowerCase();
            if (stats[p]) {
                stats[p].count += 1;
                const eng = (post.likes||0) + (post.comments||0) + (post.shares||0);
                stats[p].totalEng += eng;
                if (post.posted_at) {
                    const hour = new Date(post.posted_at).getHours();
                    const timeSlot = Math.floor(hour / 2) * 2;
                    stats[p].bestTimeMap[timeSlot] = (stats[p].bestTimeMap[timeSlot] || 0) + eng;
                }
            }
        });

        targetPlatforms.forEach(platform => {
            const s = stats[platform];
            const avgEng = s.count > 0 ? Math.round(s.totalEng / s.count) : 0;
            const engRate = s.followers > 0 ? ((s.totalEng / s.followers) * 100).toFixed(2) : '0.00';
            
            let bestTimeStr = 'N/A';
            let maxEng = -1, bestSlot = -1;
            for (const [slot, eng] of Object.entries(s.bestTimeMap)) { if (eng > maxEng) { maxEng = eng; bestSlot = parseInt(slot); } }
            if (bestSlot !== -1) {
                const formatAMPM = (h) => { const s = h >= 12 ? 'PM' : 'AM'; const h12 = h % 12 || 12; return `${h12} ${s}`; };
                bestTimeStr = `${formatAMPM(bestSlot)} - ${formatAMPM((bestSlot + 2) % 24)}`;
            }

            const style = getPlatformColor(platform);
            const icon = getPlatformIcon(platform);

            container.innerHTML += `
                <div class="comparison-card">
                    <div class="comparison-header">
                        <div class="comparison-title"><i class="${icon}" style="color: ${style.text};"></i> ${capitalize(platform)}</div>
                        <span class="performance-indicator high"><i class="fas fa-chart-line"></i> ${engRate}% ER</span>
                    </div>
                    <div class="comparison-metrics">
                        <div class="comparison-metric-row"><span class="comparison-metric-name">Total Posts</span><span class="comparison-metric-value">${formatNumber(s.count)}</span></div>
                        <div class="comparison-metric-row"><span class="comparison-metric-name">Avg Engagement</span><span class="comparison-metric-value">${formatNumber(avgEng)}</span></div>
                        <div class="comparison-metric-row"><span class="comparison-metric-name">Total Followers</span><span class="comparison-metric-value">${formatNumber(s.followers)}</span></div>
                        <div class="comparison-metric-row"><span class="comparison-metric-name">Best Time</span><span class="comparison-metric-value" style="font-size:14px">${bestTimeStr}</span></div>
                    </div>
                </div>
            `;
        });
    }

    function renderDataPeriod(snapshots) {
        if (!snapshots || snapshots.length === 0) return;
        const start = new Date(snapshots[0].recorded_at);
        const end = new Date();
        const opts = { day: 'numeric', month: 'short', year: 'numeric' };
        const el = document.getElementById('data-period-label');
        if(el) el.innerHTML = `<i class="fas fa-history"></i> Data collected from: <b>${start.toLocaleDateString('en-US', opts)}</b> â€” <b>${end.toLocaleDateString('en-US', opts)}</b>`;
    }

    // ==========================================
    // 8. HELPERS
    // ==========================================
    function populatePageFilter() {
        const select = document.getElementById('analytics-page-filter');
        if(!select) return;
        // Keep the "All Pages" option
        const allPagesOption = select.querySelector('option[value="all"]');
        select.innerHTML = '';
        if (allPagesOption) select.appendChild(allPagesOption);
        
        const sortedAcc = [...rawData.accounts].sort((a,b) => a.name.localeCompare(b.name));
        sortedAcc.forEach(acc => {
            const opt = document.createElement('option');
            opt.value = acc.id;
            opt.innerText = `${acc.name} (${capitalize(acc.platform)})`;
            select.appendChild(opt);
        });
    }
    
    function updateCardUI(id, val, growth) {
        const el = document.getElementById(id);
        if(!el) return;
        el.innerText = formatNumber(val);
        updatePercentUI(el.closest('.stat-card'), growth);
    }
    
    function updateCardBySelector(selector, val, growth) {
        const el = document.querySelector(selector);
        if(!el) return;
        el.innerText = formatNumber(val);
        const card = el.closest('.stat-card');
        if (card) updatePercentUI(card, growth);
    }
    
    function updatePercentUI(card, percentage) {
        const changeEl = card?.querySelector('.stat-change');
        if (!changeEl) return;
        if (percentage === 0 || isNaN(percentage)) {
            changeEl.className = 'stat-change';
            changeEl.style.color = '#999';
            changeEl.innerHTML = `<i class="fas fa-minus"></i> <span>0%</span>`;
            return;
        }
        const isPositive = percentage > 0;
        changeEl.className = `stat-change ${isPositive ? 'positive' : 'negative'}`;
        changeEl.innerHTML = `<i class="fas fa-arrow-${isPositive ? 'up' : 'down'}"></i> <span>${Math.abs(percentage).toFixed(1)}%</span>`;
    }
    
    function formatNumber(num) { 
        if(isNaN(num)) return '0'; 
        if(num>=1000000) return (num/1000000).toFixed(1)+'M'; 
        if(num>=1000) return (num/1000).toFixed(1)+'K'; 
        return num.toLocaleString(); 
    }
    
    function getPlatformIcon(p) { 
        if(p==='facebook') return 'fab fa-facebook-f'; 
        if(p==='instagram') return 'fab fa-instagram'; 
        if(p==='twitter') return 'fab fa-twitter'; 
        if(p==='linkedin') return 'fab fa-linkedin'; 
        if(p==='tiktok') return 'fab fa-tiktok'; 
        if(p==='youtube') return 'fab fa-youtube'; 
        return 'fas fa-share-alt'; 
    }
    
    function getPlatformColor(p) {
        switch(p) { 
            case 'facebook': return {bg:'#e3f2fd', text:'#4267B2', overlay: 'rgba(66, 103, 178, 0.9)'}; 
            case 'instagram': return {bg:'#fce4ec', text:'#E1306C', overlay: 'rgba(225, 48, 108, 0.9)'}; 
            case 'twitter': return {bg:'#e1f5fe', text:'#1DA1F2', overlay: 'rgba(29, 161, 242, 0.9)'}; 
            case 'linkedin': return {bg:'#e0f2f1', text:'#0077B5', overlay: 'rgba(0, 119, 181, 0.9)'}; 
            case 'tiktok': return {bg:'#fce4ec', text:'#000000', overlay: 'rgba(0, 0, 0, 0.9)'}; 
            case 'youtube': return {bg:'#ffebee', text:'#FF0000', overlay: 'rgba(255, 0, 0, 0.9)'}; 
            default: return {bg:'#eee', text:'#333', overlay: 'rgba(0, 0, 0, 0.7)'}; 
        } 
    }
    
    function formatRegion(r) { 
        if(!r || r === 'global') return 'Global'; 
        return r.split('-').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' '); 
    }
    
    function capitalize(s) { 
        return s?s.charAt(0).toUpperCase()+s.slice(1):''; 
    }

    document.addEventListener('DOMContentLoaded', initDashboard);
</script>
</div>

<!-- ADD THIS CSS TO YOUR <style> SECTION -->
<style>
.main-navigation {
  display:flex; gap:10px; background:white; padding:10px; 
  border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1);
}
.nav-tab {
  flex:1; padding:15px 20px; border:none; background:transparent;
  color:var(--dark); font-size:16px; font-weight:600; cursor:pointer;
  border-radius:8px; display:flex; align-items:center; justify-content:center;
  gap:10px; transition:all 0.3s ease;
}
.nav-tab:hover { background:var(--light); }
.nav-tab.active {
  background:var(--primary); color:white;
  box-shadow:0 2px 5px rgba(0,0,0,0.2);
}
</style>

<!-- ADD THIS JAVASCRIPT AT THE END OF YOUR SCRIPT -->
<script>
window.switchView = function(view) {
  // Update tab styling
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  if(view === 'calendar') {
    document.querySelector('.nav-tab:first-child').classList.add('active');
    document.getElementById('calendar-view').style.display = 'block';
    document.getElementById('analytics-view').style.display = 'none';
  } else {
    document.querySelector('.nav-tab:last-child').classList.add('active');
    document.getElementById('calendar-view').style.display = 'none';
    document.getElementById('analytics-view').style.display = 'block';
  }
};
</script>
 
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const SUPABASE_URL = "https://merpsvkfmjbugrgnwwlq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1lcnBzdmtmbWpidWdyZ253d2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NzcyMDksImV4cCI6MjA3NzQ1MzIwOX0.HYqgv5VFQxQ0E1QsxXYLLXu_r6LguyAEaErDSkHUc88";
  const GENERATE_CAROUSEL_WEBHOOK_URL = "https://saschag.app.n8n.cloud/webhook/calendar-carousel";
  
  const LIST_VIDEOS_WEBHOOK_URL = "https://saschag.app.n8n.cloud/webhook/list-videos"; 
  const STORAGE_BASE_URL = "https://merpsvkfmjbugrgnwwlq.supabase.co/storage/v1/object/public";

  const BUCKET_SHORTFORM = "ShortForm";
  const BUCKET_SHORTVIDEO = "ShortVideo";
  const BUCKET_CAROUSEL = "carousel-image";

  const z2 = (n) => String(n).padStart(2, "0");
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const MARKETS = ['US','Korea','India','France','Japan','UK','Germany','Thailand','Quuba'];
  const norm = s => (s || '').toString().trim().toLowerCase();
  const hasMarketCI = (arr, m) => (arr || []).some(x => norm(x) === norm(m));
  const dedupeMarketsCI = (arr) => { const seen=new Set(); const out=[]; for (const m of arr||[]) { const k=norm(m); if(!seen.has(k)){seen.add(k); out.push(m);} } return out; };
  const toCanonicalMarket = (m) => MARKETS.find(mm => norm(mm) === norm(m)) || m;

  let currentDate = new Date(2025, 10, 1); // Nov 2025
  let isEditMode = false;
  let currentView = 'global';
  let currentMarket = 'US';
  let currentlyEditingDay = null;

  let monthDataCache = {};
  let realtimeChannel = null;
  const table = 'calendars';

  function showNotification(message, type = 'success') {
    const el = document.getElementById('save-notification');
    el.textContent = message;
    el.style.display = 'block';
    el.style.background = type === 'success' ? 'var(--primary)' : 'var(--secondary)';
    setTimeout(() => { el.style.display = 'none'; }, 5000);
  }

  function getFileUrl(filename, type) {
    if (!filename) return '';
    if (filename.startsWith('http')) return filename; 

   
    let bucket = "ShortForm"; 

    
    if (type === 'ai-shortform') bucket = "ShortVideo"; 
    else if (type === 'ai-carousel') bucket = "carousel-image";
  
    return `${STORAGE_BASE_URL}/${bucket}/${encodeURIComponent(filename)}`;
  }

  async function triggerAICarouselGeneration({ schedule_id, theme, prompt, markets, platforms=[], count = 6 }) {
    try {
      showNotification("Starting AI Carousel generationâ€¦");
      const resp = await fetch(GENERATE_CAROUSEL_WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          schedule_id,
          date: schedule_id,
          theme,
          prompt,
          markets,
          platforms,
          count
        })
      });

      let data = null;
      try { data = await resp.json(); } catch {}

      const isSuccess = resp.ok || (data && data.message === 'Workflow was started');

      if (!isSuccess) {
        console.error("Generation webhook failed:", data || await resp.text());
        showNotification("AI Carousel generation failed. Check automation logs.", "error");
        return { ok: false, data };
      }

      showNotification("AI Carousel generated and uploaded to Canto.", "success");
      return { ok: true, data };
    } catch (err) {
      console.error(err);
      showNotification("AI Carousel generation failed (network).", "error");
      return { ok: false, error: err?.message || "network_error" };
    }
  }

  function buildMarketButtons() {
    const container = document.getElementById('market-selector');
    container.innerHTML = '';
    MARKETS.forEach((m) => {
      const b = document.createElement('button');
      b.className = 'market-btn';
      b.dataset.market = m;
      b.textContent = m;
      b.addEventListener('click', (e) => toggleMarket(e.currentTarget, m));
      container.appendChild(b);
    });
  }

  let selectedMarkets = [];

  function toggleMarket(btnElement, marketName) {
    const canonicalMarket = toCanonicalMarket(marketName);
    const isActive = btnElement.classList.toggle('active');
    const index = selectedMarkets.indexOf(canonicalMarket);

    if (isActive && index === -1) {
      selectedMarkets.push(canonicalMarket);
    } else if (!isActive && index > -1) {
      selectedMarkets.splice(index, 1);
    }
    renderCalendar(currentDate);
  }

  function buildMarketCheckboxes() {
    const box = document.getElementById('market-checkboxes');
    box.innerHTML = '';
    MARKETS.forEach((m) => {
      const id = `market-${m.toLowerCase().replace(/\s+/g,'-')}`;
      const wrap = document.createElement('div');
      wrap.className = 'market-checkbox';
      wrap.innerHTML = `
        <input type="checkbox" id="${id}" value="${m}" checked/>
        <label for="${id}">${m}</label>
      `;
      box.appendChild(wrap);
    });
  }

  function applyHashRoute() {
    const hash = (location.hash || '').toLowerCase();
    if (hash === '#quuba') {
      currentMarket = 'Quuba'; setView('individual'); buildMarketButtons();
    } else if (hash === '#thailand') {
      currentMarket = 'Thailand'; setView('individual'); buildMarketButtons();
    }
  }

  async function ensureAuthenticated() {
    const { data } = await supabase.auth.getSession();
    if (data?.session) return true;

    return new Promise((resolve) => {
      const authForm = document.getElementById('auth-form');
      const closeBtn = document.getElementById('close-auth');
      const cancelBtn = document.getElementById('cancel-auth');

      openAuthModal();

      const onSubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById('auth-email').value.trim();
        const pass  = document.getElementById('auth-password').value;
        const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
        if (error) { alert('Invalid credentials or sign-in error.'); return; }
        cleanup(); closeAuthModal();
        document.getElementById('logout-btn').style.display = 'inline-block';
        resolve(true);
      };
      const onCancel = () => { cleanup(); closeAuthModal(); resolve(false); };
      const onEsc = (e) => { if (e.key === 'Escape') onCancel(); };

      function cleanup() {
        authForm.removeEventListener('submit', onSubmit);
        closeBtn.removeEventListener('click', onCancel);
        cancelBtn.removeEventListener('click', onCancel);
        window.removeEventListener('keydown', onEsc);
      }

      authForm.addEventListener('submit', onSubmit);
      closeBtn.addEventListener('click', onCancel);
      cancelBtn.addEventListener('click', onCancel);
      window.addEventListener('keydown', onEsc);
    });
  }

  function openAuthModal() {
    document.getElementById('auth-email').value = '';
    document.getElementById('auth-password').value = '';
    document.getElementById('auth-modal').style.display = 'flex';
    setTimeout(() => document.getElementById('auth-email').focus(), 0);
  }
  function closeAuthModal() { document.getElementById('auth-modal').style.display = 'none'; }

  (async () => {
    const { data: authState } = await supabase.auth.getSession();
    document.getElementById('logout-btn').style.display = authState?.session ? 'inline-block' : 'none';
    supabase.auth.onAuthStateChange((_event, session) => {
      document.getElementById('logout-btn').style.display = session ? 'inline-block' : 'none';
    });
  })();

  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    if (isEditMode) toggleEditMode();
    await supabase.auth.signOut();
    showNotification('Signed out.');
  });

  function monthId(dateObj) {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth()+1).padStart(2,'0');
    return `${y}-${m}`;
  }

  async function upsertEmptyMonthIfMissing(dateObj) {
    const id = monthId(dateObj);
    const { data, error } = await supabase
      .from(table)
      .select('id')
      .eq('id', id)
      .maybeSingle();

    if (error && error.code !== 'PGRST116') {
      console.error('Existence check error:', error);
      return;
    }
    if (!data) {
      const { data: sess } = await supabase.auth.getSession();
      if (sess?.session) {
        const { error: insErr } = await supabase.from(table).upsert({ id, days: {} }, { onConflict: 'id' });
        if (insErr) console.error('Create empty month error:', insErr);
      }
    }
  }

  async function bindMonth(dateObj) {
    if (realtimeChannel) {
      try { await supabase.removeChannel(realtimeChannel); } catch {}
      realtimeChannel = null;
    }

    const id = monthId(dateObj);
    await upsertEmptyMonthIfMissing(dateObj);

    const { data, error } = await supabase
      .from(table)
      .select('days')
      .eq('id', id)
      .maybeSingle();

    if (error) { console.error(error); monthDataCache = {}; }
    else { monthDataCache = (data && data.days) || {}; }

    renderCalendar(dateObj);
    updateFolderCounts();

    try {
      realtimeChannel = supabase
        .channel(`db-changes-${id}`)
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: table,
          filter: `id=eq.${id}`
        }, (payload) => {
          const newDays = payload?.new?.days;
          if (newDays) {
            monthDataCache = newDays;
            renderCalendar(dateObj);
          }
        })
        .subscribe();
    } catch(e) { console.error("Realtime subscription failed", e); }
  }

  async function writeDay(dateObj, day, payload) {
    const id = monthId(dateObj);
    const { data: sel, error: selErr } = await supabase
      .from(table)
      .select('days')
      .eq('id', id)
      .maybeSingle();

    if (selErr && selErr.code !== 'PGRST116') {
      console.error('Select error:', selErr);
      alert('Could not load current month data (network/permissions).');
      return;
    }

    const days = { ...(sel?.days || {}) };
    days[day] = payload;

    const { error: upErr } = await supabase
      .from(table)
      .upsert({ id, days }, { onConflict: 'id' });

    if (upErr) {
      console.error('Upsert error:', upErr);
      alert('Save failed (permissions or network).');
    } else {
      monthDataCache = days;
      renderCalendar(currentDate);
      updateFolderCounts();
    }
  }

  async function deleteDay(dateObj, day) {
    const id = monthId(dateObj);
    const { data: sel, error: selErr } = await supabase
      .from(table)
      .select('days')
      .eq('id', id)
      .maybeSingle();

    if (selErr && selErr.code !== 'PGRST116') {
      console.error('Select error:', selErr);
      alert('Could not load current month data (network/permissions).');
      return;
    }

    const days = { ...(sel?.days || {}) };
    delete days[day];

    const { error: upErr } = await supabase
      .from(table)
      .upsert({ id, days }, { onConflict: 'id' });

    if (upErr) {
      console.error('Upsert error:', upErr);
      alert('Delete failed (permissions or network).');
    } else {
      monthDataCache = days;
      renderCalendar(currentDate);
      updateFolderCounts();
    }
  }

  /* ===== Helper: fake media per content type (for post preview) ===== */
  function getPlaceholderMedia(content) {
    const type = content?.type || '';
    const base = 'https://placehold.co';

    if (content && content.mediaUrl) {
      return {
        url: content.mediaUrl,
        label: 'Linked asset',
        alt: `${getContentTypeName(type)} media`,
        shape:
          type === 'longform'
            ? 'media-landscape'
            : type.includes('carousel')
            ? 'media-square'
            : 'media-vertical',
      };
    }

    switch (type) {
      case 'ai-shortform':
        return {
          url: `${base}/600x1067?text=AI+Shortform+Preview`,
          label: 'Fake AI shortform video preview',
          alt: 'AI shortform placeholder',
          shape: 'media-vertical',
        };
      case 'shortform':
        return {
          url: `${base}/600x1067?text=Shortform+Preview`,
          label: 'Fake shortform video preview',
          alt: 'Shortform placeholder',
          shape: 'media-vertical',
        };
      case 'ai-carousel':
        return {
          url: `${base}/800x800?text=AI+Carousel+Preview`,
          label: 'Fake AI carousel preview',
          alt: 'AI carousel placeholder',
          shape: 'media-square',
        };
      case 'real-carousel':
        return {
          url: `${base}/800x800?text=Real+Carousel+Preview`,
          label: 'Fake real carousel preview',
          alt: 'Real carousel placeholder',
          shape: 'media-square',
        };
      case 'longform':
        return {
          url: `${base}/1280x720?text=Longform+Video+Preview`,
          label: 'Fake longform video preview',
          alt: 'Longform video placeholder',
          shape: 'media-landscape',
        };
      case 'no-post':
        return {
          url: `${base}/800x400?text=Analytics+%2F+No+Post`,
          label: 'Analytics / no-post day',
          alt: 'No post placeholder',
          shape: 'media-landscape',
        };
      default:
        return {
          url: `${base}/800x800?text=Content+Preview`,
          label: 'Generic content preview',
          alt: 'Content placeholder',
          shape: 'media-square',
        };
    }
  }

  function openViewModal(day) {
    const month = currentDate.getMonth() + 1;
    const year = currentDate.getFullYear();
    const viewTitle = document.getElementById('view-title');
    viewTitle.textContent = `Content Details - ${day}/${month}/${year}`;

    const rawDayData = monthDataCache?.[day] || null;
    const dayDataArray = Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : []);

    const body = document.getElementById('view-body');
    body.innerHTML = '';

    if (dayDataArray.length === 0) {
      body.innerHTML = `<p><strong>No content scheduled</strong> for this day.</p>`;
    } else {
      dayDataArray.forEach((content, index) => {
        if (!content) return;

        const markets = (content.markets || []).map(toCanonicalMarket).join(', ') || '-';
        
        let platforms = [];
        if (Array.isArray(content.platform)) platforms = content.platform;
        else if (content.platform) platforms = [content.platform];

        const platformIcons = platforms.map(p => {
            if (p.toLowerCase() === 'facebook') return `<i class="fa-brands fa-facebook" style="color:#1877F2;"></i>`;
            if (p.toLowerCase() === 'instagram') return `<i class="fa-brands fa-instagram" style="color:#E4405F;"></i>`;
            return `<span>${p}</span>`;
        }).join(' ');


        let mediaHtml = '';
        
        if (content.type.includes('shortform') || content.type === 'longform') {
            let finalVideoUrl = content.videoUrl;
            

            if (!finalVideoUrl && content.fileName) {
                finalVideoUrl = getFileUrl(content.fileName, content.type);
            }

            if (finalVideoUrl) {
               mediaHtml = `
                 <div class="preview-block">
                   <div class="media-preview">
                     <div class="media-frame media-vertical" style="background:black;">
                       <video controls style="width:100%; height:100%; object-fit:contain;">
                         <source src="${finalVideoUrl}" type="video/mp4">
                         Your browser does not support the video tag.
                       </video>
                     </div>
                     <div class="media-label">
                       <i class="fa-solid fa-file-video"></i> <span>${content.fileName}</span>
                     </div>
                   </div>
                 </div>`;
            }
        }
        
        else if (content.type === 'ai-carousel' && content.images && content.images.length > 0) {
            const imagesHtml = content.images.map(filename => {
              
                const cleanName = filename.replace('carousel-image/', '').replace('carousel-image\\', '');
                
        
                const url = `${STORAGE_BASE_URL}/${BUCKET_CAROUSEL}/${encodeURIComponent(cleanName)}`;
                
                return `
                  <a href="${url}" target="_blank">
                    <img src="${url}" style="width:100px; height:100px; object-fit:cover; border-radius:4px; border:1px solid #eee; margin:2px;" 
                    onerror="this.src='https://placehold.co/100x100?text=Error';">
                  </a>
                `;
            }).join('');

            mediaHtml = `
              <div class="preview-block">
                <div class="media-label" style="margin-bottom:5px;">
                  <i class="fa-solid fa-images"></i> Generated Assets (${content.images.length})
                </div>
                <div style="display:flex; flex-wrap:wrap; gap:5px;">
                  ${imagesHtml}
                </div>
              </div>
            `;
        }

        if (!mediaHtml) {
           const media = getPlaceholderMedia(content);
           mediaHtml = `
              <div class="preview-block">
                <div class="media-preview">
                  <div class="media-frame ${media.shape}">
                    <img src="${media.url}" alt="${media.alt}" loading="lazy" />
                  </div>
                  <div class="media-label"><i class="fa-solid fa-photo-film"></i> <span>${media.label}</span></div>
                </div>
              </div>`;
        }
  
        const aiBlock = (content.type === 'ai-carousel' && content.aiPrompt) 
            ? `<div class="form-group" style="margin-top:10px;"><label>AI Prompt</label><div class="form-control" style="background:#f9f9f9;">${content.aiPrompt}</div></div>` 
            : '';

        body.innerHTML += `
          ${index > 0 ? '<hr style="margin: 20px 0; border-top: 1px solid #eee;">' : ''}
          <h3 class="preview-title-activity">Activity ${index + 1}: ${getContentTypeName(content.type)}</h3>
          ${mediaHtml}
          <div class="form-group"><label>Theme</label><div class="form-control preview-theme">${content.theme || '-'}</div></div>
          ${aiBlock}
          <div class="preview-meta-row">
             <div class="preview-meta-pill"><i class="fa-solid fa-globe"></i> <strong>Markets:</strong> ${markets}</div>
             <div class="preview-meta-pill"><i class="fa-solid fa-share-nodes"></i> <strong>Platforms:</strong> ${platformIcons || '-'}</div>
          </div>
        `;
      });
    }

    const modal = document.getElementById('view-modal');
    modal.style.display = 'flex';

    const close = () => { modal.style.display = 'none'; };
    
    // Re-attach listeners correctly to prevent duplication
    const closeBtn = document.getElementById('close-view');
    const okBtn = document.getElementById('view-ok');
    
    // Clone node to remove old listeners is a quick hack, but setting onclick directly is safer here
    if(closeBtn) closeBtn.onclick = close;
    if(okBtn) okBtn.onclick = close;
  }

  document.addEventListener('DOMContentLoaded', async () => {
    buildMarketButtons();
    buildMarketCheckboxes();
    applyHashRoute();
    await bindMonth(currentDate);
    setupEventListeners();
  });

  function setupEventListeners() {
    document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
    document.getElementById('next-month').addEventListener('click', () => changeMonth(1));
    document.getElementById('global-view').addEventListener('click', () => setView('global'));
    document.getElementById('individual-view').addEventListener('click', () => setView('individual'));
    document.getElementById('close-modal').addEventListener('click', closeModal);
    document.getElementById('cancel-edit').addEventListener('click', closeModal);
    document.getElementById('delete-content').addEventListener('click', deleteContent);
    document.getElementById('content-form').addEventListener('submit', saveContent);
    document.getElementById('content-type').addEventListener('change', function() {
     const val = this.value;

    if (val === 'shortform') {
        window.CURRENT_BUCKET = "ShortForm";
    } else if (val === 'ai-shortform') {
        window.CURRENT_BUCKET = "ShortVideo";
    } else {
        window.CURRENT_BUCKET = null;
    }

    document.getElementById('ai-prompt-section').style.display =
        (val === 'ai-carousel') ? 'block' : 'none';

    document.getElementById('manual-video-section').style.display =
        (val.includes('shortform') || val === 'longform')
        ? 'block'
        : 'none';
});

    const calRoot = document.getElementById('calendar');

    calRoot.addEventListener('click', (e) => {
      const dayCell = e.target.closest('.calendar-day');
      if (!dayCell) return;
      const day = parseInt(dayCell.dataset.day, 10);
      if (!day) return;

      if (isEditMode) {
        const activityBlock = e.target.closest('.activity-block');
        if (activityBlock) {
          const activityId = activityBlock.dataset.activityId;
          if (activityId) openEditModal(day, activityId);
          return;
        }
        const isHeaderClick = e.target.closest('.date-number');
        const isAddIconClick = e.target.closest('.edit-indicator');

        if (!isHeaderClick || isAddIconClick) {
          const rawDayData = (monthDataCache && monthDataCache[day]) || null;
          const dayDataArray = Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : []);

          if (isAddIconClick && dayDataArray.length === 1) {
            const activityId = dayDataArray[0].id || 'legacy_0';
            openEditModal(day, activityId);
          } else {
            openEditModal(day, null);
          }
        }
      } else {
        // VIEW MODE: clicking a day opens the post preview
        openViewModal(day);
      }
    });

    calRoot.addEventListener('touchstart', e => { window._tSX = e.changedTouches[0].screenX; }, { passive: true });
    calRoot.addEventListener('touchend', e => {
      if (!window._tSX) return;
      const tEX = e.changedTouches[0].screenX;
      const swipe = (tEX - (window._tSX || 0));
      if (swipe > 50) changeMonth(-1);
      else if (swipe < -50) changeMonth(1);
      window._tSX = null;
    });

    window.addEventListener('hashchange', async () => { applyHashRoute(); renderCalendar(currentDate); });

    document.getElementById('edit-mode').addEventListener('click', async () => {
      if (!isEditMode) {
        const ok = await ensureAuthenticated();
        if (!ok) return;
      }
      toggleEditMode();
    });

    const mq = window.matchMedia('(max-width: 600px)');
    mq.addEventListener?.('change', () => renderCalendar(currentDate));
  }

  function setView(view) {
    currentView = view;
    const calendar = document.getElementById('calendar');
    const globalBtn = document.getElementById('global-view');
    const individualBtn = document.getElementById('individual-view');
    const marketSelector = document.getElementById('market-selector');

    if (view === 'global') {
      calendar.classList.remove('individual-view'); calendar.classList.add('global-view');
      globalBtn.classList.add('active'); individualBtn.classList.remove('active'); marketSelector.style.display = 'none';
      selectedMarkets = [];
    } else {
      calendar.classList.remove('global-view'); calendar.classList.add('individual-view');
      globalBtn.classList.remove('active'); individualBtn.classList.add('active'); marketSelector.style.display = 'flex';

      if (selectedMarkets.length === 0) {
        selectedMarkets = [toCanonicalMarket('US')];
      }

      document.querySelectorAll('.market-btn').forEach(btn => {
        const canonicalMarket = toCanonicalMarket(btn.dataset.market);
        btn.classList.toggle('active', hasMarketCI(selectedMarkets, canonicalMarket));
      });
    }
    renderCalendar(currentDate);
  }

  function setMarket(market) {
    currentMarket = toCanonicalMarket(market);
    document.querySelectorAll('.market-btn').forEach(btn => {
      btn.classList.toggle('active', norm(btn.dataset.market) === norm(currentMarket));
    });
    renderCalendar(currentDate);
  }

  function changeMonth(direction) {
    currentDate.setMonth(currentDate.getMonth() + direction);
    bindMonth(currentDate);
    renderCalendar(currentDate);
    updateFolderCounts();
    const calendar = document.getElementById('calendar');
    calendar.classList.remove('calendar-fade'); void calendar.offsetWidth; calendar.classList.add('calendar-fade');
  }

  function toggleEditMode() {
    isEditMode = !isEditMode;
    const editBtn = document.getElementById('edit-mode');
    if (isEditMode) {
      editBtn.classList.add('active'); editBtn.innerHTML = '<i class="fas fa-edit"></i> Editing';
      document.getElementById('calendar').classList.add('editable');
    } else {
      editBtn.classList.remove('active'); editBtn.innerHTML = 'Edit Mode';
      document.getElementById('calendar').classList.remove('editable');
    }
    renderCalendar(currentDate);
  }

  function newActivityId() { return 'act_' + Date.now() + Math.random().toString(36).substr(2, 9); }

  function openEditModal(day, activityId = null) {
    currentlyEditingDay = day;
    const month = currentDate.getMonth();
    const year = currentDate.getFullYear();

    const rawDayData = (monthDataCache && monthDataCache[day]) || null;
    let dayDataArray;
    if (Array.isArray(rawDayData)) {
      dayDataArray = rawDayData;
    } else if (rawDayData) {
      dayDataArray = [rawDayData];
    } else {
      dayDataArray = [];
    }

    dayDataArray.forEach((item, index) => {
      if (!item.id) {
        item.id = `legacy_${index}`;
      }
    });

    const content = activityId ? dayDataArray.find(item => item.id === activityId) : null;

    document.getElementById('modal-title').textContent = content
      ? `Edit Content - ${day}/${month+1}/${year}`
      : `Add Content - ${day}/${month+1}/${year}`;
    document.getElementById('edit-date').value = `${year}-${month}-${day}`;
    document.getElementById('edit-activity-id').value = content ? content.id : '';

    const selected = new Set((content?.markets || []).map(norm));
    document.querySelectorAll('#market-checkboxes input[type="checkbox"]').forEach(cb => {
      const isChecked = selected.size ? selected.has(norm(cb.value)) : true;
      cb.checked = isChecked;
    });

    if (content) {
      document.getElementById('content-type').value = content.type || '';
      document.getElementById('content-theme').value = content.theme || '';
      document.getElementById('ai-prompt').value = content.aiPrompt || '';
      document.getElementById('ai-prompt-section').style.display = (content.type === 'ai-carousel') ? 'block' : 'none';
      document.getElementById('delete-content').style.display = 'inline-block';

      let platforms = [];
      if (Array.isArray(content.platform)) {
        platforms = content.platform;
      } else if (content.platform) {
        platforms = [content.platform];
      }
      const platformSet = new Set(platforms);
      document.getElementById('platform-fb').checked = platformSet.has('facebook');
      document.getElementById('platform-ig').checked = platformSet.has('instagram');
    } else {
      document.getElementById('content-type').value = '';
      document.getElementById('content-theme').value = '';
      document.getElementById('platform-fb').checked = false;
      document.getElementById('platform-ig').checked = false;
      document.getElementById('ai-prompt').value = '';
      document.getElementById('ai-prompt-section').style.display = 'none';
      document.getElementById('delete-content').style.display = 'none';
    }

    document.getElementById('edit-modal').style.display = 'flex';

    const videoSection = document.getElementById('manual-video-section');
    if (content.type && (content.type.includes('shortform') || content.type === 'longform')) {
        videoSection.style.display = 'block';
        const fName = content.fileName || '';
        document.getElementById('selected-filename').value = fName;
        
        if(fName) {
            document.getElementById('preview-container').style.display = 'block';
            document.getElementById('video-player-preview').src = getFileUrl(fName, content.type);
        } else {
             document.getElementById('preview-container').style.display = 'none';
        }
    } else {
        videoSection.style.display = 'none';
    }

    if (content.type === 'ai-carousel' && content.images) {
      const previewBox = document.getElementById('preview-container');
      const container = document.createElement('div');
      container.innerHTML = content.images.map(u => `
          <img src="${u}" style="width:120px;height:120px;object-fit:cover;margin:5px;border-radius:8px;" />
      `).join('');
      previewBox.innerHTML = container.outerHTML;
      previewBox.style.display = 'block';
    }

  }

  function closeModal() {
    document.getElementById('edit-modal').style.display = 'none';
    currentlyEditingDay = null;
  }

 async function waitForAIImages(scheduleId, day, payloadId) {
    let attempts = 0;
    const maxAttempts = 90; 
    const interval = 10000; 

    let prevCount = 0;     
    let stableCount = 0;

    console.log(`ðŸ” Start Polling. Looking for ID part: "${payloadId}"`);
    showNotification('AI processing... Waiting for images.', 'success');

    const poll = setInterval(async () => {
      attempts++;
      console.log(`Attempt ${attempts}: Reading storage...`);

   
      const { data: files, error } = await supabase
        .storage
        .from(BUCKET_CAROUSEL) 
        .list('', { limit: 100, sortBy: { column: 'created_at', order: 'desc' } });
        console.log("ðŸ“‚ Files found in bucket:", files);

      if (error) { 
          console.error("âŒ Polling Error (Check Storage Policies):", error); 
          return; 
      }

      const matchedFiles = files.filter(f => f.name.includes(payloadId));

      if (matchedFiles.length > 0) {
        clearInterval(poll);
        
        const imageFilenames = matchedFiles.map(f => f.name);
        console.log("âœ… Found Match!", imageFilenames);

       
        const id = monthId(currentDate);
        const { data: sel } = await supabase.from('calendars').select('days').eq('id', id).maybeSingle();
        
        if (sel && sel.days) {
            const days = { ...sel.days };
            const currentDayArr = days[day] || [];
            const indexToUpdate = currentDayArr.findIndex(item => item.id === payloadId);

            if (indexToUpdate > -1) {
                currentDayArr[indexToUpdate] = {
                    ...currentDayArr[indexToUpdate],
                    aiGenerated: true,
                    images: imageFilenames 
                };
                days[day] = currentDayArr;

                await supabase.from('calendars').upsert({ id, days }, { onConflict: 'id' });
                
                monthDataCache = days;
               
                showNotification(`Success! AI generated ${matchedFiles.length} images.`);
              
            }
        }
      } 
      
      if (attempts >= maxAttempts) {
        clearInterval(poll);
        showNotification('Timeout: Images not found. Please check manually.', 'error');
      }

    }, interval);
  }

  async function saveContent(e) {
    e.preventDefault();
    const ok = await ensureAuthenticated(); if (!ok) return;

    const day = currentlyEditingDay;
    const activityId = document.getElementById('edit-activity-id').value;
    const type = document.getElementById('content-type').value;
    const theme = document.getElementById('content-theme').value;
    const aiPrompt = document.getElementById('ai-prompt').value;
    const manualFileName = document.getElementById('selected-filename').value;

    let selectedMarketsList = [];
    document.querySelectorAll('#market-checkboxes input:checked').forEach(cb => selectedMarketsList.push(toCanonicalMarket(cb.value)));
    selectedMarketsList = dedupeMarketsCI(selectedMarketsList).map(toCanonicalMarket);

    if (!type) { alert('Please select a content type'); return; }
    if (type === 'ai-carousel' && !aiPrompt.trim()) {
      alert('AI Carousel requires an AI Generation Prompt.');
      return;
    }

    // Inventory check: 1 AI-shortform per day vs available videos
    if (type === 'ai-shortform') {
      const availableCount = await getRealtimeVideoCount();
      let otherScheduledActivities = 0;
      Object.values(monthDataCache || {}).forEach(rawDayData => {
        const dayArray = Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : []);
        dayArray.forEach(activity => {
          if (activity.id !== activityId && activity.type === 'ai-shortform') {
            otherScheduledActivities++;
          }
        });
      });
      const newPostActivity = (selectedMarketsList.length > 0) ? 1 : 0;
      const totalFutureActivities = otherScheduledActivities + newPostActivity;
      if (totalFutureActivities > availableCount) {
        const errorMessage = `âŒ Error: Not enough videos (Available: ${availableCount}, Scheduled: ${totalFutureActivities})`;
        showNotification(errorMessage, 'error');
        return;
      }
    }

    // Longform: only 1 per month
    if (type === 'longform') {
      let existingLongform = false;
      Object.values(monthDataCache || {}).forEach(rawDayData => {
        const dayArray = Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : []);
        dayArray.forEach(activity => {
          if (activity.id !== activityId && activity.type === 'longform') {
            existingLongform = true;
          }
        });
      });
      if (existingLongform) {
        showNotification(`âŒ Error: Only one Longform allowed per month.`, 'error');
        return;
      }
    }

    const selectedPlatforms = [];
    if (document.getElementById('platform-fb').checked) selectedPlatforms.push('facebook');
    if (document.getElementById('platform-ig').checked) selectedPlatforms.push('instagram');

    const payload = {
      id: (activityId && !activityId.startsWith('legacy_')) ? activityId : newActivityId(),
      type,
      theme,
      platform: selectedPlatforms,
      fileName: manualFileName,
      markets: selectedMarketsList

    };
    if (type === 'ai-carousel') 
      payload.aiPrompt = aiPrompt;
      payload.images = [];
    

    const rawDayData = monthDataCache[day] || null;
    const currentDayArray = (Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : [])).slice();

    if (activityId) {
      const index = currentDayArray.findIndex(item => item.id === activityId);
      if (index > -1) currentDayArray[index] = payload;
      else currentDayArray.push(payload);
    } else {
      currentDayArray.push(payload);
    }

    await writeDay(currentDate, day, currentDayArray);
    showNotification('Content saved successfully!');
    closeModal();

    try {
      if (type === 'ai-carousel') {
        const y = currentDate.getFullYear();
        const m = z2(currentDate.getMonth() + 1);
        const d = z2(day);
        const schedule_id = `${y}-${m}-${d}-${payload.id}`;

        const gen = await triggerAICarouselGeneration({
          schedule_id,
          theme,
          prompt: aiPrompt,
          markets: selectedMarketsList,
          platforms: selectedPlatforms,
          count: 6
        });
      
        if (gen.ok) {
        
            if (gen.data && gen.data.images && gen.data.images.length > 0) {
                 const id = monthId(currentDate);
                 const { data: sel } = await supabase.from('calendars').select('days').eq('id', id).maybeSingle();
                 const days = { ...(sel?.days || {}) };
                 const finalDayArray = (days[day] || []).slice();
                 const indexToUpdate = finalDayArray.findIndex(item => item.id === payload.id);

                 if (indexToUpdate > -1) {
                     finalDayArray[indexToUpdate] = {
                         ...finalDayArray[indexToUpdate],
                         aiGenerated: true,
                         images: gen.data.images.map(p => `${BUCKET_CAROUSEL}${encodeURIComponent(p.replace('carousel-image/', ''))}`)
                     };
                     days[day] = finalDayArray;
                     await supabase.from('calendars').upsert({ id, days }, { onConflict: 'id' });
                     showNotification('AI Assets attached immediately!');
                 }
            } 
      
            else {
                 waitForAIImages(schedule_id, day, payload.id);
            }
        } else {
            showNotification('AI Trigger failed: n8n returned error.', 'error');
        }
      }
    } catch (err) {
      console.error(err);
      showNotification('Saved, but AI generation failed.', 'error');
    }
  }

  async function deleteContent() {
    const ok = await ensureAuthenticated();
    if (!ok) return;

    const day = currentlyEditingDay;
    const activityId = document.getElementById('edit-activity-id').value;
    if (!day || !activityId) {
      alert("Error: Could not find item to delete.");
      return;
    }

    const rawDayData = monthDataCache[day] || null;
    const currentDayArray = (Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : [])).slice();
    const newDayArray = currentDayArray.filter(item => item.id !== activityId);

    await writeDay(currentDate, day, newDayArray);
    showNotification('Content deleted successfully!');
    closeModal();
  }

  function getContentTypeName(type) {
    switch (type) {
      case 'shortform': return 'Shortform';
      case 'ai-shortform': return 'AI Shortform';
      case 'ai-carousel': return 'AI Carousel';
      case 'real-carousel': return 'Real Carousel';
      case 'longform': return 'Longform';
      case 'no-post': return 'No Post';
      default: return '';
    }
  }

  function renderCalendar(date) {
    const calendarEl = document.getElementById('calendar');
    const monthYearEl = document.getElementById('current-month');

    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    monthYearEl.textContent = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;

    calendarEl.innerHTML = '';
    const isMobile = window.matchMedia && window.matchMedia('(max-width: 600px)').matches;

    function createActivityHtml(dayData, index = 0) {
      if (currentView === 'individual' && selectedMarkets.length > 0) {
        const marketsOnThisActivity = new Set(
          (dayData.markets || []).map(toCanonicalMarket)
        );
        const isMatch = [...selectedMarkets].some(targetMarket =>
          marketsOnThisActivity.has(targetMarket)
        );
        if (!isMatch) return '';
      }

      let viewSpecificHtml = '';
      if (currentView === 'global') {
        const marketCount = (dayData.markets || []).length;
        viewSpecificHtml = `<div class="market-count">${marketCount} market${marketCount !== 1 ? 's' : ''}</div>`;
      } else {
        viewSpecificHtml = `<div class="market-tags">
          ${(dayData.markets || []).map(m => `<span class="market-tag">${toCanonicalMarket(m)}</span>`).join('')}
        </div>`;
      }

      const activityId = dayData.id || `legacy_${index}`;

      let platforms = [];
      if (Array.isArray(dayData.platform)) {
        platforms = dayData.platform;
      } else if (dayData.platform) {
        platforms = [dayData.platform];
      }
      const platformSet = new Set(platforms);

      let platformIcons = '';
      const iconStyle = "font-size: 0.9rem; vertical-align: middle; margin-left: 5px;";
      if (platformSet.has('facebook')) platformIcons += `<i class="fa-brands fa-facebook" style="color:#1877F2; ${iconStyle}"></i>`;
      if (platformSet.has('instagram')) platformIcons += `<i class="fa-brands fa-instagram" style="color:#E4405F; ${iconStyle}"></i>`;

      return `
        <div class="activity-block" data-activity-id="${activityId}">
          <div class="content-type ${dayData.type}">${getContentTypeName(dayData.type)}${platformIcons}</div>
          ${viewSpecificHtml}
          <div class="content-theme">${dayData.theme || ''}</div>
        </div>
      `;
    }

    if (isMobile) {
      const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
      const list = document.createElement('div');
      list.className = 'mobile-list';
      calendarEl.appendChild(list);

      for (let d = 1; d <= daysInMonth; d++) {
        const day = document.createElement('div');
        day.className = 'calendar-day' + (isEditMode ? ' editable' : '');
        day.dataset.day = String(d);

        const rawDayData = (monthDataCache && monthDataCache[d]) || null;
        const dayDataArray = Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : []);

        let activitiesHtml = '';
        dayDataArray.forEach((activityData, index) => {
          activitiesHtml += createActivityHtml(activityData, index);
        });

        let html = `<div class="date-number">${d}`;
        if (isEditMode) html += `<span class="edit-indicator"><i class="fas fa-edit"></i></span>`;
        html += `</div>`;

        html += activitiesHtml;

        if (activitiesHtml.trim() === '' && currentView === 'global') {
          html += `<div class="empty-day">No content scheduled</div>`;
        } else if (activitiesHtml.trim() === '' && currentView === 'individual' && selectedMarkets.length > 0) {
          html += `<div class="empty-day" style="opacity:0.5;">No content for selected markets</div>`;
        }

        day.innerHTML = html;
        list.appendChild(day);
      }
    } else {
      const header = document.createElement('div');
      header.className = 'calendar-header';
      header.innerHTML = `
        <div>Sunday</div><div>Monday</div><div>Tuesday</div>
        <div>Wednesday</div><div>Thursday</div><div>Friday</div><div>Saturday</div>
      `;
      calendarEl.appendChild(header);

      const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
      const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();

      let dayCount = 1;
      for (let i = 0; i < 6; i++) {
        const week = document.createElement('div');
        week.className = 'calendar-week';

        for (let j = 0; j < 7; j++) {
          const day = document.createElement('div');

          if (i === 0 && j < firstDay) {
            const prevMonthDays = new Date(date.getFullYear(), date.getMonth(), 0).getDate();
            const dayNumber = prevMonthDays - firstDay + j + 1;
            day.className = 'calendar-day other-month';
            day.innerHTML = `<div class="date-number">${dayNumber}</div><div>Previous Month</div>`;
          } else if (dayCount > daysInMonth) {
            const dayNumber = dayCount - daysInMonth;
            day.className = 'calendar-day other-month';
            day.innerHTML = `<div class="date-number">${dayNumber}</div><div>Next Month</div>`;
            dayCount++;
          } else {
            const dayClass = isEditMode ? 'calendar-day editable' : 'calendar-day';
            day.className = dayClass;
            day.dataset.day = String(dayCount);

            const rawDayData = (monthDataCache && monthDataCache[dayCount]) || null;
            const dayDataArray = Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : []);

            let activitiesHtml = '';
            dayDataArray.forEach(activityData => {
              activitiesHtml += createActivityHtml(activityData);
            });

            let dayHTML = `<div class="date-number">${dayCount}`;
            if (isEditMode) dayHTML += `<span class="edit-indicator"><i class="fas fa-edit"></i></span>`;
            dayHTML += `</div>`;

            dayHTML += activitiesHtml;

            if (activitiesHtml.trim() === '' && currentView === 'global') {
              dayHTML += `<div class="empty-day">No content scheduled</div>`;
            } else if (activitiesHtml.trim() === '' && currentView === 'individual' && selectedMarkets.length > 0) {
              dayHTML += `<div class="empty-day" style="opacity:0.5;">No content</div>`;
            }

            day.innerHTML = dayHTML;
            dayCount++;
          }
          week.appendChild(day);
        }
        calendarEl.appendChild(week);
        if (dayCount > daysInMonth) break;
      }
    }

    updateContentSummary(date);
    updateShortformPerMarketCounts(); // keep per-country shortform in sync
  }

  function updateContentSummary(date) {
    const monthData = monthDataCache || {};
    let totalPosts = 0, shortformCount = 0, aiShortformCount = 0, aiCount = 0, realCount = 0, longformCount = 0;

    Object.values(monthData).forEach(rawDayData => {
      const dayDataArray = Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : []);
      dayDataArray.forEach(content => {
        const count = (content.markets || []).length;
        switch (content.type) {
          case 'shortform': shortformCount += count; break;
          case 'ai-shortform': aiShortformCount += count; break;
          case 'ai-carousel': aiCount += count; break;
          case 'real-carousel': realCount += count; break;
          case 'longform': longformCount += count; break;
        }
        if (content.type !== 'no-post') totalPosts += count;
      });
    });

    document.getElementById('total-posts').textContent = String(totalPosts);
    document.getElementById('shortform-count').textContent = String(shortformCount);
    document.getElementById('ai-shortform-count').textContent = String(aiShortformCount);
    document.getElementById('ai-count').textContent = String(aiCount);
    document.getElementById('real-count').textContent = String(realCount);
    document.getElementById('longform-count').textContent = String(longformCount);
  }

  /* === NEW: compute regular shortform counts (scheduled) per country === */
  function computeShortformStats() {
    const stats = { total: 0, perMarket: {} };
    ['US','Korea','India','France','Japan','UK','Germany','Thailand'].forEach(m => { stats.perMarket[m] = 0; });

    for (const raw of Object.values(monthDataCache || {})) {
      const dayArr = Array.isArray(raw) ? raw : raw ? [raw] : [];
      dayArr.forEach(item => {
        if (!item || item.type !== 'shortform') return;
        const markets = dedupeMarketsCI((item.markets || []).map(toCanonicalMarket));
        if (markets.length === 0) {
          stats.total += 1;
        } else {
          markets.forEach(m => {
            stats.total += 1;
            if (stats.perMarket[m] != null) {
              stats.perMarket[m] += 1;
            }
          });
        }
      });
    }
    return stats;
  }

  function updateShortformPerMarketCounts() {
    const stats = computeShortformStats();
    const totalEl = document.getElementById('scheduled-shortform-total');
    if (totalEl) {
      totalEl.textContent = `${stats.total} post${stats.total === 1 ? '' : 's'}`;
    }

    const mapIds = {
      US: 'shortform-us-count',
      Korea: 'shortform-korea-count',
      India: 'shortform-india-count',
      France: 'shortform-france-count',
      Japan: 'shortform-japan-count',
      UK: 'shortform-uk-count',
      Germany: 'shortform-germany-count',
      Thailand: 'shortform-thailand-count'
    };

    Object.entries(mapIds).forEach(([market, id]) => {
      const el = document.getElementById(id);
      if (!el) return;
      const n = stats.perMarket[market] || 0;
      el.textContent = `${n}`;
    });
  }

  async function updateFolderCounts() {
    const month = currentDate.getMonth();
    if (month === 10) {
      document.getElementById('ready-count').textContent = '112 items';
      document.getElementById('posted-count').textContent = '0 items';
    } else {
      document.getElementById('ready-count').textContent = '0 items';
      document.getElementById('posted-count').textContent = '0 items';
    }

    const count = await getRealtimeVideoCount();
    updateAvailableVideoCountUI(count);
    updateShortformPerMarketCounts();
  }

  async function getRealtimeVideoCount() {
    console.log("Fetching real-time inventory from Storage...");
    const { data: videos, error } = await supabase
      .storage
      .from('ShortVideo')
      .list('', { limit: 2000 });

    if (error) {
      console.error('Error fetching storage list:', error);
      showNotification('âŒ Error: Could not read Storage list (RLS?)', 'error');
      return 0;
    }

    const videoFiles = (videos || []).filter(file => {
      const name = file.name ? file.name.toLowerCase() : '';
      return name !== '.emptyfolderplaceholder';
    });

    console.log(`Real-time count is: ${videoFiles.length}`);
    return videoFiles.length;
  }

  function updateAvailableVideoCountUI(count) {
    const countEl = document.getElementById('available-video-count');
    if (!countEl) return;

    if (count === 'N/A' || count === undefined) {
      countEl.textContent = 'N/A';
      return;
    }

    countEl.textContent = `${count} items`;
    if (count < 5) {
      countEl.style.background = 'var(--secondary)';
    } else {
      countEl.style.background = 'var(--primary)';
    }
  }

  function getUsedFilenames(currentActivityId) {
    const used = new Set();
 
    Object.values(monthDataCache || {}).forEach(dayData => {
        const activities = Array.isArray(dayData) ? dayData : (dayData ? [dayData] : []);
        
        activities.forEach(act => {
        
            if (act && act.fileName && act.id !== currentActivityId) {
                used.add(act.fileName);
            }
        });
    });
    
    return used;
  }

  async function openVideoPicker() {
    const modal = document.getElementById('video-picker-modal');
    const container = document.getElementById('video-list-container');
    const searchInput = document.getElementById('video-search');
  
    searchInput.value = '';
    
    modal.style.display = 'flex';
    container.innerHTML = '<div style="text-align:center; margin-top:20px;"><i class="fas fa-spinner fa-spin"></i> Loading Library...</div>';

    try {
      const type = document.getElementById('content-type').value;
      const currentActivityId = document.getElementById('edit-activity-id').value; 
      
      let bucket = "ShortForm"; 
      if (type === 'ai-shortform') bucket = "ShortVideo"; 

      const res = await fetch(`${LIST_VIDEOS_WEBHOOK_URL}?bucket=${bucket}`);
      if (!res.ok) throw new Error(`API Error: ${res.status}`);
      
      const allFiles = await res.json();

      const usedFilenames = getUsedFilenames(currentActivityId);
      
      const availableFiles = allFiles.filter(file => !usedFilenames.has(file.name));
     
      renderVideoList(availableFiles);
      
      searchInput.onkeyup = (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = availableFiles.filter(f => f.name.toLowerCase().includes(term));
        renderVideoList(filtered);
      };

    } catch (err) {
      container.innerHTML = `<div style="color:red; text-align:center;">Error loading videos.<br>${err.message}</div>`;
      console.error(err);
    }
  }

  function renderVideoList(files) {
    const container = document.getElementById('video-list-container');
    container.innerHTML = '';

    if(!files || files.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">No videos found.</div>';
        return;
    }

    files.forEach(file => {
      if(file.name === '.emptyFolderPlaceholder') return;
   
      const sizeBytes = file.size || (file.metadata && file.metadata.size) || 0;
      const sizeMB = (sizeBytes / 1024 / 1024).toFixed(2);

      const div = document.createElement('div');
     
      div.style.cssText = "padding:12px; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:background 0.2s;";
      div.onmouseover = () => div.style.background = "#f8f9fa";
      div.onmouseout = () => div.style.background = "white";

      div.innerHTML = `
        <div style="pointer-events:none;">
            <i class="fas fa-file-video" style="color:#666; margin-right:10px;"></i>
            <strong>${file.name}</strong>
            <div style="font-size:0.8rem; color:#999; margin-left:26px; margin-top:2px;">Size: ${sizeMB} MB</div>
        </div>
        <button class="btn btn-secondary" style="padding:4px 12px; font-size:0.8rem; pointer-events:none;">Select</button>
      `;
   
      div.onclick = () => selectVideo(file.name);
      
      container.appendChild(div);
    });
  }

  function selectVideo(filename) {
    document.getElementById('selected-filename').value = filename;
    
    const previewBox = document.getElementById('preview-container');
    const player = document.getElementById('video-player-preview');
 
    const type = document.getElementById('content-type').value;
    const fullUrl = getFileUrl(filename, type);
    
    player.src = fullUrl;
    previewBox.style.display = 'block';
    
    document.getElementById('video-picker-modal').style.display = 'none';
  }

  document.getElementById('open-picker-btn').addEventListener('click', openVideoPicker);
  document.getElementById('close-picker').addEventListener('click', () => document.getElementById('video-picker-modal').style.display = 'none');
  document.getElementById('cancel-picker').addEventListener('click', () => document.getElementById('video-picker-modal').style.display = 'none');
  
  document.getElementById('clear-video-btn').addEventListener('click', () => {
    document.getElementById('selected-filename').value = '';
    document.getElementById('preview-container').style.display = 'none';
    document.getElementById('video-player-preview').src = '';
  });

  document.getElementById('content-type').addEventListener('change', function() {
      const val = this.value;
      document.getElementById('ai-prompt-section').style.display = (val === 'ai-carousel') ? 'block' : 'none';
      document.getElementById('manual-video-section').style.display = (val.includes('shortform') || val === 'longform') ? 'block' : 'none';
  });
</script>
</body>
</html>
