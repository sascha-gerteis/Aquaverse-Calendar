<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Enhanced Social Media Analytics Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">

    <style>
       
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px 25px;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .logo i {
            font-size: 28px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: var(--transition);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
        }

        .btn-secondary {
            background-color: white;
            color: var(--dark);
            border: 1px solid var(--light-gray);
        }

        .btn-secondary:hover {
            background-color: var(--light-gray);
        }

        .filters-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray);
            text-transform: uppercase;
        }

        .filter-select {
            padding: 10px 12px;
            border-radius: var(--border-radius);
            border: 1px solid var(--light-gray);
            background-color: white;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .filter-select:hover {
            border-color: var(--primary);
        }

        .active-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--light-gray);
        }

        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background-color: var(--primary);
            color: white;
            border-radius: 20px;
            font-size: 12px;
        }

        .filter-tag i {
            cursor: pointer;
            font-size: 10px;
        }

        .filter-tag i:hover {
            opacity: 0.8;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: var(--primary);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-card.impressions::before { background-color: #4361ee; }
        .stat-card.reach::before { background-color: #4cc9f0; }
        .stat-card.engagement::before { background-color: #f72585; }
        .stat-card.rate::before { background-color: #f8961e; }
        .stat-card.clicks::before { background-color: #4895ef; }
        .stat-card.followers::before { background-color: #7209b7; }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .stat-card.impressions .stat-icon { background-color: #4361ee; }
        .stat-card.reach .stat-icon { background-color: #4cc9f0; }
        .stat-card.engagement .stat-icon { background-color: #f72585; }
        .stat-card.rate .stat-icon { background-color: #f8961e; }
        .stat-card.clicks .stat-icon { background-color: #4895ef; }
        .stat-card.followers .stat-icon { background-color: #7209b7; }

        .stat-title {
            font-size: 13px;
            color: var(--gray);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark);
        }

        .stat-change {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-change.positive {
            color: #28a745;
        }

        .stat-change.negative {
            color: var(--danger);
        }

        .comparison-text {
            font-size: 11px;
            color: var(--gray);
            margin-top: 5px;
        }

        .content-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .platform-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .platform-tab {
            padding: 10px 20px;
            background-color: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid var(--light-gray);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .platform-tab.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .platform-tab:hover:not(.active) {
            background-color: var(--light);
            border-color: var(--primary);
        }

        .region-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .region-card {
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            padding: 20px;
            transition: var(--transition);
        }

        .region-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .region-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .region-name {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .region-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .region-metric {
            display: flex;
            flex-direction: column;
        }

        .region-metric-label {
            font-size: 11px;
            color: var(--gray);
            text-transform: uppercase;
        }

        .region-metric-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }

        .pages-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .pages-table th,
        .pages-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }

        .pages-table th {
            background-color: var(--light);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: var(--gray);
        }

        .pages-table tr:hover {
            background-color: var(--light);
        }

        .page-name {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .page-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 700;
        }

        .platform-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .platform-badge.instagram {
            background-color: #fce4ec;
            color: #E1306C;
        }

        .platform-badge.facebook {
            background-color: #e3f2fd;
            color: #4267B2;
        }

        .platform-badge.twitter {
            background-color: #e1f5fe;
            color: #1DA1F2;
        }

        .platform-badge.linkedin {
            background-color: #e0f2f1;
            color: #0077B5;
        }

        .platform-badge.tiktok {
            background-color: #fce4ec;
            color: #000000;
        }

        .platform-badge.youtube {
            background-color: #ffebee;
            color: #FF0000;
        }

        .region-badge {
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            background-color: var(--light-gray);
            color: var(--dark);
            font-weight: 600;

            white-space: nowrap; 
            display: inline-block;
        }

        .performance-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }

        .performance-indicator.high {
            color: #28a745;
        }

        .performance-indicator.medium {
            color: var(--warning);
        }

        .performance-indicator.low {
            color: var(--gray);
        }

        .posts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .post-card {
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: var(--transition);
            background-color: white;
        }

        .post-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .post-image {
            height: 200px;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .post-platform-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .post-platform-overlay.instagram {
            background-color: rgba(225, 48, 108, 0.9);
            color: white;
        }

        .post-platform-overlay.facebook {
            background-color: rgba(66, 103, 178, 0.9);
            color: white;
        }

        .post-region-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            background-color: rgba(255, 255, 255, 0.95);
            color: var(--dark);
        }

        .post-content {
            padding: 18px;
        }

        .post-title {
            font-weight: 600;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            font-size: 15px;
            line-height: 1.4;
        }

        .post-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .post-date {
            font-size: 12px;
            color: var(--gray);
        }

        .post-page {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
        }

        .post-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--light-gray);
        }

        .metric {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .metric-label {
            font-size: 10px;
            color: var(--gray);
            text-transform: uppercase;
        }

        .metric-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .metric-value i {
            color: var(--primary);
            font-size: 12px;
        }

        .engagement-rate-bar {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--light-gray);
        }

        .engagement-rate-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .engagement-rate-value {
            font-weight: 700;
            color: var(--primary);
        }

        .progress-bar {
            height: 6px;
            background-color: var(--light-gray);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background-color: var(--light);
            border-radius: var(--border-radius);
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .comparison-card {
            background-color: white;
            border: 2px solid var(--light-gray);
            border-radius: var(--border-radius);
            padding: 20px;
            transition: var(--transition);
        }

        .comparison-card:hover {
            border-color: var(--primary);
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .comparison-title {
            font-size: 16px;
            font-weight: 600;
        }

        .comparison-metrics {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .comparison-metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comparison-metric-name {
            font-size: 13px;
            color: var(--gray);
        }

        .comparison-metric-value {
            font-size: 16px;
            font-weight: 700;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 16px;
        }

        @media (max-width: 1200px) {
            .summary-stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .filters-section {
                grid-template-columns: 1fr;
            }

            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .region-breakdown {
                grid-template-columns: 1fr;
            }

            .platform-tabs {
                justify-content: flex-start;
                overflow-x: auto;
            }

            .posts-grid {
                grid-template-columns: 1fr;
            }

            .pages-table {
                font-size: 12px;
            }

            .pages-table th,
            .pages-table td {
                padding: 10px;
            }
        }

        @media (max-width: 480px) {
            .summary-stats {
                grid-template-columns: 1fr;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        .posts-scroll-container {
            max-height: 800px; 
            overflow-y: auto;  
            padding-right: 10px; 
        }

        .posts-scroll-container::-webkit-scrollbar {
            width: 8px;
        }
        .posts-scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .posts-scroll-container::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }
        .posts-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }

        .platform-tab {
            cursor: pointer;
            user-select: none;
        }

        /* ===================================== */
        /* TABLET (iPad 1024px)                  */
        /* ===================================== */
        @media (max-width: 1024px) {
            .container { padding: 15px; }
            header { padding: 15px 20px; }

            .stat-card,
            .region-card,
            .comparison-card,
            .post-card,
            .content-section {
                padding: 15px !important;
            }

            .summary-stats { grid-template-columns: repeat(3, 1fr); }
            .posts-grid { grid-template-columns: repeat(2, 1fr); }
            .comparison-grid { grid-template-columns: repeat(2, 1fr); }

            .pages-table {
            display: block;
            overflow-x: auto;
            width: 100%;
        }
        }

        /* ===================================== */
        /* LARGE PHONES / SMALL TABLETS (768px)  */
        /* ===================================== */
        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .filters-section {
                grid-template-columns: 1fr !important;
            }

            .summary-stats { grid-template-columns: repeat(2, 1fr); }
            .region-breakdown { grid-template-columns: 1fr; }
            .posts-grid { grid-template-columns: 1fr; }
            .comparison-grid { grid-template-columns: 1fr; }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .post-image { height: 180px; }
            .content-section { padding: 15px; }
        }

        /* ===================================== */
        /* MOBILE FIX (580px)  */
        /* ===================================== */
        @media (max-width: 580px) {

        
            .pages-table tbody tr td:first-child,
            .pages-table thead tr th:first-child {
                position: sticky;
                left: 0;
                background: #ffffff;
                z-index: 10;
                min-width: 160px !important; 
                max-width: 160px;
                border-right: 2px solid #f0f0f0; 
                box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            }

            .page-avatar {
                width: 32px !important;
                height: 32px !important;
                font-size: 12px !important;
                flex-shrink: 0; 
                margin-right: 8px;
            }

            .page-name {
                display: flex;
                align-items: center;
                gap: 0; 
            }
            
            .page-name > div {
                overflow: hidden; 
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .page-name > div > div:first-child {
                font-size: 11px !important;
                font-weight: 700;
                line-height: 1.3;
                white-space: normal; 
                margin-bottom: 2px;
            }

            .page-name > div > div:last-child {
                font-size: 9px !important;
                color: #888;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis; 
            }

            
            .pages-table th,
            .pages-table td {
                padding: 10px 8px !important; 
                font-size: 11px !important;
                vertical-align: middle; 
                white-space: nowrap; 
            }

            .platform-badge {
                padding: 3px 8px !important;
            }
            
        
            .pages-table {
                margin-top: 0;
                border-radius: 0;
            }
        }

        /* SMALL MOBILE (480px) */ 
        /* ===================================== */
        @media (max-width: 480px) {
            .summary-stats { grid-template-columns: 1fr; }
            .container { padding: 10px; }

            .btn { padding: 8px 14px; font-size: 12px; }
            .section-title { font-size: 18px; }
            .post-image { height: 150px; }

            .stat-card,
            .region-card,
            .comparison-card {
                padding: 12px !important;
            }
        }
    </style>

</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div class="logo">
                    <i class="fas fa-chart-line"></i>
                    <span>Social Media Analytics</span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary">
                        <i class="fas fa-download"></i> Export Report
                    </button>
                    <button class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                </div>
            </div>

            <div class="filters-section">
                <div class="filter-group">
                    <label class="filter-label">Time Range</label>
                    <select id="time-range" class="filter-select" onchange="updateDashboard()">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="365">Last year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Region</label>
                    <select id="region-filter" class="filter-select" onchange="updateDashboard()">
                        <option value="all">All Regions</option>
                        <option value="north-america">North America</option>
                        <option value="europe">Europe</option>
                        <option value="asia-pacific">Asia Pacific</option>
                        <option value="latin-america">Latin America</option>
                        <option value="middle-east">Middle East & Africa</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Platform</label>
                    <select id="platform-filter" class="filter-select" onchange="updateDashboard()">
                        <option value="all">All Platforms</option>
                        <option value="facebook">Facebook</option>
                        <option value="instagram">Instagram</option>
                        <option value="tiktok">TikTok</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Page/Account</label>
                    <select id="page-filter" class="filter-select" onchange="updateDashboard()">
                        <option value="all">All Pages</option>
                        <option value="main">Main Brand Account</option>
                        <option value="usa">USA Regional</option>
                        <option value="europe">Europe Regional</option>
                        <option value="asia">Asia Pacific Regional</option>
                        <option value="support">Customer Support</option>
                    </select>
                </div>

            </div>

            <div class="active-filters" id="active-filters">
                <!-- Active filters will appear here -->
            </div>
        </header>

        <div class="summary-stats" id="summary-stats" style="margin-bottom: 5px;">
            <div class="stat-card impressions">
                <div class="stat-header">
                    <div class="stat-icon"><i class="fas fa-eye"></i></div>
                </div>
                <div class="stat-title">Total Impressions</div>
                <div class="stat-value" id="total-impressions">0</div> <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i> <span>18.5%</span>
                </div>
                <div class="comparison-text">vs previous period</div>
            </div>

            <div class="stat-card reach">
                <div class="stat-header">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                </div>
                <div class="stat-title">Total Followers</div> <div class="stat-value" id="total-followers">0</div> <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i> <span>12.3%</span>
                </div>
                <div class="comparison-text">Across all platforms</div>
            </div>

            <div class="stat-card engagement">
                <div class="stat-header">
                    <div class="stat-icon"><i class="fas fa-heart"></i></div>
                </div>
                <div class="stat-title">Total Engagements</div>
                <div class="stat-value" id="total-engagement">0</div> <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i> <span>24.7%</span>
                </div>
                <div class="comparison-text">vs previous period</div>
            </div>

            <div class="stat-card rate">
                <div class="stat-header">
                    <div class="stat-icon"><i class="fas fa-percentage"></i></div>
                </div>
                <div class="stat-title">Avg. Engagement Rate</div>
                <div class="stat-value" id="avg-engagement-rate">0%</div> <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i> <span>3.1%</span>
                </div>
                <div class="comparison-text">Average per account</div>
            </div>

            <div class="stat-card clicks">
                <div class="stat-header">
                    <div class="stat-icon"><i class="fas fa-mouse-pointer"></i></div>
                </div>
                <div class="stat-title">Total Clicks</div>
                <div class="stat-value">0</div> <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i> <span>15.8%</span>
                </div>
                <div class="comparison-text">vs previous period</div>
            </div>

            <div class="stat-card followers">
                <div class="stat-header">
                    <div class="stat-icon"><i class="fas fa-user-plus"></i></div>
                </div>
                <div class="stat-title">New Followers</div>
                <div class="stat-value">0</div> <div class="stat-change negative">
                    <i class="fas fa-arrow-down"></i> <span>2.4%</span>
                </div>
                <div class="comparison-text">vs previous period</div>
            </div>
        </div>

        <div id="data-period-label" style="text-align: right; font-size: 11px; color: #8898aa; margin-top: 5px; margin-bottom: 20px; font-style: italic;">
            <i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
        </div>

        <div class="content-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-globe-americas"></i>
                    Performance by Region
                </h2>
            </div>

            <div class="region-breakdown" id="region-container">
            </div>
                
    </div>

    <div class="content-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-layer-group"></i>
                All Pages & Accounts
            </h2>
            <div class="section-controls">
                <select class="filter-select" id="account-filter" onchange="filterAccountTable()">
                    <option value="all">Show: All</option>
                    <option value="top10">Show: Top 10</option>
                    <option value="bottom10">Show: Bottom 10</option>
                </select>
            </div>
        </div>
        
            <table class="pages-table">
                <thead>
                    <tr>
                        <th>Page/Account</th>
                        <th>Platform</th>
                        <th>Region</th>
                        <th>Followers</th>
                        <th>Impressions</th>
                        <th>Engagement</th>
                        <th>Eng. Rate</th>
                        <th>Performance</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <div class="page-name">
                                <div class="page-avatar">MB</div>
                                <div>
                                    <div style="font-weight: 600;">Main Brand Account</div>
                                    <div style="font-size: 12px; color: var(--gray);">@mainbrand</div>
                                </div>
                            </div>
                        </td>
                        <td><span class="platform-badge instagram"><i class="fab fa-instagram"></i> Instagram</span></td>
                        <td><span class="region-badge">Global</span></td>
                        <td>1.2M</td>
                        <td>945K</td>
                        <td>124K</td>
                        <td>6.8%</td>
                        <td><span class="performance-indicator high"><i class="fas fa-arrow-up"></i> High</span></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="page-name">
                                <div class="page-avatar">US</div>
                                <div>
                                    <div style="font-weight: 600;">USA Regional Page</div>
                                    <div style="font-size: 12px; color: var(--gray);">@brandusa</div>
                                </div>
                            </div>
                        </td>
                        <td><span class="platform-badge facebook"><i class="fab fa-facebook"></i> Facebook</span></td>
                        <td><span class="region-badge">North America</span></td>
                        <td>875K</td>
                        <td>786K</td>
                        <td>98K</td>
                        <td>6.2%</td>
                        <td><span class="performance-indicator high"><i class="fas fa-arrow-up"></i> High</span></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="page-name">
                                <div class="page-avatar">EU</div>
                                <div>
                                    <div style="font-weight: 600;">Europe Regional</div>
                                    <div style="font-size: 12px; color: var(--gray);">@brandeu</div>
                                </div>
                            </div>
                        </td>
                        <td><span class="platform-badge instagram"><i class="fab fa-instagram"></i> Instagram</span></td>
                        <td><span class="region-badge">Europe</span></td>
                        <td>654K</td>
                        <td>589K</td>
                        <td>72K</td>
                        <td>5.9%</td>
                        <td><span class="performance-indicator high"><i class="fas fa-arrow-up"></i> High</span></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="page-name">
                                <div class="page-avatar">AP</div>
                                <div>
                                    <div style="font-weight: 600;">Asia Pacific Account</div>
                                    <div style="font-size: 12px; color: var(--gray);">@brandasia</div>
                                </div>
                            </div>
                        </td>
                        <td><span class="platform-badge tiktok"><i class="fab fa-tiktok"></i> TikTok</span></td>
                        <td><span class="region-badge">Asia Pacific</span></td>
                        <td>432K</td>
                        <td>412K</td>
                        <td>54K</td>
                        <td>5.4%</td>
                        <td><span class="performance-indicator medium"><i class="fas fa-minus"></i> Medium</span></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="page-name">
                                <div class="page-avatar">CS</div>
                                <div>
                                    <div style="font-weight: 600;">Customer Support</div>
                                    <div style="font-size: 12px; color: var(--gray);">@brandsupport</div>
                                </div>
                            </div>
                        </td>
                        <td><span class="platform-badge twitter"><i class="fab fa-twitter"></i> Twitter</span></td>
                        <td><span class="region-badge">Global</span></td>
                        <td>298K</td>
                        <td>245K</td>
                        <td>32K</td>
                        <td>4.8%</td>
                        <td><span class="performance-indicator medium"><i class="fas fa-minus"></i> Medium</span></td>
                    </tr>
                    <tr>
                        <td>
                            <div class="page-name">
                                <div class="page-avatar">LA</div>
                                <div>
                                    <div style="font-weight: 600;">Latin America Page</div>
                                    <div style="font-size: 12px; color: var(--gray);">@brandlatam</div>
                                </div>
                            </div>
                        </td>
                        <td><span class="platform-badge facebook"><i class="fab fa-facebook"></i> Facebook</span></td>
                        <td><span class="region-badge">Latin America</span></td>
                        <td>187K</td>
                        <td>198K</td>
                        <td>28K</td>
                        <td>5.1%</td>
                        <td><span class="performance-indicator medium"><i class="fas fa-minus"></i> Medium</span></td>
                    </tr>
                </tbody>
            </table>
        
            
    </div>

    <div class="content-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-fire"></i>
                Top Performing Posts
            </h2>
            <div class="section-controls">
                <button class="btn btn-secondary">
                    <i class="fas fa-filter"></i> More Filters
                </button>
            </div>
        </div>

        <div class="platform-tabs">
            <div class="platform-tab active" onclick="filterPostsByTab('all', this)">
                <i class="fas fa-globe"></i> <span>All Platforms</span>
            </div>
            <div class="platform-tab" onclick="filterPostsByTab('instagram', this)">
                <i class="fab fa-instagram"></i> <span>Instagram</span>
            </div>
            <div class="platform-tab" onclick="filterPostsByTab('facebook', this)">
                <i class="fab fa-facebook"></i> <span>Facebook</span>
            </div>
            <div class="platform-tab" onclick="filterPostsByTab('tiktok', this)">
                <i class="fab fa-tiktok"></i> <span>TikTok</span>
            </div>
        </div>

        <div class="posts-scroll-container">
            <div class="posts-grid" id="posts-grid">
                </div>
        </div>
    </div>

    <div class="content-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-chart-bar"></i>
                Platform Comparison
            </h2>
        </div>

        <div class="comparison-grid" id="platform-comparison-grid">
            <div class="comparison-card">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fab fa-instagram" style="color: #E1306C;"></i> Instagram
                    </div>
                    <span class="performance-indicator high">
                        <i class="fas fa-arrow-up"></i> +18%
                    </span>
                </div>
                <div class="comparison-metrics">
                    <div class="comparison-metric-row">
                        <span class="comparison-metric-name">Total Posts</span>
                        <span class="comparison-metric-value">156</span>
                    </div>
                    <div class="comparison-metric-row">
                        <span class="comparison-metric-name">Avg Engagement</span>
                        <span class="comparison-metric-value">8.4K</span>
                    </div>
                    <div class="comparison-metric-row">
                        <span class="comparison-metric-name">Engagement Rate</span>
                        <span class="comparison-metric-value">6.2%</span>
                    </div>
                    <div class="comparison-metric-row">
                        <span class="comparison-metric-name">Best Time</span>
                        <span class="comparison-metric-value">2-4 PM</span>
                    </div>
                </div>
            </div>

            <div class="comparison-card">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fab fa-facebook" style="color: #4267B2;"></i> Facebook
                    </div>
                    <span class="performance-indicator high">
                        <i class="fas fa-arrow-up"></i> +14%
                    </span>
                </div>
                <div class="comparison-metrics">
                    <div class="comparison-metric-row">
                        <span class="comparison-metric-name">Total Posts</span>
                        <span class="comparison-metric-value">142</span>
                    </div>
                    <div class="comparison-metric-row">
                        <span class="comparison-metric-name">Avg Engagement</span>
                        <span class="comparison-metric-value">12.1K</span>
                    </div>
                    <div class="comparison-metric-row">
                        <span class="comparison-metric-name">Engagement Rate</span>
                        <span class="comparison-metric-value">5.8%</span>
                    </div>
                    <div class="comparison-metric-row">
                        <span class="comparison-metric-name">Best Time</span>
                        <span class="comparison-metric-value">12-2 PM</span>
                    </div>
                </div>
            </div>

            <div class="comparison-card">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fab fa-twitter" style="color: #1DA1F2;"></i> Twitter
                    </div>
                    <span class="performance-indicator medium">
                        <i class="fas fa-arrow-up"></i> +8%
                    </span>
                </div>
                <div class="comparison-metrics">
                    <div class="comparison-metric-row">
                        <span class="comparison-metric-name">Total Posts</span>
                        <span class="comparison-metric-value">289</span>
                    </div>
                    <div class="comparison-metric-row">
                        <span class="comparison-metric-name">Avg Engagement</span>
                        <span class="comparison-metric-value">3.2K</span>
                    </div>
                    <div class="comparison-metric-row">
                        <span class="comparison-metric-name">Engagement Rate</span>
                        <span class="comparison-metric-value">4.1%</span>
                    </div>
                    <div class="comparison-metric-row">
                        <span class="comparison-metric-name">Best Time</span>
                        <span class="comparison-metric-value">9-11 AM</span>
                    </div>
                </div>
            </div>

            <div class="comparison-card">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fab fa-linkedin" style="color: #0077B5;"></i> LinkedIn
                    </div>
                    <span class="performance-indicator medium">
                        <i class="fas fa-arrow-up"></i> +11%
                    </span>
                </div> <div class="comparison-metrics">
                    <div class="comparison-metric-row">
                        <span class="comparison-metric-name">Total Posts</span>
                        <span class="comparison-metric-value">87</span>
                    </div>
                    <div class="comparison-metric-row">
                        <span class="comparison-metric-name">Avg Engagement</span>
                        <span class="comparison-metric-value">5.6K</span>
                    </div>
                    <div class="comparison-metric-row">
                        <span class="comparison-metric-name">Engagement Rate</span>
                        <span class="comparison-metric-value">5.4%</span>
                    </div>
                    <div class="comparison-metric-row">
                        <span class="comparison-metric-name">Best Time</span>
                        <span class="comparison-metric-value">8-10 AM</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>

    const SUPABASE_URL = 'https://merpsvkfmjbugrgnwwlq.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_HTUvRzrVGDFbqLxrUCCMZQ_tY_oW4zJ';
    
   let supabase;
    try {
        if (window.supabase) supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch(e) { console.error('Supabase Init Error:', e); }

    let rawData = { accounts: [], posts: [], snapshots: [] };
    let currentFilteredPosts = []; 

    // ==========================================
    // 2. INITIALIZATION
    // ==========================================
    async function initDashboard() {
        if (!supabase) return alert('Supabase Client Error');
        await fetchAllData();
        populatePageFilter(); 
        updateDashboard(); 
    }

    // ==========================================
    // 3. DATA FETCHING
    // ==========================================
    async function fetchAllData() {
        try {
            const { data: acc } = await supabase.from('social_accounts').select('*').not('external_id', 'is', null);
            rawData.accounts = acc || [];

            const { data: posts } = await supabase.from('posts').select(`*, social_accounts(region, platform, name)`).order('posted_at', { ascending: false }).limit(500);
            rawData.posts = posts || [];

            const { data: snaps } = await supabase.from('daily_snapshots').select('*').order('recorded_at', { ascending: true });
            rawData.snapshots = snaps || [];

            renderDataPeriod(rawData.snapshots);
        } catch (err) { console.error('Fetch Error:', err); }
    }

    // ==========================================
    // 4. MASTER FILTER LOGIC
    // ==========================================
    function updateDashboard() {
        const filter = {
            time: parseInt(document.getElementById('time-range').value) || 30,
            region: document.getElementById('region-filter').value,
            platform: document.getElementById('platform-filter').value,
            pageId: document.getElementById('page-filter').value,
            contentType: 'all', 
            sort: 'engagement'
        };

        let filteredAccounts = rawData.accounts.filter(acc => {
            if (filter.region !== 'all' && acc.region !== filter.region) return false;
            if (filter.platform !== 'all' && acc.platform !== filter.platform) return false;
            if (filter.pageId !== 'all' && String(acc.id) !== String(filter.pageId)) return false;
            return true;
        });

        const allowedAccountIds = new Set(filteredAccounts.map(acc => acc.id));
        let filteredPosts = rawData.posts.filter(post => {
            if (!allowedAccountIds.has(post.account_id)) return false;
            
            const type = (post.media_type || 'IMAGE').toUpperCase();
            if (filter.contentType === 'VIDEO' && !['VIDEO', 'REELS'].includes(type)) return false;
            if (filter.contentType === 'IMAGE' && !['IMAGE', 'PHOTO', 'CAROUSEL_ALBUM'].includes(type)) return false;
            
            return true;
        });

        const pastDate = new Date();
        pastDate.setDate(pastDate.getDate() - filter.time);
        const pastDateStr = pastDate.toISOString().split('T')[0];
        let historyMap = {};
        rawData.snapshots.forEach(snap => {
            if (allowedAccountIds.has(snap.account_id)) {
                const snapDate = snap.recorded_at.split('T')[0];
                if (snapDate <= pastDateStr) historyMap[snap.account_id] = snap; 
            }
        });

        currentFilteredPosts = filteredPosts;

        renderSummaryCards(filteredAccounts, historyMap, filter.time);
        filterAccountTable(); 
        
        const activeTab = document.querySelector('.platform-tab.active');
        const activePlatform = activeTab ? activeTab.innerText.trim().toLowerCase().replace('all platforms', 'all') : 'all';
        filterPostsByTab(activePlatform, null); 

        renderRegionStats(filteredAccounts);
        renderPlatformComparison(filteredAccounts, filteredPosts); 
    }

    // ==========================================
    // 5. TOP POSTS & TABS LOGIC
    // ==========================================
    window.filterPostsByTab = function(platform, element) {
        if(element) {
            document.querySelectorAll('.platform-tab').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }

        const source = currentFilteredPosts || [];
        let postsToShow = [];

        if (platform === 'all') {

            const fb = source.filter(p => p.platform === 'facebook').sort((a,b) => b.likes - a.likes).slice(0, 10);
            const ig = source.filter(p => p.platform === 'instagram').sort((a,b) => b.likes - a.likes).slice(0, 10);
            const tt = source.filter(p => p.platform === 'tiktok').sort((a,b) => b.likes - a.likes).slice(0, 10);
            
            postsToShow = [...fb, ...ig, ...tt];

            postsToShow.sort((a,b) => b.likes - a.likes);
        } else {

            postsToShow = source
                .filter(p => p.platform === platform)
                .sort((a,b) => b.likes - a.likes)
                .slice(0, 10);
        }

        renderPostGrid(postsToShow);
    }

    function renderPostGrid(posts) {
        const grid = document.getElementById('posts-grid');
        if(!grid) return;
        grid.innerHTML = '';
        
        if (posts.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999"><i class="fas fa-search" style="font-size:24px;margin-bottom:10px"></i><br>No posts found matching criteria</div>';
            return;
        }

        posts.forEach(post => {
            const acc = post.social_accounts;
            const date = new Date(post.posted_at).toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
   
            let bgImage = 'linear-gradient(45deg, #f3f4f6, #e5e7eb)';
            let playIcon = '';
            
            if (post.image_url && post.image_url.startsWith('http')) {
                bgImage = `url('${post.image_url}')`;
            } 
            
            const type = (post.media_type || '').toUpperCase();
            if (['VIDEO', 'REELS'].includes(type) || post.platform === 'tiktok') {
                playIcon = '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:40px;color:white;opacity:0.8;text-shadow:0 2px 4px rgba(0,0,0,0.5);"><i class="fas fa-play-circle"></i></div>';
            }

            const card = `
                <div class="post-card">
                    <div class="post-image" style="background-image: ${bgImage};">
                        <span class="post-platform-overlay" style="background:${getPlatformColor(acc.platform).text}; color:white"><i class="${getPlatformIcon(acc.platform)}"></i> ${capitalize(acc.platform)}</span>
                        ${playIcon}
                    </div>
                    <div class="post-content">
                        <h4 class="post-title" title="${post.caption}">${post.caption ? post.caption.substring(0, 60)+(post.caption.length>60?'...':'') : 'No Caption'}</h4>
                        <div class="post-info"><span class="post-date">${date}</span><span class="post-page" style="color:${getPlatformColor(acc.platform).text}">${acc.name}</span></div>
                        <div class="post-metrics">
                            <div class="metric"><span class="metric-label">Likes</span><span class="metric-value"><i class="fas fa-heart"></i> ${formatNumber(post.likes)}</span></div>
                            <div class="metric"><span class="metric-label">Comments</span><span class="metric-value"><i class="fas fa-comment"></i> ${formatNumber(post.comments)}</span></div>
                            <div class="metric"><span class="metric-label">Shares</span><span class="metric-value"><i class="fas fa-share"></i> ${formatNumber(post.shares)}</span></div>
                        </div>
                        <div class="engagement-rate-bar"><a href="${post.post_url}" target="_blank" style="text-decoration:none;font-size:12px;color:var(--primary);font-weight:600;">View Post <i class="fas fa-external-link-alt"></i></a></div>
                    </div>
                </div>
            `;
            grid.innerHTML += card;
        });
    }

    // ==========================================
    // 6. ACCOUNT TABLE FILTER
    // ==========================================
    window.filterAccountTable = function() {
        const filterType = document.getElementById('account-filter').value;
        let dataToShow = typeof currentFilteredAccounts !== 'undefined' ? [...currentFilteredAccounts] : []; 
        if(dataToShow.length === 0 && rawData.accounts.length > 0) dataToShow = [...rawData.accounts]; // Fallback

        if (filterType === 'top10') {
            dataToShow.sort((a, b) => (b.followers_count||0) - (a.followers_count||0));
            dataToShow = dataToShow.slice(0, 10);
        } else if (filterType === 'bottom10') {
            dataToShow.sort((a, b) => (a.followers_count||0) - (b.followers_count||0));
            dataToShow = dataToShow.slice(0, 10);
        } else {
            dataToShow.sort((a, b) => (b.followers_count||0) - (a.followers_count||0));
        }
        renderAccountTable(dataToShow, window.currentHistoryMap);
    }

    // ==========================================
    // 7. RENDER OTHER SECTIONS
    // ==========================================
    function renderSummaryCards(accounts, historyMap, days) {
        let curr = { fol: 0, imp: 0, eng: 0, click: 0, new: 0 };
        let prev = { fol: 0, imp: 0, eng: 0, click: 0 };

        accounts.forEach(acc => {
            const fol = acc.followers_count||0;
            curr.fol += fol;
            curr.imp += (acc.impressions||0);
            curr.eng += (acc.engagement||0);
            curr.click += (acc.clicks||0);

            const old = historyMap[acc.id] || {};
            const oldFol = old.followers_count || fol;
            prev.fol += oldFol;
            prev.imp += (old.impressions || acc.impressions);
            prev.eng += (old.engagement || acc.engagement);
            prev.click += (old.clicks || acc.clicks);
            curr.new += (fol - oldFol);
        });

        const calcGrowth = (c, p) => p > 0 ? ((c - p) / p) * 100 : 0;

        updateCardUI('total-impressions', curr.imp, calcGrowth(curr.imp, prev.imp));
        updateCardUI('total-followers', curr.fol, calcGrowth(curr.fol, prev.fol));
        updateCardUI('total-engagement', curr.eng, calcGrowth(curr.eng, prev.eng));
        updateCardBySelector('.stat-card.clicks', curr.click, calcGrowth(curr.click, prev.click));
        updateCardBySelector('.stat-card.followers', curr.new, 0); 

        const currRate = curr.fol > 0 ? ((curr.eng/curr.fol)*100) : 0;
        const prevRate = prev.fol > 0 ? ((prev.eng/prev.fol)*100) : 0;
        document.getElementById('avg-engagement-rate').innerText = currRate.toFixed(2) + '%';
        updatePercentUI(document.querySelector('.stat-card.rate'), calcGrowth(currRate, prevRate));
        document.querySelectorAll('.comparison-text').forEach(el => el.innerText = `vs ${days} days ago`);

        window.currentFilteredAccounts = accounts;
        window.currentHistoryMap = historyMap;
    }

    function renderAccountTable(accounts, historyMap) {
        const tbody = document.querySelector('.pages-table tbody');
        if(!tbody) return;
        tbody.innerHTML = '';
        accounts.sort((a,b) => (b.followers_count||0) - (a.followers_count||0));

        accounts.forEach(acc => {
            const old = historyMap && historyMap[acc.id] ? historyMap[acc.id] : {};
            const growth = (acc.followers_count||0) - (old.followers_count || acc.followers_count||0);
            const engRate = (acc.followers_count||0) > 0 ? ((acc.engagement/acc.followers_count)*100).toFixed(2) : '0.00';
            
            const initial = getCountryCode(acc); 

            let growthHtml = '';
            if(growth > 0) growthHtml = `<span style="color:#28a745; font-size:11px"><i class="fas fa-arrow-up"></i> ${formatNumber(growth)}</span>`;
            else if(growth < 0) growthHtml = `<span style="color:#dc3545; font-size:11px"><i class="fas fa-arrow-down"></i> ${formatNumber(Math.abs(growth))}</span>`;

            let statusHtml = '<span class="performance-indicator low"><i class="fas fa-minus"></i> No Data</span>';
            if ((acc.followers_count || 0) > 0) {
                statusHtml = '<span class="performance-indicator high"><i class="fas fa-check"></i> Active</span>';
            }

            const row = `<tr>
                <td>
                    <div class="page-name">
                        <div class="page-avatar" style="background:${getPlatformColor(acc.platform).bg}; color:${getPlatformColor(acc.platform).text}">${initial}</div>
                        <div><div style="font-weight:600">${acc.name}</div><div style="font-size:12px;color:gray">${acc.handle||''} ${growthHtml}</div></div>
                    </div>
                </td>
                <td><span class="platform-badge" style="background:${getPlatformColor(acc.platform).bg}; color:${getPlatformColor(acc.platform).text}"><i class="${getPlatformIcon(acc.platform)}"></i> ${capitalize(acc.platform)}</span></td>
                <td><span class="region-badge">${formatRegion(acc.region)}</span></td>
                <td>${formatNumber(acc.followers_count)}</td>
                <td>${formatNumber(acc.impressions)}</td>
                <td>${formatNumber(acc.engagement)}</td>
                <td>${engRate}%</td>
                <td>${statusHtml}</td> </tr>`;
            tbody.innerHTML += row;
        });
    }

    function renderRegionStats(accounts) {
        const container = document.getElementById('region-container');
        if(!container) return;
        container.innerHTML = '';
        const regions = {};
        accounts.forEach(acc => {
            const r = acc.region || 'global';
            if (!regions[r]) regions[r] = { name: r, imp: 0, eng: 0, fol: 0, count: 0 };
            regions[r].imp += (acc.impressions||0);
            regions[r].eng += (acc.engagement||0);
            regions[r].fol += (acc.followers_count||0);
            regions[r].count++;
        });
        Object.values(regions).forEach(stat => {
            const rate = stat.fol > 0 ? (stat.eng / stat.fol) * 100 : 0;
            let level = rate > 1.5 ? (rate > 3.0 ? 'High' : 'Medium') : 'Low';
            let iconClass = stat.name.includes('asia') ? 'fas fa-globe-asia' : (stat.name.includes('europe') ? 'fas fa-globe-europe' : 'fas fa-globe-americas');
            container.innerHTML += `
                <div class="region-card">
                    <div class="region-header">
                        <div class="region-name"><i class="${iconClass}" style="color:var(--primary)"></i> ${formatRegion(stat.name)}</div>
                        <div class="performance-indicator ${level.toLowerCase()}"><i class="fas fa-circle"></i> ${level}</div>
                    </div>
                    <div class="region-metrics">
                        <div class="region-metric"><span class="region-metric-label">Impressions</span><span class="region-metric-value">${formatNumber(stat.imp)}</span></div>
                        <div class="region-metric"><span class="region-metric-label">Engagement</span><span class="region-metric-value">${formatNumber(stat.eng)}</span></div>
                        <div class="region-metric"><span class="region-metric-label">Active Pages</span><span class="region-metric-value">${stat.count}</span></div>
                        <div class="region-metric"><span class="region-metric-label">Eng. Rate</span><span class="region-metric-value">${rate.toFixed(2)}%</span></div>
                    </div>
                </div>
            `;
        });
        if (Object.keys(regions).length === 0) container.innerHTML = '<div style="padding:20px; color:#999;">No data for this region.</div>';
    }

    function renderPlatformComparison(accounts, posts) {
        const container = document.getElementById('platform-comparison-grid');
        if(!container) return;
        container.innerHTML = '';

        const selectedPlatform = document.getElementById('platform-filter').value;

        let targetPlatforms = ['facebook', 'instagram', 'tiktok'];
       
        if (selectedPlatform !== 'all') {
            targetPlatforms = [selectedPlatform];
        }

        const stats = {};
        targetPlatforms.forEach(p => { stats[p] = { count: 0, totalEng: 0, followers: 0, bestTimeMap: {} }; });

        accounts.forEach(acc => {
            const p = acc.platform.toLowerCase();
            if (stats[p]) stats[p].followers += (acc.followers_count || 0);
        });

        posts.forEach(post => {
            const p = post.platform.toLowerCase();
            if (stats[p]) {
                stats[p].count += 1;
                const eng = (post.likes||0) + (post.comments||0) + (post.shares||0);
                stats[p].totalEng += eng;
               
                if (post.posted_at) {
                    const hour = new Date(post.posted_at).getHours();
                    const timeSlot = Math.floor(hour / 2) * 2;
                    stats[p].bestTimeMap[timeSlot] = (stats[p].bestTimeMap[timeSlot] || 0) + eng;
                }
            }
        });

        targetPlatforms.forEach(platform => {
            const s = stats[platform];

            const avgEng = s.count > 0 ? Math.round(s.totalEng / s.count) : 0;
            const engRate = s.followers > 0 ? ((s.totalEng / s.followers) * 100).toFixed(2) : '0.00';
           
            let bestTimeStr = 'N/A';
            let maxEng = -1, bestSlot = -1;
            for (const [slot, eng] of Object.entries(s.bestTimeMap)) { if (eng > maxEng) { maxEng = eng; bestSlot = parseInt(slot); } }
            if (bestSlot !== -1) {
                const formatAMPM = (h) => { const s = h >= 12 ? 'PM' : 'AM'; const h12 = h % 12 || 12; return `${h12} ${s}`; };
                bestTimeStr = `${formatAMPM(bestSlot)} - ${formatAMPM((bestSlot + 2) % 24)}`;
            }

            const style = getPlatformColor(platform);
            const icon = getPlatformIcon(platform);
            
            let iconColor = style.text;
            if (platform === 'tiktok') iconColor = '#000000';

            const card = `
                <div class="comparison-card">
                    <div class="comparison-header">
                        <div class="comparison-title">
                            <i class="${icon}" style="color: ${iconColor};"></i> ${capitalize(platform)}
                        </div>
                        <span class="performance-indicator high"><i class="fas fa-chart-line"></i> ${engRate}% ER</span>
                    </div>
                    <div class="comparison-metrics">
                        <div class="comparison-metric-row">
                            <span class="comparison-metric-name">Total Posts</span>
                            <span class="comparison-metric-value">${formatNumber(s.count)}</span>
                        </div>
                        <div class="comparison-metric-row">
                            <span class="comparison-metric-name">Avg Engagement</span>
                            <span class="comparison-metric-value">${formatNumber(avgEng)}</span>
                        </div>
                        <div class="comparison-metric-row">
                            <span class="comparison-metric-name">Total Followers</span>
                            <span class="comparison-metric-value">${formatNumber(s.followers)}</span>
                        </div>
                        <div class="comparison-metric-row">
                            <span class="comparison-metric-name">Best Time</span>
                            <span class="comparison-metric-value" style="font-size:14px">${bestTimeStr}</span>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += card;
        });
    }

    function renderDataPeriod(snapshots) {
        if (!snapshots || snapshots.length === 0) return;
        const start = new Date(snapshots[0].recorded_at);
        const end = new Date();
        const opts = { day: 'numeric', month: 'short', year: 'numeric' };
        const el = document.getElementById('data-period-label');
        if(el) el.innerHTML = `<i class="fas fa-history"></i> Data collected from: <b>${start.toLocaleDateString('en-US', opts)}</b> ‚Äî <b>${end.toLocaleDateString('en-US', opts)}</b>`;
    }

    // ==========================================
    // 8. HELPERS
    // ==========================================
    function populatePageFilter() {
        const select = document.getElementById('page-filter');
        if(!select) return;
        select.innerHTML = '<option value="all">All Pages</option>';
        const sortedAcc = [...rawData.accounts].sort((a,b) => a.name.localeCompare(b.name));
        sortedAcc.forEach(acc => {
            const opt = document.createElement('option');
            opt.value = acc.id;
            opt.innerText = `${acc.name} (${capitalize(acc.platform)})`;
            select.appendChild(opt);
        });
    }
    function updateCardUI(id, val, growth) {
        const el = document.getElementById(id);
        if(!el) return;
        el.innerText = formatNumber(val);
        updatePercentUI(el.closest('.stat-card'), growth);
    }
    function updateCardBySelector(selector, val, growth) {
        const card = document.querySelector(selector);
        if(!card) return;
        card.querySelector('.stat-value').innerText = formatNumber(val);
        updatePercentUI(card, growth);
    }
    function updatePercentUI(card, percentage) {
        const changeEl = card?.querySelector('.stat-change');
        if (!changeEl) return;
        if (percentage === 0 || isNaN(percentage)) {
            changeEl.className = 'stat-change';
            changeEl.style.color = '#999';
            changeEl.innerHTML = `<i class="fas fa-minus"></i> <span>0%</span>`;
            return;
        }
        const isPositive = percentage > 0;
        changeEl.className = `stat-change ${isPositive ? 'positive' : 'negative'}`;
        changeEl.innerHTML = `<i class="fas fa-arrow-${isPositive ? 'up' : 'down'}"></i> <span>${Math.abs(percentage).toFixed(1)}%</span>`;
    }
    function formatNumber(num) { if(isNaN(num)) return '0'; if(num>=1000000)return(num/1000000).toFixed(1)+'M'; if(num>=1000)return(num/1000).toFixed(1)+'K'; return num.toLocaleString(); }
    function getPlatformIcon(p) { if(p==='facebook')return'fab fa-facebook-f'; if(p==='instagram')return'fab fa-instagram'; if(p==='tiktok')return'fab fa-tiktok'; return 'fas fa-share-alt'; }
    function getPlatformColor(p) {
        switch(p)
        { 
            case 'facebook':return{bg:'#e3f2fd',text:'#1877F2'}; 
            case 'instagram':return{bg:'#fce4ec',text:'#E1306C'}; 
            case 'tiktok': return { bg: '#000000', text: '#ffffff' };
            default:return{bg:'#eee',text:'#333'}; } }
    function formatRegion(r) { if(!r)return'Global'; return r.split('-').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' '); }
    function capitalize(s) { return s?s.charAt(0).toUpperCase()+s.slice(1):''; }

    
    function getCountryCode(account) {

        const text = (account.name + ' ' + (account.handle || '')).toUpperCase();

        if (text.includes('DEFAULT') || text.includes('THAILAND') || text.includes('.TH')) return 'TH';
        if (text.includes(' US ') || text.includes(' USA ') || text.includes('.US')) return 'US';
        if (text.includes(' JP ') || text.includes(' JAPAN ') || text.includes('.JP')) return 'JP';
        if (text.includes(' KR ') || text.includes(' KOREA ') || text.includes('.KR')) return 'KR';
        if (text.includes(' FR ') || text.includes(' FRANCE ') || text.includes('.FR')) return 'FR';
        if (text.includes(' DE ') || text.includes(' GERMANY ') || text.includes('.DE')) return 'DE';
        if (text.includes(' UK ') || text.includes(' UNITED KINGDOM ') || text.includes('.UK')) return 'UK';
        if (text.includes(' IN ') || text.includes(' INDIA ') || text.includes('.IN')) return 'IN';
        if (text.includes(' UAE ') || text.includes('.UAE') || text.includes('ARAB')) return 'AE';
        if (text.includes(' IL ') || text.includes(' ISRAEL ') || text.includes('.IL')) return 'IL';
        
        return 'GL'; 
    }

    document.addEventListener('DOMContentLoaded', initDashboard);
</script>
</body>
</html>