<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Columbia Pictures Aquaverse - 2025 Content Calendar</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    :root {
      --primary: #1a2a6c; --secondary: #b21f1f; --accent: #fdbb2d;
      --light: #f5f7fa; --dark: #333; --gray: #6c757d;
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background:var(--light); color:var(--dark); line-height:1.6; padding:20px; user-select:none; }
    .container { max-width:1400px; margin:0 auto; }

    header {
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      margin-bottom:30px; padding:20px;
      background:linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
      color:white; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    .brand { display:flex; flex-direction:column; }
    h1 { font-size:2rem; margin-bottom:6px; }
    .subtitle { font-size:1rem; opacity:.9; }

    .header-actions { display:flex; gap:10px; }
    .link-btn {
      display:inline-flex; align-items:center; gap:8px; text-decoration:none;
      background:rgba(255,255,255,.15); color:white; padding:10px 14px; border-radius:8px; font-weight:700; transition:.2s ease;
    }
    .link-btn:hover { background:rgba(255,255,255,.25); transform:translateY(-1px); }

    .controls {
      display:flex; justify-content:space-between; align-items:center;
      margin:20px 0; padding:15px; background:white; border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1); flex-wrap:wrap; gap:15px;
    }
    .month-navigation { display:flex; align-items:center; gap:15px; }
    .nav-btn {
      background:var(--primary); color:white; border:none; padding:10px 15px; border-radius:50px;
      cursor:pointer; display:flex; align-items:center; gap:8px; font-weight:600; transition:all .3s ease;
      box-shadow:0 2px 5px rgba(0,0,0,0.2);
    }
    .nav-btn:hover { background:#2a3a8c; transform:translateY(-2px); }
    .month-year { font-size:1.5rem; font-weight:700; color:var(--primary); min-width:180px; text-align:center; }

    .view-controls { display:flex; gap:10px; align-items:center; }
    .view-btn {
      padding:8px 15px; border:2px solid var(--primary); background:white; color:var(--primary);
      border-radius:5px; cursor:pointer; font-weight:600; transition:all .3s ease;
    }
    .view-btn.active { background:var(--primary); color:white; }

    .market-selector { display:flex; gap:5px; flex-wrap:wrap; }
    .market-btn {
      padding:5px 10px; border:1px solid var(--primary); background:white; color:var(--primary);
      border-radius:20px; cursor:pointer; font-size:.8rem; transition:all .3s ease;
    }
    .market-btn.active { background:var(--primary); color:white; }

    .edit-controls { display:flex; gap:10px; }
    .edit-btn {
      padding:8px 15px; border:2px solid var(--accent); background:white; color:var(--accent);
      border-radius:5px; cursor:pointer; font-weight:600; transition:all .2s ease;
    }
    .edit-btn.active { background:var(--accent); color:white; }

    .dashboard { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:30px; }
    .folder-status, .content-summary { background:white; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    .folder-status h2, .content-summary h2 { color:var(--primary); margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #f0f0f0; }
    .folder-item { display:flex; justify-content:space-between; margin-bottom:10px; padding:8px 0; }
    .folder-name { font-weight:600; }
    .folder-count { background:#e9ecef; padding:2px 10px; border-radius:20px; font-weight:600; }

    .content-stats { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
    .stat-item { text-align:center; padding:15px; border-radius:8px; background:#f8f9fa; }
    .stat-number { font-size:1.8rem; font-weight:700; color:var(--primary); }
    .stat-label { font-size:.9rem; color:var(--gray); }

    .calendar-container {
      background:white; border-radius:10px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:30px;
      overflow-x:auto;
    }
    .calendar-inner { min-width: 900px; }

    .calendar-header {
      display:grid; grid-template-columns:repeat(7, 1fr);
      background:var(--primary); color:white; text-align:center; font-weight:600;
    }
    .calendar-header div { padding:15px 5px; }
    .calendar-week { display:grid; grid-template-columns:repeat(7, 1fr); border-bottom:1px solid #e9ecef; }

    .calendar-day {
      min-height:140px; padding:10px; border-right:1px solid #e9ecef; position:relative;
      transition:all .2s ease; cursor:pointer; word-break:break-word;
    }
    .calendar-day:hover { background:#f8f9fa; }
    .calendar-day.editable:hover { background:#fff9e6; }
    .calendar-day:last-child { border-right:none; }

    .date-number { font-weight:700; margin-bottom:5px; color:#495057; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .edit-indicator { color:var(--accent); font-size:.8rem; }

    .content-type { font-size:.85rem; padding:4px 8px; border-radius:4px; margin-bottom:5px; color:white; font-weight:600; display:inline-block; }
    .shortform { background:#28a745; }
    .ai-shortform { background:#007bff; }
    .ai-carousel { background:#17a2b8; }
    .real-carousel { background:#fd7e14; }
    .longform { background:#6f42c1; }
    .no-post { background:#6c757d; }

    .market-tags { display:flex; flex-wrap:wrap; gap:4px; margin-top:5px; }
    .market-tag { font-size:.65rem; padding:2px 6px; border-radius:3px; background:#e9ecef; }
    .content-theme { font-size:.8rem; color:#495057; margin-top:6px; font-style:italic; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; }

    .activity-block {
      background: #fdfdfd;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 8px;
      margin-top: 8px;
      cursor: pointer;
      transition: all .2s ease;
    }
    .editable .activity-block:hover {
      background: #fff;
      border-color: var(--primary);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* ===== Post preview media (fake placeholders) ===== */
    .preview-block { margin-bottom: 24px; }
    .media-preview { margin-top: 10px; margin-bottom: 14px; }
    .media-frame {
      width: 100%;
      border-radius: 10px;
      overflow: hidden;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .media-frame.media-vertical { aspect-ratio: 9 / 16; }
    .media-frame.media-square  { aspect-ratio: 1 / 1; }
    .media-frame.media-landscape { aspect-ratio: 16 / 9; }
    .media-frame img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .media-label {
      margin-top: 8px;
      font-size: 0.85rem;
      color: var(--gray);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .media-label i { font-size: 0.9rem; }

    .preview-meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      font-size: 0.85rem;
    }
    .preview-meta-pill {
      background: #f1f3f5;
      border-radius: 999px;
      padding: 4px 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .preview-meta-pill i { font-size: 0.9rem; }

    .preview-title-activity {
      color: var(--primary);
      margin-bottom: 6px;
      font-size: 1.05rem;
      font-weight: 700;
    }
    .preview-theme {
      font-size: 0.95rem;
      color: var(--dark);
      font-style: italic;
      white-space: pre-wrap;
      margin-top: 4px;
    }

    .mobile-list .edit-indicator { float: right; }
    .editable .calendar-day:hover .edit-indicator { opacity: 1; }

    .platform-selector { display: flex; gap: 20px; margin-top: 10px; }
    .platform-selector input[type="checkbox"] { margin-right: 5px; }
    .platform-selector label { font-weight: normal; display: flex; align-items: center; gap: 6px; cursor: pointer; }
    .platform-selector .fa-brands { font-size: 1.2rem; }
    .fa-facebook { color: #1877F2; }
    .fa-instagram { color: #E4405F; }

    .legend { display:flex; justify-content:center; flex-wrap:wrap; gap:15px; margin-top:20px; }
    .legend-item { display:flex; align-items:center; gap:5px; }
    .legend-color { width:20px; height:20px; border-radius:4px; }

    .empty-day { background:#f8f9fa; padding:6px; border-radius:6px; display:inline-block; }

    .other-month { background:#f0f2f5; color:#adb5bd; }
    .swipe-info { text-align:center; margin-top:15px; color:var(--gray); font-size:.9rem; }

    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; padding:16px; }
    .modal-content { background:white; padding:22px; border-radius:10px; width:92%; max-width:640px; box-shadow:0 5px 15px rgba(0,0,0,0.3); max-height:90vh; overflow-y:auto; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; padding-bottom:10px; border-bottom:1px solid #e9ecef; }
    .modal-title { font-size:1.3rem; color:var(--primary); }
    .close-modal { background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--gray); }

    .form-group { margin-bottom:12px; }
    .form-group label { display:block; margin-bottom:6px; font-weight:600; color:var(--dark); }
    .form-control { width:100%; padding:10px; border:1px solid #ced4da; border-radius:6px; font-size:1rem; }
    textarea.form-control { min-height:100px; resize:vertical; }
    .form-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:16px; }
    .btn { padding:10px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition:all .2s ease; }
    .btn-primary { background:var(--primary); color:white; }
    .btn-secondary { background:var(--gray); color:white; }
    .btn-danger { background:var(--secondary); color:white; }

    .market-checkboxes { display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-top:10px; }
    .market-checkbox { display:flex; align-items:center; gap:5px; }

    .save-notification {
      position:fixed; bottom:20px; right:20px; background:var(--primary); color:white;
      padding:10px 20px; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2);
      display:none; z-index:1001;
    }

    /* Carousel video section */
    .carousel-video-section {
      margin-top: 15px;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border: 1px dashed #ccc;
    }
    
    .carousel-video-preview {
      margin-top: 10px;
    }
    
    .carousel-video-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: white;
      border-radius: 6px;
      margin-bottom: 8px;
    }
    
    .carousel-video-item video {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
    }
    
    .carousel-video-info {
      flex: 1;
    }
    
    .carousel-video-actions {
      display: flex;
      gap: 5px;
    }

    /* Carousel images preview */
    .carousel-images-preview {
      margin-top: 10px;
    }
    
    .carousel-images-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    
    .carousel-image-item {
      position: relative;
      aspect-ratio: 1 / 1;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .carousel-image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* ====== Tablet tweaks ====== */
    @media (max-width:768px) {
      header { flex-direction:column; align-items:flex-start; }
      .dashboard { grid-template-columns:1fr; }
      .calendar-inner { min-width: 720px; }
      .calendar-header div { padding:10px 4px; font-size:.85rem; }
      .calendar-day { min-height:110px; padding:6px; }
      .content-type { font-size:.75rem; padding:3px 6px; }
      .content-theme { -webkit-line-clamp: 3; font-size:.75rem; }
      .month-year { font-size:1.25rem; }
      .controls { flex-direction:column; align-items:flex-start; }
      .market-checkboxes { grid-template-columns:repeat(2, 1fr); }
      .modal-content { width: 100%; padding:18px; }
      .carousel-images-grid { grid-template-columns: repeat(2, 1fr); }
    }

    .calendar-fade { animation:fadeIn .5s ease-in-out; }
    @keyframes fadeIn { from { opacity:.5; } to { opacity:1; } }

    .global-view .market-tags { display:none; }
    .individual-view .market-tags { display:flex; }

    /* ====== MOBILE: real single-column list ====== */
    @media (max-width:600px){
      .calendar-header { display: none !important; }
      .calendar-inner { min-width: 0; }
      .calendar-week { display: none !important; }

      #calendar .mobile-list { display:flex; flex-direction:column; }

      #calendar .mobile-list .calendar-day {
        display:block;
        min-height:unset;
        padding:12px;
        margin:10px 12px;
        border:1px solid #e9ecef;
        border-radius:10px;
        box-shadow:0 1px 3px rgba(0,0,0,0.04);
      }

      .calendar-day.other-month{ display:none !important; }

      .month-navigation {
        gap: 4px;
        width: 100%;
        justify-content: space-between;
      }

      .month-year {
        min-width: unset;
        font-size: 0.9rem;
        flex: 1;
        text-align: center;
      }

      .nav-btn {
        flex-shrink: 0;
        padding: 6px 8px;
        font-size: 0.8rem;
        border-radius: 5px;
      }

      .controls {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <h1>Columbia Pictures Aquaverse</h1>
      <p class="subtitle">2025 Global Content Calendar</p>
    </div>
    <div class="header-actions">
      <a class="link-btn" id="beachclub-link" href="#quuba" title="Open the Beach Club page">
        <i class="fa-solid fa-umbrella-beach"></i> Beach Club Page
      </a>
    </div>
  </header>

  <div id="calendar-view" style="display:block;">
    <div class="controls">
      <div class="month-navigation">
        <button class="nav-btn" id="prev-month"><i class="fas fa-chevron-left"></i> Previous</button>
        <div class="month-year" id="current-month">November 2025</div>
        <button class="nav-btn" id="next-month">Next <i class="fas fa-chevron-right"></i></button>
      </div>

      <div class="view-controls">
        <button class="view-btn active" id="global-view">Global View</button>
        <button class="view-btn" id="individual-view">Individual View</button>
        <div class="market-selector" id="market-selector" style="display:none;"></div>
      </div>

      <div class="edit-controls">
        <button class="edit-btn" id="edit-mode">Edit Mode</button>
        <button class="edit-btn" id="logout-btn" style="display:none;">Sign out</button>
      </div>
    </div>

    <div class="dashboard">
      <div class="folder-status">
        <h2 style="padding-top: 5px;">Video Inventory</h2>

        <div class="folder-item">
          <span class="folder-name">Available AI Shortform Videos</span>
          <span class="folder-count" id="available-video-count" style="background:var(--primary); color:white;">...</span>
        </div>

        <div class="folder-item">
          <span class="folder-name">Scheduled Shortform (all markets)</span>
          <span class="folder-count" id="scheduled-shortform-total">0 posts</span>
        </div>

        <div class="folder-item">
          <span class="folder-name">US Shortform</span>
          <span class="folder-count" id="shortform-us-count">0</span>
        </div>
        <div class="folder-item">
          <span class="folder-name">Korea Shortform</span>
          <span class="folder-count" id="shortform-korea-count">0</span>
        </div>
        <div class="folder-item">
          <span class="folder-name">India Shortform</span>
          <span class="folder-count" id="shortform-india-count">0</span>
        </div>
        <div class="folder-item">
          <span class="folder-name">France Shortform</span>
          <span class="folder-count" id="shortform-france-count">0</span>
        </div>
        <div class="folder-item">
          <span class="folder-name">Japan Shortform</span>
          <span class="folder-count" id="shortform-japan-count">0</span>
        </div>
        <div class="folder-item">
          <span class="folder-name">UK Shortform</span>
          <span class="folder-count" id="shortform-uk-count">0</span>
        </div>
        <div class="folder-item">
          <span class="folder-name">Germany Shortform</span>
          <span class="folder-count" id="shortform-germany-count">0</span>
        </div>
        <div class="folder-item">
          <span class="folder-name">Thailand Shortform</span>
          <span class="folder-count" id="shortform-thailand-count">0</span>
        </div>

        <h2>Canto Folder Status</h2>
        <div class="folder-item">
          <span class="folder-name">Carousels_Ready</span>
          <span class="folder-count" id="ready-count">112 items</span>
        </div>
        <div class="folder-item">
          <span class="folder-name">Carousels_Posted</span>
          <span class="folder-count" id="posted-count">0 items</span>
        </div>
        <p style="margin-top:15px; font-size:.9rem; color:var(--gray);">
          All markets follow the same posting schedule with localized content.
        </p>
      </div>

      <div class="content-summary">
        <h2>Monthly Content Summary</h2>
        <div class="content-stats">
          <div class="stat-item"><div class="stat-number" id="total-posts">0</div><div class="stat-label">Total Posts</div></div>
          <div class="stat-item"><div class="stat-number" id="shortform-count">0</div><div class="stat-label">Shortform</div></div>
          <div class="stat-item"><div class="stat-number" id="ai-shortform-count">0</div><div class="stat-label">AI Shortform</div></div>
          <div class="stat-item"><div class="stat-number" id="ai-count">0</div><div class="stat-label">AI Carousels</div></div>
          <div class="stat-item"><div class="stat-number" id="real-count">0</div><div class="stat-label">Real Carousels</div></div>
          <div class="stat-item"><div class="stat-number" id="longform-count">0</div><div class="stat-label">Longform</div></div>
        </div>
      </div>
    </div>

    <div class="calendar-container" id="calendar-container">
      <div class="calendar-inner" id="calendar"></div>
    </div>

    <div class="swipe-info">
      <i class="fas fa-arrows-left-right"></i> Swipe left/right or use buttons to navigate months
    </div>

    <div class="legend">
      <div class="legend-item"><div class="legend-color shortform"></div><span>Shortform</span></div>
      <div class="legend-item"><div class="legend-color ai-shortform"></div><span>AI Shortform</span></div>
      <div class="legend-item"><div class="legend-color ai-carousel"></div><span>AI Carousel</span></div>
      <div class="legend-item"><div class="legend-color real-carousel"></div><span>Real Carousel</span></div>
      <div class="legend-item"><div class="legend-color longform"></div><span>Longform (1×/month)</span></div>
      <div class="legend-item"><div class="legend-color no-post"></div><span>No Post (Analytics Day)</span></div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal" id="edit-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Edit Content</h2>
        <button class="close-modal" id="close-modal">&times;</button>
      </div>
      <form id="content-form">
        <input type="hidden" id="edit-date"/>
        <input type="hidden" id="edit-market"/>
        <input type="hidden" id="edit-activity-id" />

        <div class="form-group">
          <label for="content-type">Content Type</label>
          <select class="form-control" id="content-type" required>
            <option value="">Select Content Type</option>
            <option value="shortform">Shortform</option>
            <option value="ai-shortform">AI Shortform</option>
            <option value="ai-carousel">AI Carousel</option>
            <option value="real-carousel">Real Carousel</option>
            <option value="longform">Longform</option>
            <option value="no-post">No Post</option>
          </select>
        </div>

        <div class="form-group">
          <label><i class="fas fa-clock"></i> Scheduled Time (24H)</label>
        <div style="display: flex; align-items: center; gap: 8px;">
          
          <select id="post-time-hour" class="form-control" style="text-align:center; font-weight:bold; cursor:pointer; width: 75px;">
            <option value="00">00</option><option value="01">01</option><option value="02">02</option>
            <option value="03">03</option><option value="04">04</option><option value="05">05</option>
            <option value="06">06</option><option value="07">07</option><option value="08">08</option>
            <option value="09">09</option><option value="10" selected>10</option><option value="11">11</option>
            <option value="12">12</option><option value="13">13</option><option value="14">14</option>
            <option value="15">15</option><option value="16">16</option><option value="17">17</option>
            <option value="18">18</option><option value="19">19</option><option value="20">20</option>
            <option value="21">21</option><option value="22">22</option><option value="23">23</option>
          </select>
          
          <span style="font-weight:bold; font-size:1.2rem;">:</span>
          
          <select id="post-time-minute" class="form-control" style="text-align:center; font-weight:bold; cursor:pointer; width: 75px;">
            <option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option>
            <option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option>
            <option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option>
            <option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option>
            <option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option>
            <option value="25">25</option><option value="26">26</option><option value="27">27</option><option value="28">28</option><option value="29">29</option>
            <option value="30">30</option><option value="31">31</option><option value="32">32</option><option value="33">33</option><option value="34">34</option>
            <option value="35">35</option><option value="36">36</option><option value="37">37</option><option value="38">38</option><option value="39">39</option>
            <option value="40">40</option><option value="41">41</option><option value="42">42</option><option value="43">43</option><option value="44">44</option>
            <option value="45">45</option><option value="46">46</option><option value="47">47</option><option value="48">48</option><option value="49">49</option>
            <option value="50">50</option><option value="51">51</option><option value="52">52</option><option value="53">53</option><option value="54">54</option>
            <option value="55">55</option><option value="56">56</option><option value="57">57</option><option value="58">58</option><option value="59">59</option>
          </select>

        </div>
        </div>

        <div class="form-group" id="manual-video-section" style="display:none; margin-top:15px; background:#f8f9fa; padding:15px; border-radius:8px; border:1px dashed #ccc;">
          <label style="color:var(--primary);"><i class="fas fa-video"></i> Selected Video</label>
          
          <div id="preview-container" style="margin-bottom:10px; display:none;">
            <video id="video-player-preview" controls style="width:100%; max-height:300px; background:black; border-radius:6px;"></video>
          </div>

          <div style="display:flex; gap:10px;">
            <input type="text" class="form-control" id="selected-filename" readonly placeholder="No video selected" style="background:white;">
            <button type="button" class="btn btn-primary" id="open-picker-btn">
              Choose
            </button>
            <button type="button" class="btn btn-danger" id="clear-video-btn" title="Clear selection">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <!-- Carousel Video Section -->
        <div class="carousel-video-section" id="carousel-video-section" style="display:none; margin-top: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px dashed #ccc;">
          <label style="color:var(--primary);"><i class="fas fa-film"></i> Carousel Video</label>
          <p style="font-size:0.85rem; color:var(--gray); margin-bottom:10px;">Add a video to your carousel (optional)</p>
          
          <div id="carousel-video-preview" style="display:none; margin-top:10px;">
            <div style="display:flex; flex-direction:column; gap:0; background:#fff; border-radius:8px; overflow:hidden; border: 1px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
              
              <div style="width:100%; background:#000; position:relative; text-align:center;">
                  <video id="carousel-video-player" controls preload="metadata" style="width:100%; height:auto; max-height: 400px; display:block; margin: 0 auto;"></video>
              </div>
          
              <div style="display:flex; justify-content: space-between; align-items:center; gap:10px; padding: 12px 15px; background: #fff; border-top: 1px solid #eee;">
                  <div style="flex:1; overflow:hidden; display:flex; align-items:center; gap:10px; color: #333;">
                       <div style="width:36px; height:36px; background:#f0f2f5; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#555; flex-shrink:0;">
                          <i class="fas fa-video"></i>
                       </div>
                       <div style="overflow:hidden; display:flex; flex-direction:column;">
                          <div id="carousel-video-filename" style="font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Filename.mp4</div>
                          <span style="font-size:11px; color:#888;">Carousel Video Asset</span>
                       </div>
                  </div>
                  
                  <button type="button" id="clear-carousel-video-btn" style="border:1px solid #dc3545; background:#fff; color:#dc3545; cursor:pointer; padding:8px 12px; border-radius:6px; font-size:13px; font-weight:600; transition:all 0.2s;" onmouseover="this.style.background='#dc3545'; this.style.color='white';" onmouseout="this.style.background='white'; this.style.color='#dc3545';">
                    <i class="fas fa-trash-alt" style="margin-right:4px;"></i> Remove
                  </button>
              </div>
          
            </div>
          </div>

          <button type="button" class="btn btn-primary" id="open-carousel-video-picker" style="margin-top: 10px;">
            <i class="fas fa-plus"></i> Add Video to Carousel
          </button>
        </div>

        <!-- Carousel Images Preview Section -->
        <div class="carousel-images-section" id="carousel-images-section" style="display:none; margin-top:15px; background:#f8f9fa; padding:15px; border-radius:8px;">
          <label style="color:var(--primary);"><i class="fas fa-images"></i> Carousel Images</label>
          <div id="carousel-images-preview" class="carousel-images-preview">
            <!-- Images will be rendered here -->
          </div>
        </div>

        <div class="ai-prompt-section" id="ai-prompt-section" style="display:none;">
          <div class="form-group">
            <label for="ai-prompt">AI Generation Prompt</label>
            <textarea class="form-control" id="ai-prompt" placeholder="Describe what you want the AI to generate..."></textarea>
          </div>
        </div>

        <div class="form-group">
          <label>Platform</label>
          <div class="platform-selector">
            <input type="checkbox" id="platform-fb" value="facebook">
            <label for="platform-fb"><i class="fa-brands fa-facebook"></i> Facebook</label>
            
            <input type="checkbox" id="platform-ig" value="instagram">
            <label for="platform-ig"><i class="fa-brands fa-instagram"></i> Instagram</label>
            
            <input type="checkbox" id="platform-tt" value="tiktok">
            <label for="platform-tt"><i class="fa-brands fa-tiktok"></i> TikTok</label>
          </div>
        </div>

        <div class="form-group">
          <label>Markets</label>
          <div class="market-checkboxes" id="market-checkboxes"></div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="cancel-edit">Cancel</button>
          <button type="button" class="btn btn-danger" id="delete-content">Delete</button>
          <button type="submit" class="btn btn-primary">Save Content</button>
        </div>
      </form>
    </div>
  </div>

  <!-- View Modal (post preview) -->
  <div class="modal" id="view-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="view-title">Content Details</h2>
        <button class="close-modal" id="close-view">&times;</button>
      </div>
      <div id="view-body"></div>
      <div class="form-actions" style="justify-content: flex-end;">
        <button type="button" class="btn btn-primary" id="view-ok">Close</button>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div class="modal" id="auth-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="auth-title">Editor Login</h2>
        <button class="close-modal" id="close-auth">&times;</button>
      </div>
      <form id="auth-form">
        <div class="form-group">
          <label for="auth-email">Email</label>
          <input type="email" id="auth-email" class="form-control" placeholder="name@aquaverse.com" autocomplete="username" required />
        </div>
        <div class="form-group">
          <label for="auth-password">Password</label>
          <input type="password" id="auth-password" class="form-control" placeholder="Enter password" autocomplete="current-password" required />
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="cancel-auth">Cancel</button>
          <button type="submit" class="btn btn-primary">Log in</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Video Picker Modal -->
  <div class="modal" id="video-picker-modal">
    <div class="modal-content" style="max-width: 800px; height: 80vh; display:flex; flex-direction:column;">
      <div class="modal-header">
        <h2 class="modal-title">Select Video from Library</h2>
        <button class="close-modal" id="close-picker">&times;</button>
      </div>
      
      <div style="padding-bottom: 10px;">
        <input type="text" id="video-search" class="form-control" placeholder="Search filename...">
      </div>

      <div id="video-list-container" style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:6px; padding:10px;">
        <div style="text-align:center; padding:20px; color:#999;">Loading videos...</div>
      </div>

      <div class="form-actions" style="margin-top:10px;">
        <button type="button" class="btn btn-secondary" id="cancel-picker">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Carousel Video Picker Modal -->
  <div class="modal" id="carousel-video-picker-modal">
    <div class="modal-content" style="max-width: 800px; height: 80vh; display:flex; flex-direction:column;">
      <div class="modal-header">
        <h2 class="modal-title">Select Video for Carousel</h2>
        <button class="close-modal" id="close-carousel-picker">&times;</button>
      </div>
      
      <div style="padding-bottom: 10px;">
        <input type="text" id="carousel-video-search" class="form-control" placeholder="Search filename...">
      </div>

      <div id="carousel-video-list-container" style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:6px; padding:10px;">
        <div style="text-align:center; padding:20px; color:#999;">Loading videos...</div>
      </div>

      <div class="form-actions" style="margin-top:10px;">
        <button type="button" class="btn btn-secondary" id="cancel-carousel-picker">Cancel</button>
      </div>
    </div>
  </div>

  <div class="save-notification" id="save-notification">Changes saved successfully!</div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://merpsvkfmjbugrgnwwlq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1lcnBzdmtmbWpidWdyZ253d2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NzcyMDksImV4cCI6MjA3NzQ1MzIwOX0.HYqgv5VFQxQ0E1QsxXYLLXu_r6LguyAEaErDSkHUc88";
  const GENERATE_CAROUSEL_WEBHOOK_URL = "https://saschag.app.n8n.cloud/webhook/calendar-carousel";
  
  const LIST_VIDEOS_WEBHOOK_URL = "https://saschag.app.n8n.cloud/webhook/list-videos"; 
  const STORAGE_BASE_URL = "https://merpsvkfmjbugrgnwwlq.supabase.co/storage/v1/object/public";

  const BUCKET_SHORTFORM = "ShortForm";
  const BUCKET_SHORTVIDEO = "ShortVideo";
  const BUCKET_CAROUSEL = "carousel-image";

  const z2 = (n) => String(n).padStart(2, "0");
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const MARKETS = ['US','Korea','India','France','Japan','UK','Germany','Thailand','Quuba'];
  const norm = s => (s || '').toString().trim().toLowerCase();
  const hasMarketCI = (arr, m) => (arr || []).some(x => norm(x) === norm(m));
  const dedupeMarketsCI = (arr) => { const seen=new Set(); const out=[]; for (const m of arr||[]) { const k=norm(m); if(!seen.has(k)){seen.add(k); out.push(m);} } return out; };
  const toCanonicalMarket = (m) => MARKETS.find(mm => norm(mm) === norm(m)) || m;

  let currentDate = new Date(2025, 10, 1); // Nov 2025
  let isEditMode = false;
  let currentView = 'global';
  let currentMarket = 'US';
  let currentlyEditingDay = null;

  let monthDataCache = {};
  let realtimeChannel = null;
  const table = 'calendars';

  function showNotification(message, type = 'success') {
    const el = document.getElementById('save-notification');
    el.textContent = message;
    el.style.display = 'block';
    el.style.background = type === 'success' ? 'var(--primary)' : 'var(--secondary)';
    setTimeout(() => { el.style.display = 'none'; }, 5000);
  }

  function getFileUrl(filename, type) {
    if (!filename) return '';
    if (filename.startsWith('http')) return filename; 

    let bucket = "ShortForm"; 

    if (type === 'ai-shortform') bucket = "ShortVideo";
    else if (type === 'ai-carousel') bucket = "carousel-image";
    
    return `${STORAGE_BASE_URL}/${bucket}/${encodeURIComponent(filename)}`;
  }

  async function triggerAICarouselGeneration({ schedule_id, theme, prompt, markets, platforms=[], count = 6 }) {
    try {
      showNotification("Starting AI Carousel generation…");
      const resp = await fetch(GENERATE_CAROUSEL_WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          schedule_id,
          date: schedule_id,
          theme,
          prompt,
          markets,
          platforms,
          count
        })
      });

      let data = null;
      try { data = await resp.json(); } catch {}

      const isSuccess = resp.ok || (data && data.message === 'Workflow was started');

      if (!isSuccess) {
        console.error("Generation webhook failed:", data || await resp.text());
        showNotification("AI Carousel generation failed. Check automation logs.", "error");
        return { ok: false, data };
      }

      showNotification("AI Carousel generated and uploaded to Canto.", "success");
      return { ok: true, data };
    } catch (err) {
      console.error(err);
      showNotification("AI Carousel generation failed (network).", "error");
      return { ok: false, error: err?.message || "network_error" };
    }
  }

  function buildMarketButtons() {
    const container = document.getElementById('market-selector');
    container.innerHTML = '';
    MARKETS.forEach((m) => {
      const b = document.createElement('button');
      b.className = 'market-btn';
      b.dataset.market = m;
      b.textContent = m;
      b.addEventListener('click', (e) => toggleMarket(e.currentTarget, m));
      container.appendChild(b);
    });
  }

  let selectedMarkets = [];

  function toggleMarket(btnElement, marketName) {
    const canonicalMarket = toCanonicalMarket(marketName);
    const isActive = btnElement.classList.toggle('active');
    const index = selectedMarkets.indexOf(canonicalMarket);

    if (isActive && index === -1) {
      selectedMarkets.push(canonicalMarket);
    } else if (!isActive && index > -1) {
      selectedMarkets.splice(index, 1);
    }
    renderCalendar(currentDate);
  }

  function buildMarketCheckboxes() {
    const box = document.getElementById('market-checkboxes');
    box.innerHTML = '';
    MARKETS.forEach((m) => {
      const id = `market-${m.toLowerCase().replace(/\s+/g,'-')}`;
      const wrap = document.createElement('div');
      wrap.className = 'market-checkbox';
      wrap.innerHTML = `
        <input type="checkbox" id="${id}" value="${m}" checked/>
        <label for="${id}">${m}</label>
      `;
      box.appendChild(wrap);
    });
  }

  function applyHashRoute() {
    const hash = (location.hash || '').toLowerCase();
    if (hash === '#quuba') {
      currentMarket = 'Quuba'; setView('individual'); buildMarketButtons();
    } else if (hash === '#thailand') {
      currentMarket = 'Thailand'; setView('individual'); buildMarketButtons();
    }
  }

  async function ensureAuthenticated() {
    const { data } = await supabase.auth.getSession();
    if (data?.session) return true;

    return new Promise((resolve) => {
      const authForm = document.getElementById('auth-form');
      const closeBtn = document.getElementById('close-auth');
      const cancelBtn = document.getElementById('cancel-auth');

      openAuthModal();

      const onSubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById('auth-email').value.trim();
        const pass  = document.getElementById('auth-password').value;
        const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
        if (error) { alert('Invalid credentials or sign-in error.'); return; }
        cleanup(); closeAuthModal();
        document.getElementById('logout-btn').style.display = 'inline-block';
        resolve(true);
      };
      const onCancel = () => { cleanup(); closeAuthModal(); resolve(false); };
      const onEsc = (e) => { if (e.key === 'Escape') onCancel(); };

      function cleanup() {
        authForm.removeEventListener('submit', onSubmit);
        closeBtn.removeEventListener('click', onCancel);
        cancelBtn.removeEventListener('click', onCancel);
        window.removeEventListener('keydown', onEsc);
      }

      authForm.addEventListener('submit', onSubmit);
      closeBtn.addEventListener('click', onCancel);
      cancelBtn.addEventListener('click', onCancel);
      window.addEventListener('keydown', onEsc);
    });
  }

  function openAuthModal() {
    document.getElementById('auth-email').value = '';
    document.getElementById('auth-password').value = '';
    document.getElementById('auth-modal').style.display = 'flex';
    setTimeout(() => document.getElementById('auth-email').focus(), 0);
  }
  function closeAuthModal() { document.getElementById('auth-modal').style.display = 'none'; }

  (async () => {
    const { data: authState } = await supabase.auth.getSession();
    document.getElementById('logout-btn').style.display = authState?.session ? 'inline-block' : 'none';
    supabase.auth.onAuthStateChange((_event, session) => {
      document.getElementById('logout-btn').style.display = session ? 'inline-block' : 'none';
    });
  })();

  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    if (isEditMode) toggleEditMode();
    await supabase.auth.signOut();
    showNotification('Signed out.');
  });

  function monthId(dateObj) {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth()+1).padStart(2,'0');
    return `${y}-${m}`;
  }

  async function upsertEmptyMonthIfMissing(dateObj) {
    const id = monthId(dateObj);
    const { data, error } = await supabase
      .from(table)
      .select('id')
      .eq('id', id)
      .maybeSingle();

    if (error && error.code !== 'PGRST116') {
      console.error('Existence check error:', error);
      return;
    }
    if (!data) {
      const { data: sess } = await supabase.auth.getSession();
      if (sess?.session) {
        const { error: insErr } = await supabase.from(table).upsert({ id, days: {} }, { onConflict: 'id' });
        if (insErr) console.error('Create empty month error:', insErr);
      }
    }
  }

  async function bindMonth(dateObj) {
    if (realtimeChannel) {
      try { await supabase.removeChannel(realtimeChannel); } catch {}
      realtimeChannel = null;
    }

    const id = monthId(dateObj);
    await upsertEmptyMonthIfMissing(dateObj);

    const { data, error } = await supabase
      .from(table)
      .select('days')
      .eq('id', id)
      .maybeSingle();

    if (error) { console.error(error); monthDataCache = {}; }
    else { monthDataCache = (data && data.days) || {}; }

    renderCalendar(dateObj);
    updateFolderCounts();

    try {
      realtimeChannel = supabase
        .channel(`db-changes-${id}`)
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: table,
          filter: `id=eq.${id}`
        }, (payload) => {
          const newDays = payload?.new?.days;
          if (newDays) {
            monthDataCache = newDays;
            renderCalendar(dateObj);
          }
        })
        .subscribe();
    } catch(e) { console.error("Realtime subscription failed", e); }
  }

  async function writeDay(dateObj, day, payload) {
    const id = monthId(dateObj);
    const { data: sel, error: selErr } = await supabase
      .from(table)
      .select('days')
      .eq('id', id)
      .maybeSingle();

    if (selErr && selErr.code !== 'PGRST116') {
      console.error('Select error:', selErr);
      alert('Could not load current month data (network/permissions).');
      return;
    }

    const days = { ...(sel?.days || {}) };
    days[day] = payload;

    const { error: upErr } = await supabase
      .from(table)
      .upsert({ id, days }, { onConflict: 'id' });

    if (upErr) {
      console.error('Upsert error:', upErr);
      alert('Save failed (permissions or network).');
    } else {
      monthDataCache = days;
      renderCalendar(currentDate);
      updateFolderCounts();
    }
  }

  async function deleteDay(dateObj, day) {
    const id = monthId(dateObj);
    const { data: sel, error: selErr } = await supabase
      .from(table)
      .select('days')
      .eq('id', id)
      .maybeSingle();

    if (selErr && selErr.code !== 'PGRST116') {
      console.error('Select error:', selErr);
      alert('Could not load current month data (network/permissions).');
      return;
    }

    const days = { ...(sel?.days || {}) };
    delete days[day];

    const { error: upErr } = await supabase
      .from(table)
      .upsert({ id, days }, { onConflict: 'id' });

    if (upErr) {
      console.error('Upsert error:', upErr);
      alert('Delete failed (permissions or network).');
    } else {
      monthDataCache = days;
      renderCalendar(currentDate);
      updateFolderCounts();
    }
  }

  /* ===== Helper: fake media per content type (for post preview) ===== */
  function getPlaceholderMedia(content) {
    const type = content?.type || '';
    const base = 'https://placehold.co';

    if (content && content.mediaUrl) {
      return {
        url: content.mediaUrl,
        label: 'Linked asset',
        alt: `${getContentTypeName(type)} media`,
        shape:
          type === 'longform'
            ? 'media-landscape'
            : type.includes('carousel')
            ? 'media-square'
            : 'media-vertical',
      };
    }

    switch (type) {
      case 'ai-shortform':
        return {
          url: `${base}/600x1067?text=AI+Shortform+Preview`,
          label: 'Fake AI shortform video preview',
          alt: 'AI shortform placeholder',
          shape: 'media-vertical',
        };
      case 'shortform':
        return {
          url: `${base}/600x1067?text=Shortform+Preview`,
          label: 'Fake shortform video preview',
          alt: 'Shortform placeholder',
          shape: 'media-vertical',
        };
      case 'ai-carousel':
        return {
          url: `${base}/800x800?text=AI+Carousel+Preview`,
          label: 'Fake AI carousel preview',
          alt: 'AI carousel placeholder',
          shape: 'media-square',
        };
      case 'real-carousel':
        return {
          url: `${base}/800x800?text=Real+Carousel+Preview`,
          label: 'Fake real carousel preview',
          alt: 'Real carousel placeholder',
          shape: 'media-square',
        };
      case 'longform':
        return {
          url: `${base}/1280x720?text=Longform+Video+Preview`,
          label: 'Fake longform video preview',
          alt: 'Longform video placeholder',
          shape: 'media-landscape',
        };
      case 'no-post':
        return {
          url: `${base}/800x400?text=Analytics+%2F+No+Post`,
          label: 'Analytics / no-post day',
          alt: 'No post placeholder',
          shape: 'media-landscape',
        };
      default:
        return {
          url: `${base}/800x800?text=Content+Preview`,
          label: 'Generic content preview',
          alt: 'Content placeholder',
          shape: 'media-square',
        };
    }
  }

  function openViewModal(day) {
    const month = currentDate.getMonth() + 1;
    const year = currentDate.getFullYear();
    const viewTitle = document.getElementById('view-title');
    viewTitle.textContent = `Content Details - ${day}/${month}/${year}`;

    const rawDayData = monthDataCache?.[day] || null;
    const dayDataArray = Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : []);

    const body = document.getElementById('view-body');
    body.innerHTML = '';

    if (dayDataArray.length === 0) {
      body.innerHTML = `<p><strong>No content scheduled</strong> for this day.</p>`;
    } else {
      dayDataArray.forEach((content, index) => {
        if (!content) return;

        const markets = (content.markets || []).map(toCanonicalMarket).join(', ') || '-';
        
        let platforms = [];
        if (Array.isArray(content.platform)) platforms = content.platform;
        else if (content.platform) platforms = [content.platform];

        const platformIcons = platforms.map(p => {
            if (p.toLowerCase() === 'facebook') return `<i class="fa-brands fa-facebook" style="color:#1877F2;"></i>`;
            if (p.toLowerCase() === 'instagram') return `<i class="fa-brands fa-instagram" style="color:#E4405F;"></i>`;
            if (p.toLowerCase() === 'tiktok') return `<i class="fa-brands fa-tiktok" style="color:#000000;"></i>`;
            return `<span>${p}</span>`;
        }).join(' ');

        let mediaHtml = '';
     
        if ((content.type === 'ai-carousel' || content.type === 'real-carousel')) {
          let videoHtml = '';
          let imagesHtml = '';
        
        if (content.carouselVideo) {
          
          const videoUrl = `${STORAGE_BASE_URL}/ShortVideo/${encodeURIComponent(content.carouselVideo)}`;
          
          videoHtml = `
            <div class="preview-block">
              <div class="media-preview">
                <div class="media-frame media-square" style="background:black;">
                  <video controls style="width:100%; height:100%; object-fit:contain;">
                    <source src="${videoUrl}" type="video/mp4">
                    Your browser does not support the video tag.
                  </video>
                </div>
                <div class="media-label">
                  <i class="fa-solid fa-file-video"></i> <span>Carousel Video: ${content.carouselVideo}</span>
                </div>
              </div>
            </div>
          `;
        }
          
          // Add images if exist
          if (content.images && content.images.length > 0) {
            const imagesGrid = content.images.map(filename => {
              const cleanName = filename.replace('carousel-image/', '').replace('carousel-image\\', '');
              const url = `${STORAGE_BASE_URL}/${BUCKET_CAROUSEL}/${encodeURIComponent(cleanName)}`;
              
              return `
                <div class="carousel-image-item">
                  <img src="${url}" alt="Carousel image" 
                    onerror="this.src='https://placehold.co/100x100?text=Error';">
                </div>
              `;
            }).join('');

            imagesHtml = `
              <div class="preview-block">
                <div class="media-label" style="margin-bottom:5px;">
                  <i class="fa-solid fa-images"></i> Generated Assets (${content.images.length})
                </div>
                <div class="carousel-images-grid">
                  ${imagesGrid}
                </div>
              </div>
            `;
          }
          
          mediaHtml = videoHtml + imagesHtml;
        }
        // Handle shortform and longform videos
        else if (content.type.includes('shortform') || content.type === 'longform') {
            let finalVideoUrl = content.videoUrl;

            if (!finalVideoUrl && content.fileName) {
                finalVideoUrl = getFileUrl(content.fileName, content.type);
            }

            if (finalVideoUrl) {
               mediaHtml = `
                 <div class="preview-block">
                   <div class="media-preview">
                     <div class="media-frame media-vertical" style="background:black;">
                       <video controls style="width:100%; height:100%; object-fit:contain;">
                         <source src="${finalVideoUrl}" type="video/mp4">
                         Your browser does not support the video tag.
                       </video>
                     </div>
                     <div class="media-label">
                       <i class="fa-solid fa-file-video"></i> <span>${content.fileName}</span>
                     </div>
                   </div>
                 </div>`;
            }
        }

        if (!mediaHtml) {
           const media = getPlaceholderMedia(content);
           mediaHtml = `
              <div class="preview-block">
                <div class="media-preview">
                  <div class="media-frame ${media.shape}">
                    <img src="${media.url}" alt="${media.alt}" loading="lazy" />
                  </div>
                  <div class="media-label"><i class="fa-solid fa-photo-film"></i> <span>${media.label}</span></div>
                </div>
              </div>`;
        }
  
        const aiBlock = (content.type === 'ai-carousel' && content.aiPrompt) 
            ? `<div class="form-group" style="margin-top:10px;"><label>AI Prompt</label><div class="form-control" style="background:#f9f9f9;">${content.aiPrompt}</div></div>` 
            : '';

        body.innerHTML += `
          ${index > 0 ? '<hr style="margin: 20px 0; border-top: 1px solid #eee;">' : ''}
          <h3 class="preview-title-activity">Activity ${index + 1}: ${getContentTypeName(content.type)}</h3>
          ${mediaHtml}
          <div class="form-group"><label>Theme</label><div class="form-control preview-theme">${content.theme || '-'}</div></div>
          ${aiBlock}
          <div class="preview-meta-row">
             <div class="preview-meta-pill"><i class="fa-solid fa-globe"></i> <strong>Markets:</strong> ${markets}</div>
             <div class="preview-meta-pill"><i class="fa-solid fa-share-nodes"></i> <strong>Platforms:</strong> ${platformIcons || '-'}</div>
          </div>
        `;
          
        const timeDisplay = content.postTime ? `<span class="preview-meta-pill"><i class="far fa-clock"></i> <strong>Time:</strong> ${content.postTime}</span>` : '';

        body.innerHTML += `
          <div class="form-group"><label>Theme</label><div class="form-control preview-theme">${content.theme || '-'}</div></div>
          ${aiBlock}
          <div class="preview-meta-row">
             <div class="preview-meta-pill"><i class="fa-solid fa-globe"></i> <strong>Markets:</strong> ${markets}</div>
             <div class="preview-meta-pill"><i class="fa-solid fa-share-nodes"></i> <strong>Platforms:</strong> ${platformIcons || '-'}</div>
             ${timeDisplay} </div>
        `;
      
      
      });
    }

    const modal = document.getElementById('view-modal');
    modal.style.display = 'flex';

    const close = () => { modal.style.display = 'none'; };
    
    const closeBtn = document.getElementById('close-view');
    const okBtn = document.getElementById('view-ok');
    
    if(closeBtn) closeBtn.onclick = close;
    if(okBtn) okBtn.onclick = close;
  }

  document.addEventListener('DOMContentLoaded', async () => {
    buildMarketButtons();
    buildMarketCheckboxes();
    applyHashRoute();
    await bindMonth(currentDate);
    setupEventListeners();
  });

  function setupEventListeners() {
    document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
    document.getElementById('next-month').addEventListener('click', () => changeMonth(1));
    document.getElementById('global-view').addEventListener('click', () => setView('global'));
    document.getElementById('individual-view').addEventListener('click', () => setView('individual'));
    document.getElementById('close-modal').addEventListener('click', closeModal);
    document.getElementById('cancel-edit').addEventListener('click', closeModal);
    document.getElementById('delete-content').addEventListener('click', deleteContent);
    document.getElementById('content-form').addEventListener('submit', saveContent);
    document.getElementById('content-type').addEventListener('change', function() {
      const val = this.value;

      if (val === 'shortform') {
          window.CURRENT_BUCKET = "ShortForm";
      } else if (val === 'ai-shortform') {
          window.CURRENT_BUCKET = "ShortVideo";
      } else {
          window.CURRENT_BUCKET = null;
      }

      document.getElementById('ai-prompt-section').style.display =
          (val === 'ai-carousel') ? 'block' : 'none';

      document.getElementById('manual-video-section').style.display =
          (val.includes('shortform') || val === 'longform')
          ? 'block'
          : 'none';

      // Show carousel video section for carousel types
      document.getElementById('carousel-video-section').style.display =
          (val === 'ai-carousel' || val === 'real-carousel')
          ? 'block'
          : 'none';

      // Show carousel images section for carousel types
      document.getElementById('carousel-images-section').style.display =
          (val === 'ai-carousel' || val === 'real-carousel')
          ? 'block'
          : 'none';
    });

    // Carousel video picker
    document.getElementById('open-carousel-video-picker').addEventListener('click', openCarouselVideoPicker);
    document.getElementById('clear-carousel-video-btn').addEventListener('click', clearCarouselVideo);
    document.getElementById('close-carousel-picker').addEventListener('click', () => document.getElementById('carousel-video-picker-modal').style.display = 'none');
    document.getElementById('cancel-carousel-picker').addEventListener('click', () => document.getElementById('carousel-video-picker-modal').style.display = 'none');

    const calRoot = document.getElementById('calendar');

    calRoot.addEventListener('click', (e) => {
      const dayCell = e.target.closest('.calendar-day');
      if (!dayCell) return;
      const day = parseInt(dayCell.dataset.day, 10);
      if (!day) return;

      if (isEditMode) {
        const activityBlock = e.target.closest('.activity-block');
        if (activityBlock) {
          const activityId = activityBlock.dataset.activityId;
          if (activityId) openEditModal(day, activityId);
          return;
        }
        const isHeaderClick = e.target.closest('.date-number');
        const isAddIconClick = e.target.closest('.edit-indicator');

        if (!isHeaderClick || isAddIconClick) {
          const rawDayData = (monthDataCache && monthDataCache[day]) || null;
          const dayDataArray = Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : []);

          if (isAddIconClick && dayDataArray.length === 1) {
            const activityId = dayDataArray[0].id || 'legacy_0';
            openEditModal(day, activityId);
          } else {
            openEditModal(day, null);
          }
        }
      } else {
        openViewModal(day);
      }
    });

    calRoot.addEventListener('touchstart', e => { window._tSX = e.changedTouches[0].screenX; }, { passive: true });
    calRoot.addEventListener('touchend', e => {
      if (!window._tSX) return;
      const tEX = e.changedTouches[0].screenX;
      const swipe = (tEX - (window._tSX || 0));
      if (swipe > 50) changeMonth(-1);
      else if (swipe < -50) changeMonth(1);
      window._tSX = null;
    });

    window.addEventListener('hashchange', async () => { applyHashRoute(); renderCalendar(currentDate); });

    document.getElementById('edit-mode').addEventListener('click', async () => {
      if (!isEditMode) {
        const ok = await ensureAuthenticated();
        if (!ok) return;
      }
      toggleEditMode();
    });

    const mq = window.matchMedia('(max-width: 600px)');
    mq.addEventListener?.('change', () => renderCalendar(currentDate));
  }

  function setView(view) {
    currentView = view;
    const calendar = document.getElementById('calendar');
    const globalBtn = document.getElementById('global-view');
    const individualBtn = document.getElementById('individual-view');
    const marketSelector = document.getElementById('market-selector');

    if (view === 'global') {
      calendar.classList.remove('individual-view'); calendar.classList.add('global-view');
      globalBtn.classList.add('active'); individualBtn.classList.remove('active'); marketSelector.style.display = 'none';
      selectedMarkets = [];
    } else {
      calendar.classList.remove('global-view'); calendar.classList.add('individual-view');
      globalBtn.classList.remove('active'); individualBtn.classList.add('active'); marketSelector.style.display = 'flex';

      if (selectedMarkets.length === 0) {
        selectedMarkets = [toCanonicalMarket('US')];
      }

      document.querySelectorAll('.market-btn').forEach(btn => {
        const canonicalMarket = toCanonicalMarket(btn.dataset.market);
        btn.classList.toggle('active', hasMarketCI(selectedMarkets, canonicalMarket));
      });
    }
    renderCalendar(currentDate);
  }

  function setMarket(market) {
    currentMarket = toCanonicalMarket(market);
    document.querySelectorAll('.market-btn').forEach(btn => {
      btn.classList.toggle('active', norm(btn.dataset.market) === norm(currentMarket));
    });
    renderCalendar(currentDate);
  }

  function changeMonth(direction) {
    currentDate.setMonth(currentDate.getMonth() + direction);
    bindMonth(currentDate);
    renderCalendar(currentDate);
    updateFolderCounts();
    const calendar = document.getElementById('calendar');
    calendar.classList.remove('calendar-fade'); void calendar.offsetWidth; calendar.classList.add('calendar-fade');
  }

  function toggleEditMode() {
    isEditMode = !isEditMode;
    const editBtn = document.getElementById('edit-mode');
    if (isEditMode) {
      editBtn.classList.add('active'); editBtn.innerHTML = '<i class="fas fa-edit"></i> Editing';
      document.getElementById('calendar').classList.add('editable');
    } else {
      editBtn.classList.remove('active'); editBtn.innerHTML = 'Edit Mode';
      document.getElementById('calendar').classList.remove('editable');
    }
    renderCalendar(currentDate);
  }

  function newActivityId() { return 'act_' + Date.now() + Math.random().toString(36).substr(2, 9); }

  function openEditModal(day, activityId = null) {
    currentlyEditingDay = day;
    const month = currentDate.getMonth();
    const year = currentDate.getFullYear();

    const rawDayData = (monthDataCache && monthDataCache[day]) || null;
    let dayDataArray = Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : []);

    // Fix legacy ID
    dayDataArray.forEach((item, index) => {
      if (!item.id) item.id = `legacy_${index}`;
    });

    const content = activityId ? dayDataArray.find(item => item.id === activityId) : null;

    // --- Safety Helper: ฟังก์ชันช่วยใส่ค่าแบบปลอดภัย (กัน Error) ---
    const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
    const setCheck = (id, val) => { const el = document.getElementById(id); if(el) el.checked = val; };
    const setText = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
    // -----------------------------------------------------------

    // Set Hidden Fields & Title
    if(document.getElementById('modal-title')) {
        document.getElementById('modal-title').textContent = content
        ? `Edit Content - ${day}/${month+1}/${year}`
        : `Add Content - ${day}/${month+1}/${year}`;
    }
    setVal('edit-date', `${year}-${month}-${day}`);
    setVal('edit-activity-id', content ? content.id : '');

    // Reset Market Checkboxes
    const selected = new Set((content?.markets || []).map(norm));
    document.querySelectorAll('#market-checkboxes input[type="checkbox"]').forEach(cb => {
      cb.checked = selected.size ? selected.has(norm(cb.value)) : true;
    });

    if (content) {
      
      setVal('content-type', content.type || '');
      setVal('content-theme', content.theme || '');
      setVal('ai-prompt', content.aiPrompt || '');

      if (content.postTime) {
          const parts = content.postTime.split(':');
          if (parts.length === 2) {
             setVal('post-time-hour', parts[0]);
             setVal('post-time-minute', parts[1]);
          }
      } else {
          setVal('post-time-hour', '10');
          setVal('post-time-minute', '00');
      }

      // Show/Hide Delete Button
      const delBtn = document.getElementById('delete-content');
      if(delBtn) delBtn.style.display = 'inline-block';

      // Load Platforms
      let platforms = Array.isArray(content.platform) ? content.platform : (content.platform ? [content.platform] : []);
      const platformSet = new Set(platforms);
      setCheck('platform-fb', platformSet.has('facebook'));
      setCheck('platform-ig', platformSet.has('instagram'));
      setCheck('platform-tt', platformSet.has('tiktok'));

      // --- Carousel Video ---
      if ((content.type === 'ai-carousel' || content.type === 'real-carousel') && content.carouselVideo) {
        const preview = document.getElementById('carousel-video-preview');
        const player = document.getElementById('carousel-video-player');
        if(preview) preview.style.display = 'block';
        setText('carousel-video-filename', content.carouselVideo);
        if(player) {
            const bucket = "ShortVideo";
            player.src = `${STORAGE_BASE_URL}/${bucket}/${encodeURIComponent(content.carouselVideo)}`;
        }
      } else {
        const preview = document.getElementById('carousel-video-preview');
        if(preview) preview.style.display = 'none';
      }

      // --- Carousel Images ---
      if ((content.type === 'ai-carousel' || content.type === 'real-carousel') && content.images && content.images.length > 0) {
        const imagesContainer = document.getElementById('carousel-images-preview');
        if (imagesContainer) {
            imagesContainer.innerHTML = '';
            const imagesGrid = document.createElement('div');
            imagesGrid.className = 'carousel-images-grid';
            
            content.images.forEach(filename => {
              const cleanName = filename.replace('carousel-image/', '').replace('carousel-image\\', '');
              const url = `${STORAGE_BASE_URL}/${BUCKET_CAROUSEL}/${encodeURIComponent(cleanName)}`;
              const imageItem = document.createElement('div');
              imageItem.className = 'carousel-image-item';
              imageItem.innerHTML = `<img src="${url}" alt="Carousel image" onerror="this.src='https://placehold.co/100x100?text=Error';">`;
              imagesGrid.appendChild(imageItem);
            });
            imagesContainer.appendChild(imagesGrid);
        }
        const imgSec = document.getElementById('carousel-images-section');
        if(imgSec) imgSec.style.display = 'block';
      } else {
        // Reset Images if none
        const imgSec = document.getElementById('carousel-images-section');
        if(imgSec) imgSec.style.display = 'block';
        const imgPrev = document.getElementById('carousel-images-preview');
        if(imgPrev) imgPrev.innerHTML = '<p style="color:var(--gray); font-style:italic;">No images generated yet</p>';
      }

    } else {
      
      setVal('content-type', '');
      setVal('content-theme', '');
      setVal('ai-prompt', '');
      setVal('post-time-hour', '10');
      setVal('post-time-minute', '00');

      setCheck('platform-fb', false);
      setCheck('platform-ig', false);
      setCheck('platform-tt', false);

      const delBtn = document.getElementById('delete-content');
      if(delBtn) delBtn.style.display = 'none';
      
      const vidPrev = document.getElementById('carousel-video-preview');
      if(vidPrev) vidPrev.style.display = 'none';
      
      const imgSec = document.getElementById('carousel-images-section');
      if(imgSec) imgSec.style.display = 'block'; // Show section but empty
      const imgPrev = document.getElementById('carousel-images-preview');
      if(imgPrev) imgPrev.innerHTML = '<p style="color:var(--gray); font-style:italic;">No images generated yet</p>';
    }

    // Toggle Sections Visibility
    const type = document.getElementById('content-type') ? document.getElementById('content-type').value : '';
    const aiPromptSec = document.getElementById('ai-prompt-section');
    const manualVidSec = document.getElementById('manual-video-section');
    const carVidSec = document.getElementById('carousel-video-section');
    const carImgSec = document.getElementById('carousel-images-section');

    if(aiPromptSec) aiPromptSec.style.display = (type === 'ai-carousel') ? 'block' : 'none';
    if(manualVidSec) manualVidSec.style.display = (type.includes('shortform') || type === 'longform') ? 'block' : 'none';
    if(carVidSec) carVidSec.style.display = (type === 'ai-carousel' || type === 'real-carousel') ? 'block' : 'none';
    if(carImgSec) carImgSec.style.display = (type === 'ai-carousel' || type === 'real-carousel') ? 'block' : 'none';

    document.getElementById('edit-modal').style.display = 'flex';

    // Handle Manual Video (Non-Carousel)
    if (manualVidSec && content && content.type && (content.type.includes('shortform') || content.type === 'longform')) {
        const fName = content.fileName || '';
        setVal('selected-filename', fName);
        
        const preview = document.getElementById('preview-container');
        const player = document.getElementById('video-player-preview');
        
        if(fName && preview && player) {
            preview.style.display = 'block';
            player.src = getFileUrl(fName, content.type);
        } else if (preview) {
             preview.style.display = 'none';
        }
    } else {
        setVal('selected-filename', '');
        const preview = document.getElementById('preview-container');
        if(preview) preview.style.display = 'none';
    }
  }

  function closeModal() {
    document.getElementById('edit-modal').style.display = 'none';
    currentlyEditingDay = null;
  }

  async function openCarouselVideoPicker() {
    const modal = document.getElementById('carousel-video-picker-modal');
    const container = document.getElementById('carousel-video-list-container');
    const searchInput = document.getElementById('carousel-video-search');

    searchInput.value = ''; 
    modal.style.display = 'flex';
    container.innerHTML = '<div style="text-align:center; margin-top:20px;"><i class="fas fa-spinner fa-spin"></i> Loading Library...</div>';

    try {
      const type = document.getElementById('content-type').value;
      const currentActivityId = document.getElementById('edit-activity-id').value;

      let bucket = "ShortForm"; 
      if (type === 'ai-carousel' || type === 'real-carousel') {
        bucket = "ShortVideo"; 
      }
     
      const res = await fetch(`${LIST_VIDEOS_WEBHOOK_URL}?bucket=${bucket}`);
      if (!res.ok) throw new Error(`API Error: ${res.status}`);

      const allFiles = await res.json();

      const usedFilenames = getUsedFilenames(currentActivityId);
      const availableFiles = allFiles.filter(file => !usedFilenames.has(file.name));
    
      renderCarouselVideoList(availableFiles);

      searchInput.onkeyup = (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = availableFiles.filter(f => f.name.toLowerCase().includes(term));
        renderCarouselVideoList(filtered);
      };

    } catch (err) {
      container.innerHTML = `<div style="color:red; text-align:center;">Error loading videos.<br>${err.message}</div>`;
      console.error(err);
    }
  }

  function renderCarouselVideoList(files) {
    const container = document.getElementById('carousel-video-list-container');
    container.innerHTML = '';

    if(!files || files.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">No videos found.</div>';
        return;
    }

    files.forEach(file => {
      if(file.name === '.emptyFolderPlaceholder') return;
   
      const sizeBytes = file.size || (file.metadata && file.metadata.size) || 0;
      const sizeMB = (sizeBytes / 1024 / 1024).toFixed(2);

      const div = document.createElement('div');
      div.style.cssText = "padding:12px; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:background 0.2s;";
      div.onmouseover = () => div.style.background = "#f8f9fa";
      div.onmouseout = () => div.style.background = "white";

      div.innerHTML = `
        <div style="pointer-events:none;">
            <i class="fas fa-file-video" style="color:#666; margin-right:10px;"></i>
            <strong>${file.name}</strong>
            <div style="font-size:0.8rem; color:#999; margin-left:26px; margin-top:2px;">Size: ${sizeMB} MB</div>
        </div>
        <button class="btn btn-secondary" style="padding:4px 12px; font-size:0.8rem; pointer-events:none;">Select</button>
      `;
   
      div.onclick = () => selectCarouselVideo(file.name);
      
      container.appendChild(div);
    });
  }

  function selectCarouselVideo(filename) {
    document.getElementById('carousel-video-preview').style.display = 'block';
    document.getElementById('carousel-video-filename').textContent = filename;
    
    const videoPlayer = document.getElementById('carousel-video-player');
    const type = document.getElementById('content-type').value;
    videoPlayer.src = getFileUrl(filename, type);

    const bucket = "ShortVideo";
    videoPlayer.src = `${STORAGE_BASE_URL}/${bucket}/${encodeURIComponent(filename)}`;

    document.getElementById('carousel-video-picker-modal').style.display = 'none';
  }

  function clearCarouselVideo() {
    document.getElementById('carousel-video-preview').style.display = 'none';
    document.getElementById('carousel-video-filename').textContent = '';
    document.getElementById('carousel-video-player').src = '';
  }

  async function saveContent(e) {
    e.preventDefault();
    const ok = await ensureAuthenticated(); if (!ok) return;

    const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
    const getCheck = (id) => { const el = document.getElementById(id); return el ? el.checked : false; };

    const day = currentlyEditingDay;
    const activityId = getVal('edit-activity-id');
    const type = getVal('content-type');
    const theme = getVal('content-theme');
    const aiPrompt = getVal('ai-prompt');
    const manualFileName = getVal('selected-filename');

    let postTime = '10:00';
    const hhEl = document.getElementById('post-time-hour');
    const mmEl = document.getElementById('post-time-minute');
    const singleTimeEl = document.getElementById('post-time');

    if (hhEl && mmEl) {
       
        postTime = `${hhEl.value}:${mmEl.value}`;
    } else if (singleTimeEl) {
       
        postTime = singleTimeEl.value;
    }
    
    const carouselVideoEl = document.getElementById('carousel-video-filename');
    const carouselPreviewEl = document.getElementById('carousel-video-preview');
    const carouselVideo = (carouselPreviewEl && carouselPreviewEl.style.display !== 'none' && carouselVideoEl) 
      ? carouselVideoEl.textContent 
      : null;

    let selectedMarketsList = [];
    document.querySelectorAll('#market-checkboxes input:checked').forEach(cb => selectedMarketsList.push(toCanonicalMarket(cb.value)));
    selectedMarketsList = dedupeMarketsCI(selectedMarketsList).map(toCanonicalMarket);

    if (!type) { alert('Please select a content type'); return; }
    if (type === 'ai-carousel' && !aiPrompt.trim()) {
      alert('AI Carousel requires an AI Generation Prompt.');
      return;
    }

    // Inventory check
    if (type === 'ai-shortform') {
      const availableCount = await getRealtimeVideoCount();
      let otherScheduledActivities = 0;
      Object.values(monthDataCache || {}).forEach(rawDayData => {
        const dayArray = Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : []);
        dayArray.forEach(activity => {
          if (activity.id !== activityId && activity.type === 'ai-shortform') {
            otherScheduledActivities++;
          }
        });
      });
      const newPostActivity = (selectedMarketsList.length > 0) ? 1 : 0;
      const totalFutureActivities = otherScheduledActivities + newPostActivity;
      if (totalFutureActivities > availableCount) {
        showNotification(`❌ Error: Not enough videos (Available: ${availableCount})`, 'error');
        return;
      }
    }

    // Longform check
    if (type === 'longform') {
        
      let existingLongform = false;
      Object.values(monthDataCache || {}).forEach(rawDayData => {
        const dayArray = Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : []);
        dayArray.forEach(activity => {
          if (activity.id !== activityId && activity.type === 'longform') {
            existingLongform = true;
          }
        });
      });
      if (existingLongform) {
        showNotification(`❌ Error: Only one Longform allowed per month.`, 'error');
        return;
      }
    }

    const selectedPlatforms = [];
    if (getCheck('platform-fb')) selectedPlatforms.push('facebook');
    if (getCheck('platform-ig')) selectedPlatforms.push('instagram');
    if (getCheck('platform-tt')) selectedPlatforms.push('tiktok');

    const payload = {
      id: (activityId && !activityId.startsWith('legacy_')) ? activityId : newActivityId(),
      type,
      theme,
      platform: selectedPlatforms,
      fileName: manualFileName,
      markets: selectedMarketsList,
      postTime: postTime 
    };

    if ((type === 'ai-carousel' || type === 'real-carousel') && carouselVideo) {
      payload.carouselVideo = carouselVideo;
    }

    const rawDayData = monthDataCache[day] || null;
    const currentDayArray = (Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : [])).slice();
    const existingContent = activityId ? currentDayArray.find(item => item.id === activityId) : null;
    
    if (type === 'ai-carousel') {
      payload.aiPrompt = aiPrompt;
      if (existingContent && existingContent.images) {
        payload.images = existingContent.images;
      } else {
        payload.images = [];
      }
    }

    if (activityId) {
      const index = currentDayArray.findIndex(item => item.id === activityId);
      if (index > -1) currentDayArray[index] = payload;
      else currentDayArray.push(payload);
    } else {
      currentDayArray.push(payload);
    }

    await writeDay(currentDate, day, currentDayArray);
    showNotification('Content saved successfully!');
    closeModal();

    // Trigger AI Generation (if needed)
    try {
      if (type === 'ai-carousel') {
        const y = currentDate.getFullYear();
        const m = z2(currentDate.getMonth() + 1);
        const d = z2(day);
        const schedule_id = `${y}-${m}-${d}-${payload.id}`;

        const gen = await triggerAICarouselGeneration({
          schedule_id,
          theme,
          prompt: aiPrompt,
          markets: selectedMarketsList,
          platforms: selectedPlatforms,
          count: 6
        });
      
        if (gen.ok) {
            if (gen.data && gen.data.images && gen.data.images.length > 0) {
                 const id = monthId(currentDate);
                 const { data: sel } = await supabase.from('calendars').select('days').eq('id', id).maybeSingle();
                 const days = { ...(sel?.days || {}) };
                 const finalDayArray = (days[day] || []).slice();
                 const indexToUpdate = finalDayArray.findIndex(item => item.id === payload.id);

                 if (indexToUpdate > -1) {
                     finalDayArray[indexToUpdate] = {
                         ...finalDayArray[indexToUpdate],
                         aiGenerated: true,
                         images: gen.data.images.map(p => `${BUCKET_CAROUSEL}${encodeURIComponent(p.replace('carousel-image/', ''))}`)
                     };
                     days[day] = finalDayArray;
                     await supabase.from('calendars').upsert({ id, days }, { onConflict: 'id' });
                     showNotification('AI Assets attached immediately!');
                 }
            } else {
                 waitForAIImages(schedule_id, day, payload.id);
            }
        }
      }
    } catch (err) {
      console.error(err);
      showNotification('Saved, but AI generation check failed.', 'error');
    }
  }

  async function deleteContent() {
    const ok = await ensureAuthenticated();
    if (!ok) return;

    const day = currentlyEditingDay;
    const activityId = document.getElementById('edit-activity-id').value;
    if (!day || !activityId) {
      alert("Error: Could not find item to delete.");
      return;
    }

    const rawDayData = monthDataCache[day] || null;
    const currentDayArray = (Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : [])).slice();
    const newDayArray = currentDayArray.filter(item => item.id !== activityId);

    await writeDay(currentDate, day, newDayArray);
    showNotification('Content deleted successfully!');
    closeModal();
  }

  function getContentTypeName(type) {
    switch (type) {
      case 'shortform': return 'Shortform';
      case 'ai-shortform': return 'AI Shortform';
      case 'ai-carousel': return 'AI Carousel';
      case 'real-carousel': return 'Real Carousel';
      case 'longform': return 'Longform';
      case 'no-post': return 'No Post';
      default: return '';
    }
  }

  function renderCalendar(date) {
    const calendarEl = document.getElementById('calendar');
    const monthYearEl = document.getElementById('current-month');

    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    monthYearEl.textContent = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;

    calendarEl.innerHTML = '';
    const isMobile = window.matchMedia && window.matchMedia('(max-width: 600px)').matches;

    function createActivityHtml(dayData, index = 0) {
     
      if (currentView === 'individual' && selectedMarkets.length > 0) {
        const marketsOnThisActivity = new Set(
          (dayData.markets || []).map(toCanonicalMarket)
        );
        const isMatch = [...selectedMarkets].some(targetMarket =>
          marketsOnThisActivity.has(targetMarket)
        );
        if (!isMatch) return '';
      }

      let viewSpecificHtml = '';
      if (currentView === 'global') {
        const marketCount = (dayData.markets || []).length;
        viewSpecificHtml = `<div class="market-count">${marketCount} market${marketCount !== 1 ? 's' : ''}</div>`;
      } else {
        viewSpecificHtml = `<div class="market-tags">
          ${(dayData.markets || []).map(m => `<span class="market-tag">${toCanonicalMarket(m)}</span>`).join('')}
        </div>`;
      }

      const activityId = dayData.id || `legacy_${index}`;

      let platforms = [];
      if (Array.isArray(dayData.platform)) {
        platforms = dayData.platform;
      } else if (dayData.platform) {
        platforms = [dayData.platform];
      }
      const platformSet = new Set(platforms);

      let platformIcons = '';
      const iconStyle = "font-size: 0.9rem; vertical-align: middle; margin-left: 5px;";
      if (platformSet.has('facebook')) platformIcons += `<i class="fa-brands fa-facebook" style="color:#1877F2; ${iconStyle}"></i>`;
      if (platformSet.has('instagram')) platformIcons += `<i class="fa-brands fa-instagram" style="color:#E4405F; ${iconStyle}"></i>`;
      if (platformSet.has('tiktok')) platformIcons += `<i class="fa-brands fa-tiktok" style="color:#000000; ${iconStyle}"></i>`;

      const videoIndicator = (dayData.carouselVideo) ? ' <i class="fas fa-film" style="font-size:0.7rem; margin-left:3px;"></i>' : '';

      let timeHtml = '';
      if (dayData.postTime) {
        timeHtml = `<span style="font-size:0.75rem; color:#666; background:#eee; padding:1px 4px; border-radius:3px; margin-left:5px;">
                      <i class="far fa-clock"></i> ${dayData.postTime}
                    </span>`;
      }

      return `
        <div class="activity-block" data-activity-id="${activityId}">
          <div class="content-type ${dayData.type}">
             ${getContentTypeName(dayData.type)}${platformIcons}${videoIndicator}
          </div>
          <div style="margin-top:2px;">${timeHtml}</div>
          ${viewSpecificHtml}
          <div class="content-theme">${dayData.theme || ''}</div>
        </div>
      `;
    }

    if (isMobile) {
      // --- MOBILE VIEW ---
      const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
      const list = document.createElement('div');
      list.className = 'mobile-list';
      calendarEl.appendChild(list);

      for (let d = 1; d <= daysInMonth; d++) {
        const day = document.createElement('div');
        day.className = 'calendar-day' + (isEditMode ? ' editable' : '');
        day.dataset.day = String(d);

        const rawDayData = (monthDataCache && monthDataCache[d]) || null;
        const dayDataArray = Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : []);

        let activitiesHtml = '';
        dayDataArray.forEach((activityData, index) => {
          activitiesHtml += createActivityHtml(activityData, index);
        });

        let html = `<div class="date-number">${d}`;
        if (isEditMode) html += `<span class="edit-indicator"><i class="fas fa-edit"></i></span>`;
        html += `</div>`;

        html += activitiesHtml;

        if (activitiesHtml.trim() === '' && currentView === 'global') {
          html += `<div class="empty-day">No content scheduled</div>`;
        } else if (activitiesHtml.trim() === '' && currentView === 'individual' && selectedMarkets.length > 0) {
          html += `<div class="empty-day" style="opacity:0.5;">No content for selected markets</div>`;
        }

        day.innerHTML = html;
        list.appendChild(day);
      }
    } else {
      // --- DESKTOP VIEW ---
      const header = document.createElement('div');
      header.className = 'calendar-header';
      header.innerHTML = `
        <div>Sunday</div><div>Monday</div><div>Tuesday</div>
        <div>Wednesday</div><div>Thursday</div><div>Friday</div><div>Saturday</div>
      `;
      calendarEl.appendChild(header);

      const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
      const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();

      let dayCount = 1;
      for (let i = 0; i < 6; i++) {
        const week = document.createElement('div');
        week.className = 'calendar-week';

        for (let j = 0; j < 7; j++) {
          const day = document.createElement('div');

          if (i === 0 && j < firstDay) {
            const prevMonthDays = new Date(date.getFullYear(), date.getMonth(), 0).getDate();
            const dayNumber = prevMonthDays - firstDay + j + 1;
            day.className = 'calendar-day other-month';
            day.innerHTML = `<div class="date-number">${dayNumber}</div><div>Previous Month</div>`;
          } else if (dayCount > daysInMonth) {
            const dayNumber = dayCount - daysInMonth;
            day.className = 'calendar-day other-month';
            day.innerHTML = `<div class="date-number">${dayNumber}</div><div>Next Month</div>`;
            dayCount++;
          } else {
            const dayClass = isEditMode ? 'calendar-day editable' : 'calendar-day';
            day.className = dayClass;
            day.dataset.day = String(dayCount);

            const rawDayData = (monthDataCache && monthDataCache[dayCount]) || null;
            const dayDataArray = Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : []);

            let activitiesHtml = '';
            dayDataArray.forEach(activityData => {
            
              activitiesHtml += createActivityHtml(activityData);
            });

            let dayHTML = `<div class="date-number">${dayCount}`;
            if (isEditMode) dayHTML += `<span class="edit-indicator"><i class="fas fa-edit"></i></span>`;
            dayHTML += `</div>`;

            dayHTML += activitiesHtml;

            if (activitiesHtml.trim() === '' && currentView === 'global') {
              dayHTML += `<div class="empty-day">No content scheduled</div>`;
            } else if (activitiesHtml.trim() === '' && currentView === 'individual' && selectedMarkets.length > 0) {
              dayHTML += `<div class="empty-day" style="opacity:0.5;">No content</div>`;
            }

            day.innerHTML = dayHTML;
            dayCount++;
          }
          week.appendChild(day);
        }
        calendarEl.appendChild(week);
        if (dayCount > daysInMonth) break;
      }
    }

    updateContentSummary(date);
    updateShortformPerMarketCounts(); 
  }

  function updateContentSummary(date) {
    const monthData = monthDataCache || {};
    let totalPosts = 0, shortformCount = 0, aiShortformCount = 0, aiCount = 0, realCount = 0, longformCount = 0;

    Object.values(monthData).forEach(rawDayData => {
      const dayDataArray = Array.isArray(rawDayData) ? rawDayData : (rawDayData ? [rawDayData] : []);
      dayDataArray.forEach(content => {
        const count = (content.markets || []).length;
        switch (content.type) {
          case 'shortform': shortformCount += count; break;
          case 'ai-shortform': aiShortformCount += count; break;
          case 'ai-carousel': aiCount += count; break;
          case 'real-carousel': realCount += count; break;
          case 'longform': longformCount += count; break;
        }
        if (content.type !== 'no-post') totalPosts += count;
      });
    });

    document.getElementById('total-posts').textContent = String(totalPosts);
    document.getElementById('shortform-count').textContent = String(shortformCount);
    document.getElementById('ai-shortform-count').textContent = String(aiShortformCount);
    document.getElementById('ai-count').textContent = String(aiCount);
    document.getElementById('real-count').textContent = String(realCount);
    document.getElementById('longform-count').textContent = String(longformCount);
  }

  function computeShortformStats() {
    const stats = { total: 0, perMarket: {} };
    ['US','Korea','India','France','Japan','UK','Germany','Thailand'].forEach(m => { stats.perMarket[m] = 0; });

    for (const raw of Object.values(monthDataCache || {})) {
      const dayArr = Array.isArray(raw) ? raw : raw ? [raw] : [];
      dayArr.forEach(item => {
        if (!item || item.type !== 'shortform') return;
        const markets = dedupeMarketsCI((item.markets || []).map(toCanonicalMarket));
        if (markets.length === 0) {
          stats.total += 1;
        } else {
          markets.forEach(m => {
            stats.total += 1;
            if (stats.perMarket[m] != null) {
              stats.perMarket[m] += 1;
            }
          });
        }
      });
    }
    return stats;
  }

  function updateShortformPerMarketCounts() {
    const stats = computeShortformStats();
    const totalEl = document.getElementById('scheduled-shortform-total');
    if (totalEl) {
      totalEl.textContent = `${stats.total} post${stats.total === 1 ? '' : 's'}`;
    }

    const mapIds = {
      US: 'shortform-us-count',
      Korea: 'shortform-korea-count',
      India: 'shortform-india-count',
      France: 'shortform-france-count',
      Japan: 'shortform-japan-count',
      UK: 'shortform-uk-count',
      Germany: 'shortform-germany-count',
      Thailand: 'shortform-thailand-count'
    };

    Object.entries(mapIds).forEach(([market, id]) => {
      const el = document.getElementById(id);
      if (!el) return;
      const n = stats.perMarket[market] || 0;
      el.textContent = `${n}`;
    });
  }

  async function updateFolderCounts() {
    const month = currentDate.getMonth();
    if (month === 10) {
      document.getElementById('ready-count').textContent = '112 items';
      document.getElementById('posted-count').textContent = '0 items';
    } else {
      document.getElementById('ready-count').textContent = '0 items';
      document.getElementById('posted-count').textContent = '0 items';
    }

    const count = await getRealtimeVideoCount();
    updateAvailableVideoCountUI(count);
    updateShortformPerMarketCounts();
  }

  async function getRealtimeVideoCount() {
    console.log("Fetching real-time inventory from Storage...");
    const { data: videos, error } = await supabase
      .storage
      .from('ShortVideo')
      .list('', { limit: 2000 });

    if (error) {
      console.error('Error fetching storage list:', error);
      showNotification('❌ Error: Could not read Storage list (RLS?)', 'error');
      return 0;
    }

    const videoFiles = (videos || []).filter(file => {
      const name = file.name ? file.name.toLowerCase() : '';
      return name !== '.emptyfolderplaceholder';
    });

    console.log(`Real-time count is: ${videoFiles.length}`);
    return videoFiles.length;
  }

  function updateAvailableVideoCountUI(count) {
    const countEl = document.getElementById('available-video-count');
    if (!countEl) return;

    if (count === 'N/A' || count === undefined) {
      countEl.textContent = 'N/A';
      return;
    }

    countEl.textContent = `${count} items`;
    if (count < 5) {
      countEl.style.background = 'var(--secondary)';
    } else {
      countEl.style.background = 'var(--primary)';
    }
  }

  function getUsedFilenames(currentActivityId) {
    const used = new Set();
    
    Object.values(monthDataCache || {}).forEach(dayData => {
        const activities = Array.isArray(dayData) ? dayData : (dayData ? [dayData] : []);
        
        activities.forEach(act => {
           
            if (act.id === currentActivityId) return;

            if (act.fileName) {
                used.add(act.fileName);
            }

            if (act.carouselVideo) {
                used.add(act.carouselVideo);
            }
        });
    });
    
    return used;
  }

  async function openVideoPicker() {
    const modal = document.getElementById('video-picker-modal');
    const container = document.getElementById('video-list-container');
    const searchInput = document.getElementById('video-search');
    
    searchInput.value = ''; 
    modal.style.display = 'flex';
    container.innerHTML = '<div style="text-align:center; margin-top:20px;"><i class="fas fa-spinner fa-spin"></i> Loading Library...</div>';

    try {
      const type = document.getElementById('content-type').value;
      const currentActivityId = document.getElementById('edit-activity-id').value;
     
      let bucket = "ShortForm"; 
      if (type === 'ai-shortform') {
          bucket = "ShortVideo"; 
      }
   
      const res = await fetch(`${LIST_VIDEOS_WEBHOOK_URL}?bucket=${bucket}`);
      if (!res.ok) throw new Error(`API Error: ${res.status}`);
      
      const allFiles = await res.json();

      const usedFilenames = getUsedFilenames(currentActivityId);
      const availableFiles = allFiles.filter(file => !usedFilenames.has(file.name));

      renderVideoList(availableFiles);
      
      searchInput.onkeyup = (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = availableFiles.filter(f => f.name.toLowerCase().includes(term));
        renderVideoList(filtered);
      };

    } catch (err) {
      container.innerHTML = `<div style="color:red; text-align:center;">Error loading videos.<br>${err.message}</div>`;
      console.error(err);
    }
  }

  function renderVideoList(files) {
    const container = document.getElementById('video-list-container');
    container.innerHTML = '';

    if(!files || files.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">No videos found.</div>';
        return;
    }

    files.forEach(file => {
      if(file.name === '.emptyFolderPlaceholder') return;
   
      const sizeBytes = file.size || (file.metadata && file.metadata.size) || 0;
      const sizeMB = (sizeBytes / 1024 / 1024).toFixed(2);

      const div = document.createElement('div');
      div.style.cssText = "padding:12px; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:background 0.2s;";
      div.onmouseover = () => div.style.background = "#f8f9fa";
      div.onmouseout = () => div.style.background = "white";

      div.innerHTML = `
        <div style="pointer-events:none;">
            <i class="fas fa-file-video" style="color:#666; margin-right:10px;"></i>
            <strong>${file.name}</strong>
            <div style="font-size:0.8rem; color:#999; margin-left:26px; margin-top:2px;">Size: ${sizeMB} MB</div>
        </div>
        <button class="btn btn-secondary" style="padding:4px 12px; font-size:0.8rem; pointer-events:none;">Select</button>
      `;
   
      div.onclick = () => selectVideo(file.name);
      
      container.appendChild(div);
    });
  }

  function selectVideo(filename) {
    document.getElementById('selected-filename').value = filename;
    
    const previewBox = document.getElementById('preview-container');
    const player = document.getElementById('video-player-preview');
 
    const type = document.getElementById('content-type').value;
    const fullUrl = getFileUrl(filename, type);
    
    player.src = fullUrl;
    previewBox.style.display = 'block';
    
    document.getElementById('video-picker-modal').style.display = 'none';
  }

  // Add the missing functions for video picker
  document.getElementById('open-picker-btn').addEventListener('click', openVideoPicker);
  document.getElementById('close-picker').addEventListener('click', () => document.getElementById('video-picker-modal').style.display = 'none');
  document.getElementById('cancel-picker').addEventListener('click', () => document.getElementById('video-picker-modal').style.display = 'none');
  
  document.getElementById('clear-video-btn').addEventListener('click', () => {
    document.getElementById('selected-filename').value = '';
    document.getElementById('preview-container').style.display = 'none';
    document.getElementById('video-player-preview').src = '';
  });

  // Add the missing waitForAIImages function
  async function waitForAIImages(scheduleId, day, payloadId) {
    let attempts = 0;
    const maxAttempts = 90;
    const interval = 10000;

    console.log(`🔍 Start Polling. Looking for ID part: "${payloadId}"`);
    showNotification('AI processing... Waiting for images.', 'success');

    const poll = setInterval(async () => {
      attempts++;
      console.log(`Attempt ${attempts}: Reading storage...`);

      const { data: files, error } = await supabase
        .storage
        .from(BUCKET_CAROUSEL)
        .list('', { limit: 100, sortBy: { column: 'created_at', order: 'desc' } });
        console.log("📂 Files found in bucket:", files);

      if (error) { 
          console.error("❌ Polling Error (Check Storage Policies):", error); 
          return; 
      }

      const matchedFiles = files.filter(f => f.name.includes(payloadId));

      if (matchedFiles.length > 0) {
        clearInterval(poll);
        
        const imageFilenames = matchedFiles.map(f => f.name);
        console.log("✅ Found Match!", imageFilenames);

        const id = monthId(currentDate);
        const { data: sel } = await supabase.from('calendars').select('days').eq('id', id).maybeSingle();
        
        if (sel && sel.days) {
            const days = { ...sel.days };
            const currentDayArr = days[day] || [];
            const indexToUpdate = currentDayArr.findIndex(item => item.id === payloadId);

            if (indexToUpdate > -1) {
                currentDayArr[indexToUpdate] = {
                    ...currentDayArr[indexToUpdate],
                    aiGenerated: true,
                    images: imageFilenames 
                };
                days[day] = currentDayArr;

                await supabase.from('calendars').upsert({ id, days }, { onConflict: 'id' });
                
                monthDataCache = days;
               
                showNotification(`Success! AI generated ${matchedFiles.length} images.`);
              
            }
        }
      } 
      
      if (attempts >= maxAttempts) {
        clearInterval(poll);
        showNotification('Timeout: Images not found. Please check manually.', 'error');
      }

    }, interval);
  }

  // Add the missing switchView function
  window.switchView = function(view) {
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    
    if(view === 'calendar') {
      document.querySelector('.nav-tab:first-child').classList.add('active');
      document.getElementById('calendar-view').style.display = 'block';
      document.getElementById('analytics-view').style.display = 'none';
    } else {
      document.querySelector('.nav-tab:last-child').classList.add('active');
      document.getElementById('calendar-view').style.display = 'none';
      document.getElementById('analytics-view').style.display = 'block';
    }
  };
</script>
</body>

</html>
